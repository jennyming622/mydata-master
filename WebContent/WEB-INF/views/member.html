<!DOCTYPE html>
 <html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant-TW">
<!-- <head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:if="${_csrf}"
	th:content="${_csrf.headerName}" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">
<title>MyData | 會員專區</title>
<link rel="icon" type="image/png" sizes="16x16"
	href="image/smydatalogo.png"
	th:href="@{/resources/dist/image/smydatalogo.png}">
Bootstrap
<link href="css/bootstrap.css" rel="stylesheet"
	th:href="@{/resources/dist/css/bootstrap.css}">
<link href="css/style.css" rel="stylesheet" type="text/css"
	th:href="@{/resources/dist/css/style.css}">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
	th:href="@{/resources/plugins/font-awesome/css/font-awesome.min.css}">
<script th:src="@{/resources/dist/js/font-awesone.min.js}" ></script>
jQuery (necessary for Bootstrap's JavaScript plugins)
<script src="js/jquery-3.5.1.min.js"
	th:src="@{/resources/dist/js/jquery-3.5.1.min.js}"></script>
Include all compiled plugins (below), or include individual files as needed
<script src="js/popper.min.js"
	th:src="@{/resources/dist/js/popper.min.js}"></script>
<script src="js/bootstrap.js"
	th:src="@{/resources/dist/js/bootstrap.js}"></script>
<script src="js/scrollreveal.js" th:src="@{/resources/dist/js/scrollreveal.js}"></script>
<script src="jquery-barcode.js" th:src="@{/resources/dist/js/jquery-barcode.js}"></script>
<script src="js/certLogin.js" th:src="@{/resources/dist/js/certLogin.js}"></script>
<script src="js/errorcode.js" th:src="@{/resources/dist/js/errorcode.js}"></script>
<script src="js/qrcode.js" th:src="@{/resources/dist/js/qrcode.js}"></script>
twca js-->
<!-- <script th:src="@{/resources/dist/js/mydata.twca.ap.js}"></script>
<script th:src="@{/resources/dist/js/tcw.api.js}"></script>
<script th:src="@{/resources/dist/js/twcaCryptoLib.js}"></script>
</head> -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="_csrf" content="56c30374-c18f-49d7-8e7f-d1a4e93b4dc9">
    <meta name="_csrf_header" content="X-XSRF-TOKEN">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>MyData | 登入</title>
    <style type="text/css">svg:not(:root).svg-inline--fa{overflow:visible}.svg-inline--fa{display:inline-block;font-size:inherit;height:1em;overflow:visible;vertical-align:-.125em}.svg-inline--fa.fa-lg{vertical-align:-.225em}.svg-inline--fa.fa-w-1{width:.0625em}.svg-inline--fa.fa-w-2{width:.125em}.svg-inline--fa.fa-w-3{width:.1875em}.svg-inline--fa.fa-w-4{width:.25em}.svg-inline--fa.fa-w-5{width:.3125em}.svg-inline--fa.fa-w-6{width:.375em}.svg-inline--fa.fa-w-7{width:.4375em}.svg-inline--fa.fa-w-8{width:.5em}.svg-inline--fa.fa-w-9{width:.5625em}.svg-inline--fa.fa-w-10{width:.625em}.svg-inline--fa.fa-w-11{width:.6875em}.svg-inline--fa.fa-w-12{width:.75em}.svg-inline--fa.fa-w-13{width:.8125em}.svg-inline--fa.fa-w-14{width:.875em}.svg-inline--fa.fa-w-15{width:.9375em}.svg-inline--fa.fa-w-16{width:1em}.svg-inline--fa.fa-w-17{width:1.0625em}.svg-inline--fa.fa-w-18{width:1.125em}.svg-inline--fa.fa-w-19{width:1.1875em}.svg-inline--fa.fa-w-20{width:1.25em}.svg-inline--fa.fa-pull-left{margin-right:.3em;width:auto}.svg-inline--fa.fa-pull-right{margin-left:.3em;width:auto}.svg-inline--fa.fa-border{height:1.5em}.svg-inline--fa.fa-li{width:2em}.svg-inline--fa.fa-fw{width:1.25em}.fa-layers svg.svg-inline--fa{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.fa-layers{display:inline-block;height:1em;position:relative;text-align:center;vertical-align:-.125em;width:1em}.fa-layers svg.svg-inline--fa{-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter,.fa-layers-text{display:inline-block;position:absolute;text-align:center}.fa-layers-text{left:50%;top:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter{background-color:#ff253a;border-radius:1em;-webkit-box-sizing:border-box;box-sizing:border-box;color:#fff;height:1.5em;line-height:1;max-width:5em;min-width:1.5em;overflow:hidden;padding:.25em;right:0;text-overflow:ellipsis;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-bottom-right{bottom:0;right:0;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom right;transform-origin:bottom right}.fa-layers-bottom-left{bottom:0;left:0;right:auto;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom left;transform-origin:bottom left}.fa-layers-top-right{right:0;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-top-left{left:0;right:auto;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top left;transform-origin:top left}.fa-lg{font-size:1.3333333333em;line-height:.75em;vertical-align:-.0667em}.fa-xs{font-size:.75em}.fa-sm{font-size:.875em}.fa-1x{font-size:1em}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-6x{font-size:6em}.fa-7x{font-size:7em}.fa-8x{font-size:8em}.fa-9x{font-size:9em}.fa-10x{font-size:10em}.fa-fw{text-align:center;width:1.25em}.fa-ul{list-style-type:none;margin-left:2.5em;padding-left:0}.fa-ul>li{position:relative}.fa-li{left:-2em;position:absolute;text-align:center;width:2em;line-height:inherit}.fa-border{border:solid .08em #eee;border-radius:.1em;padding:.2em .25em .15em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left,.fab.fa-pull-left,.fal.fa-pull-left,.far.fa-pull-left,.fas.fa-pull-left{margin-right:.3em}.fa.fa-pull-right,.fab.fa-pull-right,.fal.fa-pull-right,.far.fa-pull-right,.fas.fa-pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.fa-rotate-90{-webkit-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-webkit-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-webkit-transform:scale(-1,1);transform:scale(-1,1)}.fa-flip-vertical{-webkit-transform:scale(1,-1);transform:scale(1,-1)}.fa-flip-both,.fa-flip-horizontal.fa-flip-vertical{-webkit-transform:scale(-1,-1);transform:scale(-1,-1)}:root .fa-flip-both,:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-rotate-90{-webkit-filter:none;filter:none}.fa-stack{display:inline-block;height:2em;position:relative;width:2.5em}.fa-stack-1x,.fa-stack-2x{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.svg-inline--fa.fa-stack-1x{height:1em;width:1.25em}.svg-inline--fa.fa-stack-2x{height:2em;width:2.5em}.fa-inverse{color:#fff}.sr-only{border:0;clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.sr-only-focusable:active,.sr-only-focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}.svg-inline--fa .fa-primary{fill:var(--fa-primary-color,currentColor);opacity:1;opacity:var(--fa-primary-opacity,1)}.svg-inline--fa .fa-secondary{fill:var(--fa-secondary-color,currentColor);opacity:.4;opacity:var(--fa-secondary-opacity,.4)}.svg-inline--fa.fa-swap-opacity .fa-primary{opacity:.4;opacity:var(--fa-secondary-opacity,.4)}.svg-inline--fa.fa-swap-opacity .fa-secondary{opacity:1;opacity:var(--fa-primary-opacity,1)}.svg-inline--fa mask .fa-primary,.svg-inline--fa mask .fa-secondary{fill:#000}.fad.fa-inverse{color:#fff}</style><link rel="icon" type="image/png" sizes="16x16" href="/resources/dist/image/smydatalogo.png">
    <!-- Bootstrap -->
    <link href="/resources/dist/css/bootstrap.css" rel="stylesheet">
    <link href="/resources/dist/css/style.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/resources/plugins/font-awesome/css/font-awesome.min.css">
    <script src="/resources/dist/js/font-awesone.min.js"></script>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="/resources/dist/js/jquery-3.5.1.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/resources/dist/js/popper.min.js"></script>
    <script src="/resources/dist/js/bootstrap.js"></script>
    <script src="/resources/dist/js/scrollreveal.js"></script>
    <script src="/resources/dist/js/certLogin.js"></script>
    <script src="/resources/dist/js/errorcode.js"></script>
    <script src="/resources/dist/js/qrcode.js"></script>
    <!-- twca js-->
    <script src="/resources/dist/js/mydata.twca.ap.js"></script>
    <script src="/resources/dist/js/tcw.api.js"></script>
    <script src="/resources/dist/js/twcaCryptoLib.js"></script>
    <!-- <script src="https://www.google.com/recaptcha/api.js" async defer></script> -->
<style>
    .modal {
        position: relative;
        -webkit-transform: none;
    }

    /*取消input type 為number的arrow*/
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
        -webkit-appearance: none;
    }

    input[type="number"] {
        -moz-appearance: textfield;
    }

    .grecaptcha-badge{
        visibility: hidden;
    }
</style><style type="text/css"></style><style type="text/css"></style></head>
<body th:classappend="${session.SignedInUser!=null&&session.SignedInUser.maskMember!=null&&session.SignedInUser.maskMember.name!=null}?'after-login':''">
	<!--======= header =======-->
	<header th:replace="fragment/header::header"></header>
	<!--======= header =======-->

	<nav aria-label="breadcrumb">
		<ol class="breadcrumb">
			<a href="#main_area" id="main_area" title="主要內容區塊"
				class="show-lg-only aa-index">:::</a>
			<li class="breadcrumb-item">
				<a href="#" th:href="@{/}" title="回到MyData首頁"> 
					<img src="images/breadcrumb-home.png" th:src="@{/resources/dist/image/breadcrumb-home.png}" alt="">首頁
				</a>
			</li>
			<li class="breadcrumb-item active" aria-current="page">會員專區</li>
		</ol>
	</nav>

	<div class="landing-page my-area"
		 th:object="${session.SignedInUser}">
		<section class="barcode-wrap text-center section-wrap pb-3">
			<h2 class="title-wrap">會員專區</h2>
			<div class="content-wrap text-center p-0">
				<div id="exTab2">
					<ul class="nav nav-tabs nav-fill mb-3">
						<li><a class="nav-item" href="#1" data-toggle="tab" th:classappend="${boxid}?'':'active'">基本資料</a>
						</li>
						<li><a class="nav-item" href="#2" data-toggle="tab">使用紀錄</a>
						</li>
						<li><a class="nav-item" href="#3" data-toggle="tab" th:classappend="${boxid}?'active':''">資料條碼</a>
						</li>
					</ul>
					<div class="tab-content">
						<div class="tab-pane" id="1" th:classappend="${boxid}?'':'active'">
							<div class="form-group mt-3 mb-0 flex-center w-50 mobile-w-90" th:if="${member.preLoginTime != null}"
								style="justify-content: flex-end !important;">
								<p th:text="${#dates.format(member.preLoginTime, '上次登入時間：yyyy年MM月dd日HH時mm分')}"></p>
							</div>
							<div class="form-group mt-3 mb-0 flex-center w-50 mobile-w-90">
								<label for="name" class="word-2">姓 名：</label>
								<input id="uuidcheckforCheckCode" type="hidden">
								<input type="text" class="form-control input-padding" id="name"
									   th:value="*{maskMember.name == null ? '' : maskMember.name}"
									   th:data-value="${member.name}" placeholder="請輸入您的姓名"
									   onfocus="inputFocusinEvent(this)"
									   onblur="inputFocusoutEvent(this, MaskType.name)"
									   autocomplete="off">
								<i onclick="maskorUnMask_v2(this)" id="eye_name" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i>
							</div>
							<div class="form-group mt-3 mb-0 flex-center w-50 mobile-w-90">
								<th:block th:if="${session.SignedInUser.roleType!='0.5'}">
									<label for="uid">身分證字號：</label>
									<input type="text" class="form-control input-padding" id="uid"
										   th:value="*{member.uid == null ?'': maskMember.uid}"
										   th:data-value="${member.uid==null?'':member.uid}" placeholder="請輸入您的身分證字號" maxLength="10" disabled
										   autocomplete="off">
										<i onclick="maskOrUnmask(this)" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i>
								</th:block>
								<th:block th:if="${session.SignedInUser.roleType=='0.5'}">
									<label for="uid" class="word-4">統一編號：</label>
									<input type="text" class="form-control input-padding" id="uid"
										   th:value="*{member.uid == null ?'': maskMember.uid}"
										   th:data-value="${member.uid==null?'':member.uid}" placeholder="請輸入您的統一編號" maxLength="8" disabled
										   autocomplete="off">
									<!-- <i onclick="maskOrUnmask(this)" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i> -->
								</th:block>
							</div>
							<th:block th:if="${session.SignedInUser.roleType!='0.5'}">
							<div class="form-group mt-3 mb-0 flex-center w-50 mobile-w-90">
								<label for="birthdate" class="word-2">生 日：</label>
								<input type="text" class="form-control input-padding" id="birthdate"
									   th:value="*{maskMember.birthdateForRE==null?'':maskMember.birthdateForRE}"
									   th:data-value="${member.birthdateForRE==null?'':member.birthdateForRE}" placeholder="請輸入您的生日" maxLength="7" disabled
									   autocomplete="off">
								<i onclick="maskOrUnmask(this)" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i>
							</div>
							</th:block>
							<div class="form-group mt-3 mb-0 flex-center w-50 mobile-w-90" >
								<label for="mobile" class="word-4">手 機 號 碼：</label>
<!--								<input type="text" class="form-control" id="mobile" th:value="${member.mobile}" placeholder="請輸入您的手機號碼">-->
								<input type="text" class="form-control input-padding" id="mobile"
									   th:value="*{member.mobile==null?'':maskMember.mobile}"
									   th:data-value="${member.mobile==null?'':member.mobile}" placeholder="請輸入您的手機號碼"
									   maxLength="10" disabled="disabled">
								<i onclick="maskOrUnmask(this)" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i>
							</div>
							<div class="flex-between verify-tag-wrap w-50 mobile-w-90"
								 th:classappend="*{member.mobileVerified==true} ? 'pass' : ''" >
								<div id="mobileverify" class="verify-tag"
									 th:text="${member.mobileVerified==null||member.mobileVerified==false ? '未驗證' : '已驗證'}"
								style="display:none;">已驗證</div>
								<div></div>
								<a class="link"
								   id="mobilelink"
								   href="javascript:checkOpenVerifyMobile();"
								   th:text="*{member.mobile==null ? '新增手機號碼' : '變更手機號碼'}">變更手機號碼</a>
							</div>
							
							<div class="form-group mt-3 mb-0 flex-center w-50 mobile-w-90" >
								<label for="email" class="word-4">電 子 信 箱：</label>
								<input type="email" class="form-control input-padding" id="email"
									   th:value="*{member.email==null?'':maskMember.email}"
									   th:data-value="${member.email==null ?'':member.email}"
									   placeholder="請輸入您的電子信箱" disabled="disabled">
								<i onclick="maskOrUnmask(this)" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i>
							</div>
							<div class="flex-between verify-tag-wrap w-50 mobile-w-90"
								 th:classappend="*{member.emailVerified!= null && member.emailVerified ==true} ? 'pass' : ''" >
								<div id="emailverify" class="verify-tag"
									 th:text="*{member.emailVerified==null||member.emailVerified==false ? '未驗證' : '已驗證'}"
								style="display:none;">已驗證</div>
								<div></div>
								<a class="link"
									id="emaillink"
								   href="javascript:checkOpenVerifyEmail();"
								   th:text="*{member.email==null ? '新增電子信箱' : '變更電子信箱'}">變更電子信箱</a>
							</div>
							
							<div class="form-group mt-3 mb-0 flex-start w-50 multifactor radio notify mobile-w-90 mobile-radio">
								<p class="contact-way mb-0">主要聯絡方式：</p>
								<!-- 在 <label> 加上 .active 即表示該選項有被圈選 -->
								<label id="mobilelabel" class="flex-middle mt-1 mb-0"
									   th:classappend="${member.informMethod != null && member.informMethod ==  'mobile'} ? 'active' : '' "
									   for="mobileradio">
									<input id="mobileradio" type="radio" name="emailradio" value="mobile"
										   th:checked="${member.informMethod != null && member.informMethod ==  'mobile'}"
										   onclick="javascript:changeemailradio();" autocomplete="off">
									<span class="mr-2 ml-1">手機號碼</span>
								</label>
								<label  id="emaillabel" class="flex-middle mt-1 mb-0"
										th:classappend="${member.informMethod != null && member.informMethod == 'email'} ? 'active' : '' "

										for="emailradio">
									<input id="emailradio" type="radio" name="emailradio" value="email"
										   th:checked="${member.informMethod != null && member.informMethod == 'email'}"
										   onclick="javascript:changeemailradio();" autocomplete="off">
									<span class="mr-2 ml-1">電子信箱</span>
								</label>
							</div>
							<div class="text-center mt-3">
 								<button class="btn theme-btn" onclick="updateUserInfo()">儲存</button>
 							</div>
						</div>
						<div class="tab-pane" id="2">
							<div class="content-wrap record-wrap" th:if="${not #lists.isEmpty(prExtList)}">
								<h3>個人資料<hr></h3>
								<!-- Collaspe -->
								<div id="collaspe-wrapper" th:id="'collaspe-wrapper'+${pr.prId}" th:each="pr : ${prExtList}" th:if="${not #lists.isEmpty(prExtList)}">
									<div class="card shadow-sm ">
										<div class="card-header collapsed paCard-header" data-toggle="collapse" href="#list1" th:href="'#list'+${pr.prId}" th:title="${pr.name}+'(Enter展開)'" onclick="javascript:toggleParentClass(this);" th:data-id="${pr.prId}" tabindex="0">
											<a class="card-link">
												<!-- 參考 css 的 /* icon 檢索 */ -->
												<!-- 戶役政 -->
												<th:block th:if="${pr.cateId}==1">
													<img class="dep-icon" src="./images/household-o.png" th:src="@{/resources/dist/image/household-o.png}" alt="">
													<h4 class="household">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 地政 -->
												<th:block th:if="${pr.cateId}==2">
													<img class="dep-icon" src="./images/land-o.png" th:src="@{/resources/dist/image/land-o.png}" alt="">
													<h4 class="land">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 財稅金融 -->
												<th:block th:if="${pr.cateId}==3">
													<img class="dep-icon" src="./images/fiscal-tax-o.png" th:src="@{/resources/dist/image/fiscal-tax-o.png}" alt="">
													<h4 class="fiscal-tax">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 商工 -->
												<th:block th:if="${pr.cateId}==4">
													<img class="dep-icon" src="./images/business-o.png" th:src="@{/resources/dist/image/business-o.png}" alt="">
													<h4 class="business">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 交通 -->
												<th:block th:if="${pr.cateId}==5">
													<img class="dep-icon" src="./images/highway-o.png" th:src="@{/resources/dist/image/highway-o.png}" alt="">
													<h4 class="highway">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 勞保 -->
												<th:block th:if="${pr.cateId}==6">
													<img class="dep-icon" src="./images/labor-o.png" th:src="@{/resources/dist/image/labor-o.png}" alt="">
													<h4 class="labor">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 健保 -->
												<th:block th:if="${pr.cateId}==7">
													<img class="dep-icon" src="./images/health-insurance-o.png" th:src="@{/resources/dist/image/health-insurance-o.png}" alt="">
													<h4 class="health-insurance">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 醫療 -->
												<th:block th:if="${pr.cateId}==8">
													<img class="dep-icon" src="./images/medical-o.png" th:src="@{/resources/dist/image/medical-o.png}" alt="">
													<h4 class="medical">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 能源 -->
												<th:block th:if="${pr.cateId}==9">
													<img class="dep-icon" src="./images/energy.png" th:src="@{/resources/dist/image/energy.png}" alt="">
													<h4 class="financial">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 教育 -->
												<th:block th:if="${pr.cateId}==10">
													<img class="dep-icon" src="./images/education-o.png" th:src="@{/resources/dist/image/education-o.png}" alt="">
													<h4 class="education">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 法務 -->
												<th:block th:if="${pr.cateId}==11">
													<img class="dep-icon" src="./images/legal-o.png" th:src="@{/resources/dist/image/legal-o.png}" alt="">
													<h4 class="legal">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 社福 -->
												<th:block th:if="${pr.cateId}==12">
													<img class="dep-icon" src="./images/welfare-o.png" th:src="@{/resources/dist/image/welfare-o.png}" alt="">
													<h4 class="military-service">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<!-- 綜合 -->
												<th:block th:if="${pr.cateId}==13">
													<img class="dep-icon" src="./images/composite-service.png" th:src="@{/resources/dist/image/composite-service.png}" alt="">
													<h4 class="others">
														<span th:text="${pr.name}">個人戶籍資料查詢</span><span class="ml-2 mr-2 hidden-lg">-</span><span class="pull-right" th:text="'資料提供單位：'+${pr.providerName}">資料提供單位：內政部戶政司</span>
													</h4>
												</th:block>
												<i class="fa fa-chevron-down pull-right"></i>
											</a>
										</div>
										<div id="list1" th:id="'list'+${pr.prId}" th:data-parent="'#collaspe-wrapper'+${pr.prId}" class="collapse">
											<div class="card-body">
												<table id="table" th:id="'table'+${pr.prId}" class="table text-center rwd-table">
													<thead>
													<tr>
														<th scope="col">次序</th>
														<th scope="col">時間</th>
														<th scope="col">類別</th>
														<th scope="col">說明</th>
													</tr>
													</thead>
													<!-- 預設 <tbody> 旁有 Class " collapsed "，如點擊開啟表格則刪除 " collapsed " -->
													<tbody class="collapsed">
													<th:block th:each="ulog,iter : ${pr.ulogList}">
														<tr data-toggle="collapse" data-target="#table-accordion-1" th:data-target="'#table-accordion-'+${pr.prId}+'-'+${iter.index+1}" class="pointer card-header collapsed" onclick="javascript:toggleParent1Class(this);">
															<td scope="row"><span class="show-md-only">次序：</span><span th:text="${iter.index+1}">1</span>.</td>
															<td><span class="show-md-only">時間：</span><span th:text="${ulog.ctimeStr}+'-'+${ulog.ctimeStr1}">2019年03月22日-14時22分22秒</span></td>
															<td><span class="show-md-only">類別：</span><span th:text="${ulog.actionStr}">申請</span></td>
															<td><span class="show-md-only">說明：</span>
																<th:block th:if="${ulog.auditEvent==11}">
																	<span>您已同意申請此項服務，並完成身分驗證作業</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==12}">
																	<span>您同意服務條款</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==13}">
																	<span>您完成身分驗證</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==14}">
																	<span>您同意 MyData 傳送資料給服務提供者</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==15}">
																	<span>您已轉存資料至電腦或手機</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==16}">
																	<span>您完成提供資料給臨櫃核驗機關</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==17}">
																	<span>您完成提供資料給「<span th:text="${ulog.providerName}+' - '+${ulog.serviceName}"></span>」</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==18}">
																	<span>您已完成此項資料下載</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==19 || ulog.auditEvent==20}">
																	<span>您申請此服務失敗</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==28 || ulog.auditEvent==29}">
																	<span>您點選「不同意傳送」或服務申請未完成</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==31}">
																	<span>您已預覽此項資料</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==32}">
																	<span>「臨櫃人員」使用「預覽」</span>
																</th:block>
																<!-- 委託人 -->
																<th:block th:if="${ulog.auditEvent==41}">
																	<span>您選擇此項臨櫃服務委託代辦</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==42}">
																	<span>您同意委託代辦項目</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==43}">
																	<span>已提供驗證碼給代辦人</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==44}">
																	<span>您輸入的訊息，非 MyData 會員</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==45}">
																	<span>您終止此項委託代辦項目</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==46}">
																	<span>已超過資料可取用時間</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==47}">
																	<span>代辦人已至臨櫃提供資料給「<span th:text="${ulog.providerName}+' - '+${ulog.serviceName}"></span>」申辦完畢</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==48}">
																	<span>代辦人終止此項委託代辦項目</span>
																</th:block>
																<!-- 代辦人 -->
																<th:block th:if="${ulog.auditEvent==51}">
																	<span>您同意此項臨櫃服務代辦</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==52}">
																	<span>委託人已取消此代辦申請</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==53}">
																	<span>已超過資料可取用時間</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==54}">
																	<span>您完成提供資料給臨櫃核驗機關</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==55}">
																	<span>您完成提供資料給「<span th:text="${ulog.providerName}+' - '+${ulog.serviceName}"></span>」</span>
																</th:block>
																<th:block th:if="${ulog.auditEvent==56}">
																	<span>您終止此項委託代辦項目</span>
																</th:block>
																<i class="fa fa-chevron-down pull-right"></i>
															</td>
														</tr>
														<tr>
															<td class="table-loca p-3" colspan="4">
																<div id="table-accordion-1" th:id="'table-accordion-'+${pr.prId}+'-'+${iter.index+1}" class="table-collaspe-wrap collapse">
																	<table>
																		<tbody>
																		<tr th:each="ulog1 : ${ulog.ulogApiExtList}">
																			<th></th>
																			<td><span class="show-md-only">時間：</span><span th:text="${ulog1.ctimeStr}+'-'+${ulog1.ctimeStr1}">2019年03月22日-14時22分22秒</span></td>
																			<td><span class="show-md-only">類別：</span><span th:text="${ulog1.actionStr}">申請</span></td>
																			<td>
																				<span class="show-md-only">說明：</span>
																				<th:block th:if="${ulog1.auditEvent==11}">
																					<span>您已同意申請此項服務，並完成身分驗證作業</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==12}">
																					<span>您同意服務條款</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==13}">
																					<span>您完成身分驗證</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==14}">
																					<span>您同意 MyData 傳送資料給服務提供者</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==15}">
																					<span>您已轉存資料至電腦或手機</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==16}">
																					<span>您完成提供資料給臨櫃核驗機關</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==17}">
																					<span>您完成提供資料給「<span th:text="${ulog1.providerName}+' - '+${ulog1.serviceName}"></span>」</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==18}">
																					<span>您已完成此項資料下載</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==19 || ulog1.auditEvent==20}">
																					<span>您申請此服務失敗</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==28 || ulog1.auditEvent==29}">
																					<span>您點選「不同意傳送」或服務申請未完成</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==31}">
																					<span>您已預覽此項資料</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==32}">
																					<span>「臨櫃人員」使用「預覽」</span>
																				</th:block>
																				<!-- 委託人 -->
																				<th:block th:if="${ulog1.auditEvent==41}">
																					<span>您選擇此項臨櫃服務委託代辦</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==42}">
																					<span>您同意委託代辦項目</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==43}">
																					<span>已提供驗證碼給代辦人</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==44}">
																					<span>您輸入的訊息，非 MyData 會員</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==45}">
																					<span>您終止此項委託代辦項目</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==46}">
																					<span>已超過資料可取用時間</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==47}">
																					<span>代辦人已至臨櫃提供資料給「<span th:text="${ulog1.providerName}+' - '+${ulog1.serviceName}"></span>」申辦完畢</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==48}">
																					<span>代辦人終止此項委託代辦項目</span>
																				</th:block>
																				<!-- 代辦人 -->
																				<th:block th:if="${ulog1.auditEvent==51}">
																					<span>您同意此項臨櫃服務代辦</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==52}">
																					<span>委託人已取消此代辦申請</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==53}">
																					<span>已超過資料可取用時間</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==54}">
																					<span>您完成提供資料給臨櫃核驗機關</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==55}">
																					<span>您完成提供資料給「<span th:text="${ulog1.providerName}+' - '+${ulog1.serviceName}"></span>」</span>
																				</th:block>
																				<th:block th:if="${ulog1.auditEvent==56}">
																					<span>您終止此項委託代辦項目</span>
																				</th:block>
																			</td>
																		</tr>
																		</tbody>
																	</table>
																</div>
															</td>
														</tr>
													</th:block>
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<!-- tab2 end-->
						<!-- tab3 start-->
						<div class="tab-pane content-wrap" id="3" th:classappend="${boxid}?'active':''">
						    <h3 th:if="${not #lists.isEmpty(portalBoxExtList)}">
						        個人資料
						        <hr>
						    </h3>
						    <!-- expired -->
						    <div class="card shadow-sm barcode-wrap" onclick="javascript:toggleClass(this);" th:id="'box'+${box.id}"
						         th:each="box : ${portalBoxExtList}" th:if="${not #lists.isEmpty(portalBoxExtList)}"
						         th:classappend="${box.stat==1} ? 'expired' : ''">
						        <div class="card-header collapsed" data-toggle="collapse" href="#list1" th:href="'#list'+${box.id}"
						             aria-expanded="false">
						            <a class="card-link">
						                <th:block th:if="${box.cateId==1}">
						                    <h4 class="icon household flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==2}">
						                    <h4 class="icon land flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==3}">
						                    <h4 class="icon fiscal-tax flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==4}">
						                    <h4 class="icon business flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==5}">
						                    <h4 class="icon highway flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==6}">
						                    <h4 class="icon labor flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==7}">
						                    <h4 class="icon health-insurance flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==8}">
						                    <h4 class="icon medical flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==9}">
						                    <h4 class="icon financial flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==10}">
						                    <h4 class="icon education flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==11}">
						                    <h4 class="icon legal flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==12}">
						                    <h4 class="icon welfare flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="${box.cateId==13}">
						                    <h4 class="icon others flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <th:block th:if="!${box.cateId}">
						                    <h4 class="icon household flex-between" th:if="${box.prName}">
						                        <th:block th:text="${box.prName}">個人戶籍資料查詢</th:block>
						                        <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> -->
						                    </h4>
						                </th:block>
						                <h4 class="i-mul-data flex-between" th:if="!${box.prName}">多筆資料集下載
						                    <!-- <span th:text="${#dates.format(box.ctime, '申請時間：yyyy年MM月dd日-hh時mm分ss')}">申請時間：2019年02月26日-16時24分12秒</span> --></h4>
						                <i class="fa fa-chevron-down pull-right"></i>
						            </a>
						        </div>
						        <div id="list1" th:id="'list'+${box.id}" th:data-parent="'#box'+${box.id}" class="collapse" style="">
						            <div class="card-body">
						                <div style="display:none;" th:id="'box-data'+${box.id}">
						                    <h5 class="mb-2 get-data" th:id="'get-data'+${box.id}">取用資料
						                        <th:block th:if="${box.batchTime !=null and box.batchTime>0}">（預計下載時間：
						                            <th:block th:text="${box.batchTime}"></th:block>
						                            分鐘）
						                        </th:block>
						                    </h5>
						                    <div class="flex-between" th:id="'flex-between'+${box.id}">
						                        <div class="theme-btn false" inline>下載中</div>
						                        <div class="progress">
						                            <div class="progress-bar progress-bar-striped progress-bar-animated"
						                                 role="progressbar" aria-valuenow="0" aria-valuemin="0"
						                                 aria-valuemax="100" style="width: 0%"></div>
						                        </div>
						                        <span th:id="'percent'+${box.id}">0%</span>
						                    </div>
						                </div>
						                <div class="barcode-description" th:id="'barcode-description'+${box.id}">
						                    <p class="alert alert-box"><img th:src="@{/resources/dist/image/ps-icon.svg}" alt="注意事項：" style="width: 15px; margin-right: 3px">此資料有效期為下載資料後 8 小時，超過 8 小時，此資料將會刪除。</p>
						                    <p class="alert alert-box"><img th:src="@{/resources/dist/image/ps-icon.svg}" alt="注意事項：" style="width: 15px; margin-right: 3px">為提高資料安全性，此條碼有效時間尚餘 <span class="waitTime" th:data-time="${box.dataTime}"
						                                                                 th:start-time="${box.startTime}"
						                                                                 th:full-wait-time="${box.waitTime}"
						                                                                 th:data-id="${box.id}"
											                                             th:data-code="${box.code}"
																						 th:prId="${box.prId}"
																						 data-type="dp"></span>
						                        ，過期後請點產生新條碼。</p>
						                </div>
						                <div class="row barcode-box" th:id="'barcode-box'+${box.id}">
						                    <div class="expired-mask">
						                        <div class="expired-text">
						                            <span>您的條碼已過期，請點此</span>
						                            <button class="theme-btn flex-middle barcode"
						                                    onclick="javascript:createRandomVerifyExpired(this);" th:stat="${box.stat}"
						                                    th:download-verify="${box.downloadVerify}">
						                                <p class="img">產生新條碼</p>
						                            </button>
						                        </div>
						                    </div>
						                    <div class="col-lg-4 show-lg-only"></div>
						                    <div class="col-lg-4 col-md-12 p-0">
						                        <div class="custom-barcode-area barcodeverify" th:stat="${box.stat}"
						                             th:download-verify="${box.downloadVerify}"></div>
						                        <!-- <img src="./images/barcode-list.png" th:src="@{/resources/dist/image/barcode-list.png}" class="barcode-img" alt="條碼編號："> -->
						                    </div>
						                    <div class="col-lg-4 col-md-12 flex-bottom">
						                        <button class="theme-btn-border flex-middle barcode" th:id="'barcode-btn'+${box.id}"
						                                onclick="javascript:createRandomVerify(this);" th:stat="${box.stat}"
						                                th:download-verify="${box.downloadVerify}">
						                            <p class="img">手動更新條碼</p>
						                        </button>
						                    </div>
						                </div>
						                <!-- Button trigger modal -->
						                <ul class="card-footer w-100 bg-white p-0 mb-0" th:id="'card-footer'+${box.id}">
						                    <li class="single-data-wrap">
						                        <p class="mb-0 text-left">
						                            你可選擇下列方式使用已下載的資料檔案：<span class="alert">開啟檔案的密碼是身分證字號（英文為大寫）</span>
						                        </p>
						                        <div class="btn-download-group text-center mt-4">
						                            <button class="btn btna theme-btn-border mr-2" onclick="javascript:previewToCompany(this);"
						                                    th:box-id="${box.id}" th:data-src="@{/personal/box/prview}+'/'+${box.id}"
						                                    th:data-id="${box.prId}"
						                                    th:httpcode="${box.code}">線上預覽檔案</button>
						                            <button class="btn btna theme-btn hidden-mobile" onclick="javascript:downloadToCompanyWarning(this);"
						                                    th:box-id="${box.id}" th:data-src="@{/personal/box/download}+'/'+${box.id}"
						                                    th:data-id="${box.prId}" th:httpcode="${box.code}">轉存到我的電腦</button>
						                            <button class="btn btna theme-btn mr-3 hidden-desktop" onclick="javascript:downloadToCompanyWarning(this);"
						                                    th:box-id="${box.id}" th:data-src="@{/personal/box/download}+'/'+${box.id}"
						                                    th:data-id="${box.prId}" th:httpcode="${box.code}">轉存到我的手機</button>
						                        </div>
						                    </li>
						                </ul>
										<div th:id="'show204_'+${box.id}" style="display: none;">
											<div class="get-file-wrap mt-4">
												<p class="mb-4 text-center">
													<span class="alert">個人資料查詢完成：</span>您申請的「<span th:text="${box.prName}"></span>」查無相關（證明）資料
												</p>
											</div>
											<div class="btn-download-group text-center mt-4">
												<button class="btn btna theme-btn hidden-mobile" onclick="javascript:downloadToCompanyWarning(this);"
														th:box-id="${box.id}" th:data-src="@{/personal/box/download}+'/'+${box.id}"
														th:data-id="${box.prId}" httpcode="204">轉存到我的電腦</button>
											</div>
										</div>
						            </div>
						        </div>
						    </div>
						    <h3 class="mt-4" th:if="${not #lists.isEmpty(portalBoxExtList1)}">
						        臨櫃服務
						        <hr>
						    </h3>
						    <!-- expired -->
						    <div class="card shadow-sm barcode-wrap" onclick="javascript:toggleClass(this);" th:id="'box'+${box.id}"
						         th:each="box : ${portalBoxExtList1}" th:if="${not #lists.isEmpty(portalBoxExtList1)}"
						         th:classappend="${box.stat==1} ? 'expired' : ''">
						        <div class="card-header collapsed" data-toggle="collapse" href="#list1" th:href="'#list'+${box.id}"
						             aria-expanded="false">
						            <a class="card-link">
						                <h4 class="flex-between" th:text="${box.providerName} + ' - ' + ${box.psName}+${#dates.format(box.applyTime, '（yyyy/MM/dd HH:mm:ss）')}">單位名稱 - 服務名稱（yyyy/MM/dd hh:mm:ss)</h4>
						                <i class="fa fa-chevron-down pull-right"></i>
						            </a>
						        </div>
						        <div id="list1" th:id="'list'+${box.id}" class="collapse" th:data-parent="'#box'+${box.id}" style="">
						            <div class="card-body">
						                <div style="display:none;" th:id="'box-data'+${box.id}">
											<p class="mt-0 p-3 bg-gray alert-box">
								            		<img src="./images/ps-icon.svg" th:src="@{/resources/dist/image/ps-icon.svg}" alt="注意事項：" style="width: 15px; margin-right: 3px">
								            		資料下載中，尚無法產製條碼。
								            </p>
						                </div>
						                <div class="barcode-description" th:id="'barcode-description'+${box.id}">
						                    <p class="alert alert-box not-agent" th:style="${box.agentName!=null and box.agreeAgent == null}?'display:none':'display:block'"><img th:src="@{/resources/dist/image/ps-icon.svg}" alt="注意事項：" style="width: 15px; margin-right: 3px">此資料有效期為下載資料後 8 小時，超過 8 小時，此資料將會刪除。</p>
						                    <p class="alert alert-box not-agent" th:style="${box.agentName!=null and box.agreeAgent == null}?'display:none':'display:block'"><img th:src="@{/resources/dist/image/ps-icon.svg}" alt="注意事項：" style="width: 15px; margin-right: 3px">為提高資料安全性，此條碼有效時間尚餘 <span class="waitTime" th:data-time="${box.dataTime}"
						                                                                 th:start-time="${box.startTime}"
						                                                                 th:full-wait-time="${box.waitTime}"
						                                                                 th:data-id="${box.id}"
											                                             th:data-code="429"
																						 th:prId="${box.prId}"
																						 data-type="sp"></span>
						                        ，過期後請點產生新條碼。</p>
						                    <p th:id="'in-agent'+${box.id}" class="alert alert-box in-agent" th:style="${box.agentName!=null and box.agreeAgent == null}?'display:block':'display:none'"><img th:src="@{/resources/dist/image/ps-icon.svg}" alt="注意事項：" style="width: 15px; margin-right: 3px"><span th:id="'in-agent-text'+${box.id}" th:text="${box.agentName!=null}?('此臨櫃服務目前已委託給指定代辦'+${box.agentName}+'申辦中。'):'此臨櫃服務目前已委託給指定代辦人XXX申辦中。'">此臨櫃服務目前已委託給指定代辦人XXX申辦中。</span><button class="btn btn-primary" th:data-id="${box.id}" onclick="javascript:cancelAgentPopWin(this);">&nbsp;終止委託&nbsp;</button></p>
						                </div>
						                <div class="row barcode-box" th:id="'barcode-box'+${box.id}" th:data-agent="${box.agentName!=null and box.agreeAgent == null}?'true':'false'" th:style="${box.agentName!=null}?'display:none':''">
						                    <div class="expired-mask">
						                        <div class="expired-text">
						                            <span>您的條碼已過期，請點此</span>
						                            <button class="theme-btn flex-middle barcode"
						                                    onclick="javascript:createRandomVerifyExpired(this);" th:stat="${box.stat}"
						                                    th:download-verify="${box.downloadVerify}">
						                                <p class="img">產生新條碼</p>
						                            </button>
						                        </div>
						                    </div>
						                    <div class="col-lg-4 show-lg-only"></div>
						                    <div class="col-lg-4 col-md-12 p-0">
						                        <div class="custom-barcode-area barcodeverify" th:stat="${box.stat}"
						                             th:download-verify="${box.downloadVerify}"></div>
						                    </div>
						                    <div class="col-lg-4 col-md-12 flex-bottom">
						                        <button class="theme-btn-border flex-middle barcode" th:id="'barcode-btn'+${box.id}"
						                                onclick="javascript:createRandomVerify(this);" th:stat="${box.stat}"
						                                th:download-verify="${box.downloadVerify}">
						                            <p class="img">手動更新條碼</p>
						                        </button>
						                    </div>
						                </div>
										<!-- 服務box內的個人資料下載 -->
										<ul id="card-footer" th:id="'card-footer'+${box.id}" class="card-footer w-100 bg-white p-0 mb-0" th:if="${not #lists.isEmpty(box.boxList)}">
											<li class="single-data-wrap multiple flex-between" th:each="tbox : ${box.boxList}" th:if="${not #lists.isEmpty(box.boxList)}">
											    <p class="mb-0 text-left w-100">
											    		<th:block th:if="${tbox.cateId==1}">
												    <span class="icon household"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==2}">
												    <span class="icon land"></span>
												    </th:block>
												    	<th:block th:if="${tbox.cateId==3}">
												    <span class="icon fiscal-tax"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==4}">
												    <span class="icon business"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==5}">
												    <span class="icon highway"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==6}">
												    <span class="icon labor"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==7}">
												    <span class="icon health-insurance"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==8}">
												    <span class="icon medical"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==9}">
												    <span class="icon financial"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==10}">
												    <span class="icon education"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==11}">
												    <span class="icon legal"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==12}">
												    <span class="icon welfare"></span>
												    </th:block>
											    		<th:block th:if="${tbox.cateId==13}">
												    <span class="icon others"></span>
												    </th:block>
												    <span th:text="${tbox.prName}">個人戶籍資料查詢</span>
											    </p>
						                        <button class="btn btna theme-btn-border mr-2" onclick="javascript:previewToCompany(this);"
				                                    th:box-id="${tbox.id}" th:data-src="@{/personal/box/prview}+'/'+${tbox.id}"
				                                    th:data-id="${tbox.prId}"
				                                    th:httpcode="${tbox.code}"
													th:if="${box.agreeAgent == null}"
												>線上預覽檔案</button>
											</li>
						                    <li th:id="'not-agent'+${box.id}" class="single-data-wrap" th:style="${box.agentName!=null}?'display:none':'display:block'" th:if="${counterAgentVer==1 && box.isOpenAgent!=null&&box.isOpenAgent==1}">
												<div class="need-permission bg-gray text-center mb-2" style="padding: 16px">
													想將此服務委託給指定代辦人申請嗎？<br>
												   <button class="btn btn-primary" th:data-id="${box.id}" onclick="javascript:changeAgentPopWin(this);">代辦服務</button>
												</div>
						                    </li>
										</ul>
						            </div>
						        </div>
						    </div>
						    <!-- 無資料 -->
						    <div class="no-data" th:if="${#lists.isEmpty(portalBoxExtList)&&#lists.isEmpty(portalBoxExtList1)}">
						        <img class="w-100" src="./images/no-data.png" th:src="@{/resources/dist/image/no-data.png}" alt="尚無資料"
						             aria-label="尚無資料">
						    </div>
						</div>
						<!-- tab3 end-->
					</div>
				</div>
			</div>
		</section>
	</div>
	
	<!-- css bd-example-modal-lg -->
	<div id="update-pop-message" class="modal fade"  style="padding-right: 15px;" data-backdrop="static" data-keyboard="false">
		<!-- css modal-lg -->
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLongTitle1">MyData提醒</h5>
					<button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>
				<div class="modal-body txt_left">
					<ul>
						<li>
							<p id="update-message-text">
								儲存成功
							</p>
						</li>
					</ul>
					<div class="text-center"><button id="update-pop-message-login-btn" class="theme-btn mt-1" onclick="javascript:confirmUpdatePopMessage(this);">確認</button></div>
				</div>
			</div>
		</div>
	</div>

	<div id="change-email-pop-message" class="modal fade bd-example-modal-lg show" data-backdrop="static" data-keyboard="false">
	    <div class="modal-dialog modal-dialog-centered modal-lg">
	      <div class="modal-content">
	        <div class="modal-header">
	          <h5 class="modal-title" id="exampleModalEmailTitle">變更／驗證聯絡方式</h5>
	          <button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal" aria-label="Close">
	            <span aria-hidden="true">×</span>
	          </button>
	        </div>
	        <div class="modal-body txt_left">
	          <div id="email-step1">
		          <p>Step 1.請輸入您欲變更的電子信箱</p>
		          <div class="row">
		            <div class="col-md-6">
		              <label class="flex-center w-100 nowrap mb-0 word-4">電 子 信 箱：
						  <input class="w-100" id="new_email" type="text" placeholder="請輸入您的新電子信箱"
							   onfocus="inputFocusinEvent_1(this)"
                               onblur="inputFocusoutEvent_1(this, MaskType.email)" 
                               autocomplete="off">
						  <i onclick="maskorUnMask_v2(this);" th:id="'eye_new_email'" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i>
		              </label>
		              <div class="text-right">
		                <a id="emailSendLink" href="javascript:emailOrMobileMessageSend('email');"><small class="link" id="sendEmailOTPText">點此發送驗證碼</small></a>
		              </div>
		            </div>
		            <div class="col-md-6">
		              <label class="flex-center w-100 nowrap mb-0 word-3">驗 證 碼：
		                <input class="w-100" id="new_email_checkCode" type="text" pattern="[0-9]*" inputmode="numeric" placeholder="請輸入8位數驗證碼">
		              </label>
		              <div class="text-left">
						  <a id="emailReSendLink" href="javascript:emailOrMobileMessageSend('email');" style="display: none;"><small class="link" id="resendEmailOTPText">點此重新發送驗證碼</small></a>
						  <small id="resendEmailOTPMsg" style="display: none;"></small>
		              </div>
		            </div>
		             <div class="col-md-12">
		            	<div class="text-center mt-2">
		            		<button class="theme-btn mt-1" onclick="javascript:iWantUpdate('email');">下一步</button>
		          		</div>
		            </div>
		          </div>
	          </div>
	          <div id="email-step2">
		          <p class="mb-0">Step 2.身分驗證 <small class="m-0 alert">*為保護您的資料安全，在變更聯絡方式前，需要先進行身分驗證。</small></p>
		          <div class="form verification-level text-center mt-4 mb-4">
		            <!-- 目前將 radio 做成按鈕形式，當某驗證方式被選取，請於Class ' form-group radio ' 旁加上 ' checked '' -->
		            <div class="text-left" style="width: fit-content; margin: 0 auto; width: -moz-fit-content;">
		            <div class="form-group digital-id-card radio" data-type="digital" onclick="javascript:addClassChecked(this);" data-id="email"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="digital-id-card-email" name="verification-level" value="0" 
		              	th:checked="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="digital-id-card-email" tabindex="0" title="選擇自然人憑證驗證身份">
		                <div class="bg-img"></div> <span class="text">自然人憑證 </span>
		              </label>
		            </div>
		            <div class="form-group business-id-card radio" data-type="business" onclick="javascript:addClassChecked(this);" data-id="email"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType=='0.5') ? 'true':'false'}">
		              <input type="radio" id="business-id-card-email" name="verification-level" value="0.5"
		              	th:checked="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType=='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="business-id-card-email" tabindex="0" title="選擇工商憑證驗證身份">
		                <div class="bg-img"></div> <span class="text">工商憑證 </span>
		              </label>
		            </div>
		            <div class="form-group fic-card radio" data-type="fic" onclick="javascript:addClassChecked(this);" data-id="email"
		            	th:if="${(twcaVerifyVer==1&&session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="fic-email" name="verification-level" value="0.1" 
		              	th:checked="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="fic-email" tabindex="0" title="選擇晶片金融卡驗證身份">
		                <div class="bg-img"></div> <span class="text">晶片金融卡 </span>
		              </label>
		            </div>
		            <div class="form-group fch-card radio" data-type="fch" onclick="javascript:addClassChecked(this);" data-id="email"
		            	th:if="${(twcaVerifyVer==1&&session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="fch-email" name="verification-level" value="0.2" 
		              	th:checked="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="fch-email" tabindex="0" title="選擇硬體金融憑證驗證身份">
		                <div class="bg-img"></div> <span class="text">硬體金融憑證 </span>
		              </label>
		            </div>
		            
		            <div class="form-group t-fido radio" data-type="t-fido" onclick="javascript:createTFidoQRcode(this);" data-id="email"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="t-fido-email" name="verification-level" value="1">
		              <label class="flex-middle" for="t-fido-email" tabindex="0" title="選擇TW FidO驗證身份">
		                <div class="bg-img"></div> <span class="text">TW FidO</span>
		              </label>
		            </div>
		            <div class="form-group health-id-card radio" data-type="health" onclick="javascript:addClassChecked(this);" data-id="email"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="health-id-card-email" name="verification-level" value="2">
		              <label class="flex-middle" for="health-id-card-email" tabindex="0" title="選擇健保卡驗證身份">
		                <div class="bg-img"></div> <span class="text">健保卡 </span>
		              </label>
		            </div>
		            
		            <div class="form-group health-id-card radio" data-type="fcs" onclick="javascript:addClassChecked(this);" data-id="email"
		            	th:if="${(twcaVerifyVer==1&&session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="fcs-email" name="verification-level" value="2.1" 
		              	th:checked="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="fcs-email" tabindex="0" title="選擇軟體金融憑證驗證身份">
		                <div class="bg-img"></div> <span class="text">軟體金融憑證 </span>
		              </label>
		            </div>
		            
		            <div id="EmailOrMobileStep1-email" class="form-group otp-sms radio" data-type="email" onclick="javascript:loginByEmailOrMobileStep1(this);" data-id="email"
		            	th:if="${session.SignedInUser.member.informMethod != null}">
		              <input type="radio" id="email-email" name="verification-level" value="4">
		              <label class="flex-middle" for="email-email" tabindex="0" title="選擇動態密碼驗證身份">
		                <div class="bg-img"></div> <span class="text">動態密碼</span>
		              </label>
		            </div>
		            <div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="digital">
		              <div class="row">
		                <div class="col-md-6">
		                  <div class="text-left">
		                    <label class="w-100 mb-0">
		                      <span>請插入您的自然人憑證，並輸入PIN碼
		                        <small class="alert">(必填)</small>
		                      </span>
		                      <input type="password" pattern="[0-9]*" inputmode="numeric" id="digital-pin" class="form-control" placeholder="請輸入您的PIN碼">
								<div class="text-right verify-tag-wrap ">
									<a href="https://moica.nat.gov.tw/unblockcard.html" target="_blank" title="忘記 PIN 碼(另開新頁)"><small class="link">忘記 PIN 碼？</small></a>
								</div>
		                    </label>
		                  </div>
		                </div>
		                <div class="col-md-6 text-left note-wrap">
		                  <p class="mb-0 bold">初次使用自然人憑證驗證嗎？</p>
							<p class="mb-2">請備妥晶片讀卡機並安裝<a class="link" href="https://moica.nat.gov.tw/download_1.html" target="_blank" title="HiCOS卡片管理工具(另開新頁)">HiCOS卡片管理工具</a>，插卡輸入 PIN 碼即可完成驗證。
								<br>
								<a class="link" href="https://moica.nat.gov.tw/ShowCardInfo.html" target="_blank" title="憑證IC卡檢測(另開新頁)">憑證IC卡檢測</a>
							</p>

						</div>
		              </div>
		            </div>
                    <div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="fic">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="text-left">
                                    <label class="w-100 mb-0">
                                        <span>請插入您的晶片金融卡，並輸入密碼<small class="alert">(必填)</small></span>
                                        <input type="password" pattern="[0-9]*" inputmode="numeric" id="fic-pin" class="form-control" placeholder="請輸入您的密碼" autocomplete="off">
                                            <img src="/resources/dist/image/ps-icon.svg" th:src="@{/resources/dist/image/ps-icon.svg}" alt="注意事項：" style="width: 15px; margin-right: 3px">
                                            <small style="display: initial;">密碼連續3次錯誤後，將會鎖卡，如需解鎖卡片請洽原發卡銀行</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 text-left note-wrap">
                                <p class="mb-0 bold">初次使用晶片金融卡驗證嗎？</p>
                                <p class="mb-2">
                                Windows作業系統：請備妥晶片讀卡機並安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.exe}" target="_blank" title="Windows版TWCA金融憑證元件.exe">Windows版TWCA金融憑證元件</a>。<br>
                                Mac作業系統：請備妥晶片讀卡機並安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.pkg}" target="_blank" title="Mac版TWCA金融憑證元件.pkg">Mac版TWCA金融憑證元件</a>。
								<div class="learning-wrap inline">
									<div class="absolute-center shadow-sm" style="width: 264px;top: -185px;z-index:99;">
										<p class="mb-0 text-center" style="font-size:1.125rem !important;padding: 4px;">支援銀行列表</p>
										<div>臺灣銀行、臺灣土地銀行、合作金庫商業銀行、第一商業銀行、華南商業銀行、彰化商業銀行、上海商業儲蓄銀行、台北富邦商業銀行、國泰世華商業銀行、兆豐國際商業銀行、王道商業銀行、臺灣中小企業銀行、臺灣新光商業銀行、聯邦商業銀行、遠東國際商業銀行、元大商業銀行、永豐商業銀行、凱基商業銀行、台新國際商業銀行、日盛國際商業銀行、中國信託商業銀行。</div>
										<div class="twingle-down"></div>
									</div>
									<a href="javascript:showLearning(this);" style="color: #0c7eb1;text-decoration: underline;">可以用哪些銀行的晶片金融卡</a>
								</div>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="fch">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="text-left">
                                    <label class="w-100 mb-0">
                                        <span>請插入您的硬體金融憑證，並輸入PIN碼<small class="alert">(必填)</small></span>
                                        <input type="password" id="fch-pin" class="form-control" placeholder="請輸入您的PIN碼" autocomplete="off">
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 text-left note-wrap">
                                <p class="mb-0 bold">初次使用硬體金融憑證驗證嗎？</p>
                                <p class="mb-2">
                                Windows作業系統：請備妥晶片讀卡機並安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.exe}" target="_blank" title="Windows版TWCA金融憑證元件.exe">Windows版TWCA金融憑證元件</a>。<br>
                                Mac作業系統：請備妥晶片讀卡機並安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.pkg}" target="_blank" title="Mac版TWCA金融憑證元件.pkg">Mac版TWCA金融憑證元件</a>。
								<div class="learning-wrap inline">
									<div class="absolute-center shadow-sm" style="width: 264px;top: -165px;z-index:99;">
										<p class="mb-0 text-center" style="font-size:1.125rem !important;padding: 4px;">支援銀行列表</p>
										<div>玉山銀行、日商三菱日聯銀行、日盛國際商業銀行、王道商業銀行、台中商業銀行、永豐商業銀行、兆豐國際商業銀行、合作金庫商業銀行、京城商業銀行、板信商業銀行、國泰世華銀行、華泰商業銀行、陽信商業銀行、滙豐(台灣)商業銀行、臺灣土地銀行、臺灣新光商業銀行、臺灣銀行、聯邦商業銀行。</div>
										<div class="twingle-down"></div>
									</div>
									<a href="javascript:showLearning(this);" style="color: #0c7eb1;text-decoration: underline;">可以用哪些銀行的硬體金融憑證</a>
								</div>
                                </p>
                            </div>
                        </div>
                    </div>
					<div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="business">
						<div	 class="row">
							<div class="col-md-6">
								<div class="text-left">
									<label class="w-100 mb-0">
											<span>請插入您的工商憑證，並輸入PIN碼
												<small class="alert">(必填)</small>
											</span>
										<input type="password" id="business-pin" class="form-control" placeholder="請輸入您的PIN碼">
									</label>
								</div>
							</div>
							<div class="col-md-6 text-left note-wrap">
								<p class="mb-0 bold">初次使用工商憑證驗證嗎？</p>
								<p class="mb-2">
									備妥晶片讀卡機及<a class="link" href="http://moica.nat.gov.tw/download_1.html" target="_blank" title="安裝元件(另開新頁)">安裝元件</a>，插卡輸入 PIN 碼就可以完成驗證，完整說明請參考<a class="link" href="http://moica.nat.gov.tw/download/File/HiCOS.pdf" target="_blank" title="內政部憑證管理中心說明(另開新頁)">內政部憑證管理中心說明</a>。
								</p>
							</div>
						</div>
					</div>
					<div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="t-fido">
						<div class="row">
							<div class="col-md-6 twqrshow">
								<div class="text-left hidden-mobile">
									<p class="w-100 mb-0">請掃描／點擊您的 TW FidO 驗證 QRcode</p>
									<div class="text-center qr-code-wrap m-3">
										<div id="tfido-QRcodeemail" style="text-align: -webkit-center;"></div>
									</div>
									<a href="javascript:refreshTFidoQRcode('email');" class="link"><small class="link">點此重新產生QRcode</small></a>
									<input type="hidden" id="qridemail"/>
								</div>
								<div class="text-left note-wrap hidden-desktop">
									<p class="mb-0 bold alert">MyData 已發送驗證通知至您的 TW FidO</p>
	               					<p class="mb-0">(1) 請確認您有開啟 TW FidO APP 的通知功能。</p>
	               					<p class="mb-0">(2) 請點擊 TW FidO APP，並完成身分驗證。</p>
	               					<a href="javascript:refreshTFidoQRcode('email');" class="link mt-3 block">點此重新推播</a>
									<input type="hidden" id="qridemail"/>
	               					<hr>
	          					</div>
							</div>
							<div class="col-md-6">
								<div class="text-left note-wrap">
									<p class="mb-0 bold">初次使用TW FidO驗證嗎？</p>
									<p class="mb-0 no-t-fido">＊我的手機支援 TW FidO 嗎？點擊連結查看<a href="https://fido.moi.gov.tw/devices" target="_blank" title="支援手機版本(另開新頁)" class="link">支援手機版本</a>。</p>
									<p class="mb-0 no-t-fido">
										＊還沒有下載/註冊 TW FidO 嗎？請點擊連結<a href="https://play.google.com/store/apps/details?id=tw.gov.moi.tfido" target="_blank" title="下載 Android 版本(另開新頁)" class="link">下載 Android 版本</a>、<a href="https://apps.apple.com/tw/app/id1462866416" target="_blank" title="下載 iOS 版本(另開新頁)" class="link">下載 iOS 版本</a>。
									</p>
									<p class="mb-0">
										＊不知道怎麼操作嗎？請點擊<a href="https://fido.moi.gov.tw/qa" target="_blank" title="常見問題(另開新頁)" class="link">常見問題</a>。
									</p>
									<!-- <p class="mb-0 alert has-t-fido">＊於 TW FidO APP 完成身分驗證後，請點擊下方的「確認」按鈕。</p> -->
								</div>
							</div>
						</div>
					</div>
					<div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="health">
						<div class="row">
							<div class="col-md-6">
								<div class="text-left">
									<label class="w-100 mb-0">
											<span>請插入您的健保卡，並輸入註冊密碼
												<small class="alert">(必填)</small>
											</span>
										<input type="password" id="health-pwd-email" class="form-control" placeholder="請輸入您的註冊密碼">
										<div class="text-right verify-tag-wrap ">
											<a href="https://cloudicweb.nhi.gov.tw/cloudic/system/mUserForget.aspx" target="_blank" title="忘記註冊密碼(另開新頁)"><small class="link">忘記註冊密碼？</small></a>
										</div>
									</label>
								</div>
								<div class="text-left mt-2">
									<label for="captcha-email" class="w-100 mb-0"><span>
									    驗證碼<small class="alert">(必填)</small></span></label>
									<input type="text" id="captcha-email" name="captcha-email" class="w-100">
									<br>
									<img id="captchaImg-email" alt="captcha" th:src="@{/captcha.jpg}" class="mt-1">
									<button class="btn p-0 speaker" title="語音播放驗證碼" onclick="javascript:captchaGoogleSounfPlay();">
										<img th:src="@{/resources/dist/image/speaker-icon.svg}" alt="語音播放">
									</button>
									<a href="javascript:void(0);" class="link" onclick="javascript:refreshCaptchaImage('email');">
									    <small class=" link m-0 mt-3 ml-1">刷新驗證碼</small>
									</a>
								</div>
							</div>
							<div class="col-md-6 text-left note-wrap">
								<p class="mb-0 bold">初次使用健保卡驗證嗎？</p>
								<p class="mb-2">請備妥健保卡、晶片讀卡機，並請依照您的作業系統版本(OS)選擇元件安裝檔下載<a class="link" href="https://cloudicweb.nhi.gov.tw/cloudic/system/SMC/mEventesting.htm" target="_blank" title="安裝元件(另開新頁)">安裝元件</a>，插卡輸入註冊密碼就可以完成驗證，請詳<a class="link" target="_blank" title="健保卡網路服務註冊(另開新頁)" href="https://cloudicweb.nhi.gov.tw/cloudic/system/mlogin.aspx">健保卡網路服務註冊</a>。
									<br>
									<a class="link" target="_blank" title="健保卡檢測(另開新頁)" href="https://cloudicweb.nhi.gov.tw/cloudic/system/SMC/webtesting/SampleY.aspx">健保卡檢測</a>
								</p>
							</div>
						</div>
					</div>
                    <div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="fcs">
                        <div class="row">
<!--                             <div class="col-md-6"> -->
<!--                                 <div class="text-left"> -->
<!--                                     <label class="w-100 mb-0"> -->
<!--                                         <span>請選擇您的軟體金融憑證<small class="alert">(必填)</small></span> -->
<!--                                     </label> -->
<!--                                 </div> -->
<!--                             </div> -->
                            <div class="col-md-12 text-left note-wrap">
                                <p class="mb-0 bold">初次使用軟體金融憑證驗證嗎？</p>
                                <p class="mb-2">
                                Windows作業系統：請安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.exe}" target="_blank" title="Windows版TWCA金融憑證元件.exe">Windows版TWCA金融憑證元件</a>。<br>
                                Mac作業系統：請安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.pkg}" target="_blank" title="Mac版TWCA金融憑證元件.pkg">Mac版TWCA金融憑證元件</a>。
								<div class="learning-wrap inline">
									<div class="absolute-center shadow-sm" style="width: 264px;top:-235px;z-index:99;">
										<p class="mb-0 text-center" style="font-size:1.125rem !important;padding: 4px;">支援金融機構列表</p>
										<div>大展證券、大慶證券、元大證券金融、元富證券、日盛證券、台中銀證券、台新綜合證券、台灣土地銀行證券部、永全證券、永興證券、永豐金證券、玉山綜合證券、兆豐證券、光和證券、合作金庫證券、宏遠證券、亞東證券、致和證券、國泰綜合證券、國票綜合證券、康和綜合證券、第一金證、統一綜合證券、凱基證券、富邦綜合證券、犇亞證券網路公司、華南永昌綜合證券、陽信證券、新百王證券、群益金鼎證券、福邦證券、福勝證券、臺銀綜合證券、臺灣中小企業銀行證券部、遠智證券、德信綜合證券、聯邦商業銀行證券部。</div>
										<div class="twingle-down"></div>
									</div>
									<a href="javascript:showLearning(this);" style="color: #0c7eb1;text-decoration: underline;">可以用哪些銀行的軟體金融憑證</a>
								</div>
                                </p>
                            </div>
                        </div>
                    </div>
					<div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="email">
						<div class="row">
							<div class="col-md-12">
								<div class="text-left">
									<label class="w-100 mb-0"><span>請輸入動態密碼<small class="alert">(必填)</small></span>
										<input type="text" pattern="[0-9]*" inputmode="numeric" id="otp-email" class="form-control" placeholder="請輸入您的動態密碼">
									</label>
								</div>
							</div>
							<div class="col-md-12 text-left">
								<p class="mb-2">
								<a id="resendOTPLink-email" href="javascript:resendMemberOTP('email');" class="text-left w-100 underline">
									<small id="resendOTPText-email" class="link">點此重新發送動態密碼</small>
								</a>
								</p>
							</div>
						</div>
					</div>
					</div>
		          </div>
		          <div class="text-center mt-2"><button id="otp-pop-message-login-btn" class="theme-btn mt-1" onclick="javascript:verificationData('email');">確認</button>
		          </div>
	          </div>
			  <div class="text-center pop-error-message" style="display:none;">
				<p class="alert mb-0"></p>
			  </div>
	        </div>
	      </div>
	    </div>
	</div>

	<div id="change-mobile-pop-message" class="modal fade bd-example-modal-lg show" data-backdrop="static" data-keyboard="false">
	    <div class="modal-dialog modal-dialog-centered modal-lg">
	      <div class="modal-content">
	        <div class="modal-header">
	          <h5 class="modal-title" id="exampleModalMobileTitle">變更／驗證聯絡方式</h5>
	          <button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal" aria-label="Close">
	            <span aria-hidden="true">×</span>
	          </button>
	        </div>
	        <div class="modal-body txt_left">
	          <div id="mobile-step1">
		          <p>Step 1.請輸入您欲變更的手機號碼</p>
		          <div class="row">
		            <div class="col-md-6">
		              <label class="flex-center w-100 nowrap mb-0 word-4">手 機 號 碼：
						  <input class="w-100" id="new_mobile" type="text" pattern="[0-9]*" inputmode="numeric" placeholder="請輸入您的新手機號碼"
								onfocus="inputFocusinEvent_1(this)" 
                                oninput="inputTypingEvent(this, MaskType.phone)" 
                                onblur="inputFocusoutEvent_1(this, MaskType.phone)" 
                                autocomplete="off">
						  <i onclick="maskorUnMask_v2(this);" th:id="'eye_new_mobile'" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i>
		              </label>
		              <div class="text-right">
						  <a id="mobileSendLink" href="javascript:emailOrMobileMessageSend('mobile');"><small class="link" id="sendMobileOTPText">點此發送驗證碼</small></a>
		              </div>
		            </div>
		            <div class="col-md-6">
		              <label class="flex-center w-100 nowrap mb-0 word-3">驗 證 碼：
		                <input class="w-100" id="new_mobile_checkCode" type="text" pattern="[0-9]*" inputmode="numeric" placeholder="請輸入8位數驗證碼">
		              </label>
		              <div class="text-left">
						  <a id="mobileReSendLink" href="javascript:emailOrMobileMessageSend('mobile');" style="display: none;"><small class="link" id="resendMobileOTPText">點此重新發送驗證碼</small></a>
						  <small id="resendMobileOTPMsg" style="display: none;"></small>
		              </div>
		            </div>
		            <div class="col-md-12">
		            	<div class="text-center mt-2">
		            		<button class="theme-btn mt-1" onclick="javascript:iWantUpdate('mobile');">下一步</button>
		          		</div>
		            </div>
		          </div>
	          </div>
	          <div id="mobile-step2" style="display:none;">
		      	<p class="mb-0">Step 2.身分驗證 <small class="m-0 alert">*為保護您的資料安全，在變更聯絡方式前，需要先進行身分驗證。</small></p>
		          <div class="form verification-level text-center mt-4 mb-4">
		            <!-- 目前將 radio 做成按鈕形式，當某驗證方式被選取，請於Class ' form-group radio ' 旁加上 ' checked '' -->
		            <div class="text-left" style="width: fit-content; margin: 0 auto; width: -moz-fit-content;">
		            <div class="form-group digital-id-card radio" data-type="digital" onclick="javascript:addClassChecked(this);" data-id="mobile"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="digital-id-card-mobile" name="verification-level" value="0"
		              	th:checked="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType=='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="digital-id-card-mobile" tabindex="0" title="選擇自然人憑證驗證身份">
		                <div class="bg-img"></div> <span class="text">自然人憑證 </span>
		              </label>
		            </div>
		            <div class="form-group business-id-card radio" data-type="business" onclick="javascript:addClassChecked(this);" data-id="mobile"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType=='0.5') ? 'true':'false'}">
		              <input type="radio" id="business-id-card-mobile" name="verification-level" value="0.5"
		              	th:checked="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType=='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="business-id-card-mobile" tabindex="0" title="選擇工商憑證驗證身份">
		                <div class="bg-img"></div> <span class="text">工商憑證 </span>
		              </label>
		            </div>
		            <div class="form-group fic-card radio" data-type="fic" onclick="javascript:addClassChecked(this);" data-id="email"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="fic-email" name="verification-level" value="0.1" 
		              	th:checked="${(twcaVerifyVer==1&&session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="fic-email" tabindex="0" title="選擇晶片金融卡驗證身份">
		                <div class="bg-img"></div> <span class="text">晶片金融卡 </span>
		              </label>
		            </div>
		            <div class="form-group fch-card radio" data-type="fch" onclick="javascript:addClassChecked(this);" data-id="email"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="fch-email" name="verification-level" value="0.2" 
		              	th:checked="${(twcaVerifyVer==1&&session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="fch-email" tabindex="0" title="選擇硬體金融憑證驗證身份">
		                <div class="bg-img"></div> <span class="text">硬體金融憑證 </span>
		              </label>
		            </div>
		            <div class="form-group t-fido radio" data-type="t-fido" onclick="javascript:createTFidoQRcode(this);" data-id="mobile"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="t-fido-mobile" name="verification-level" value="1">
		              <label class="flex-middle" for="t-fido-mobile" tabindex="0" title="選擇TW FidO驗證身份">
		                <div class="bg-img"></div> <span class="text">TW FidO</span>
		              </label>
		            </div>
		            <div class="form-group health-id-card radio" data-type="health" onclick="javascript:addClassChecked(this);" data-id="mobile"
		            	th:if="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="health-id-card-mobile" name="verification-level" value="2">
		              <label class="flex-middle" for="health-id-card-mobile" tabindex="0" title="選擇健保卡驗證身份">
		                <div class="bg-img"></div> <span class="text">健保卡 </span>
		              </label>
		            </div>
		            <div class="form-group health-id-card radio" data-type="fcs" onclick="javascript:addClassChecked(this);" data-id="email"
		            	th:if="${(twcaVerifyVer==1&&session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <input type="radio" id="fcs-email" name="verification-level" value="2.1" 
		              	th:checked="${(session.SignedInUser!=null&&session.SignedInUser.member.uid!=null&&session.SignedInUser.roleType!='0.5') ? 'true':'false'}">
		              <label class="flex-middle" for="fcs-email" tabindex="0" title="選擇軟體金融憑證驗證身份">
		                <div class="bg-img"></div> <span class="text">軟體金融憑證 </span>
		              </label>
		            </div>
		            <div id="EmailOrMobileStep1-mobile" class="form-group otp-sms radio" data-type="email" onclick="javascript:loginByEmailOrMobileStep1(this);" data-id="mobile"
		            	th:if="${session.SignedInUser.member.informMethod != null}">
		              <input type="radio" id="email-mobile" name="verification-level" value="4">
		              <label class="flex-middle" for="email-mobile" tabindex="0" title="選擇動態密碼驗證身份">
		                <div class="bg-img"></div> <span class="text">動態密碼</span>
		              </label>
		            </div>
		            <div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="digital">
		              <div class="row">
		                <div class="col-md-6">
		                  <div class="text-left">
		                    <label class="w-100 mb-0">
		                      <span>請插入您的自然人憑證，並輸入PIN碼
		                        <small class="alert">(必填)</small>
		                      </span>
		                      <input type="password" pattern="[0-9]*" inputmode="numeric" id="digital-pin" class="form-control" placeholder="請輸入您的PIN碼">
		                    </label>
		                  </div>
		                </div>
		                <div class="col-md-6 text-left note-wrap">
		                  <p class="mb-0 bold">初次使用自然人憑證驗證嗎？</p>
							<p class="mb-2">請備妥晶片讀卡機並安裝<a class="link" href="https://moica.nat.gov.tw/download_1.html" target="_blank" title="HiCOS卡片管理工具(另開新頁)">HiCOS卡片管理工具</a>，插卡輸入 PIN 碼即可完成驗證。
								<br>
								<a class="link" href="https://moica.nat.gov.tw/ShowCardInfo.html" target="_blank" title="憑證IC卡檢測(另開新頁)">憑證IC卡檢測</a>
							</p>

						</div>
		              </div>
		            </div>
                    <div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="fic">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="text-left">
                                    <label class="w-100 mb-0">
                                        <span>請插入您的晶片金融卡，並輸入密碼<small class="alert">(必填)</small></span>
                                        <input type="password" pattern="[0-9]*" inputmode="numeric" id="fic-pin" class="form-control" placeholder="請輸入您的密碼" autocomplete="off">
                                            <img src="/resources/dist/image/ps-icon.svg" th:src="@{/resources/dist/image/ps-icon.svg}" alt="注意事項：" style="width: 15px; margin-right: 3px">
                                            <small style="display: initial;">密碼連續3次錯誤後，將會鎖卡，如需解鎖卡片請洽原發卡銀行</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 text-left note-wrap">
                                <p class="mb-0 bold">初次使用晶片金融卡驗證嗎？</p>
                                <p class="mb-2">
                                Windows作業系統：請備妥晶片讀卡機並安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.exe}" target="_blank" title="Windows版TWCA金融憑證元件.exe">Windows版TWCA金融憑證元件</a>。<br>
                                Mac作業系統：請備妥晶片讀卡機並安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.pkg}" target="_blank" title="Mac版TWCA金融憑證元件.pkg">Mac版TWCA金融憑證元件</a>。
								<div class="learning-wrap inline">
									<div class="absolute-center shadow-sm" style="width: 264px;top: -185px;z-index:99;">
										<p class="mb-0 text-center" style="font-size:1.125rem !important;padding: 4px;">支援銀行列表</p>
										<div>臺灣銀行、臺灣土地銀行、合作金庫商業銀行、第一商業銀行、華南商業銀行、彰化商業銀行、上海商業儲蓄銀行、台北富邦商業銀行、國泰世華商業銀行、兆豐國際商業銀行、王道商業銀行、臺灣中小企業銀行、臺灣新光商業銀行、聯邦商業銀行、遠東國際商業銀行、元大商業銀行、永豐商業銀行、凱基商業銀行、台新國際商業銀行、日盛國際商業銀行、中國信託商業銀行。</div>
										<div class="twingle-down"></div>
									</div>
									<a href="javascript:showLearning(this);" style="color: #0c7eb1;text-decoration: underline;">可以用哪些銀行的晶片金融卡</a>
								</div>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="fch">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="text-left">
                                    <label class="w-100 mb-0">
                                        <span>請插入您的硬體金融憑證，並輸入PIN碼<small class="alert">(必填)</small></span>
                                        <input type="password" id="fch-pin" class="form-control" placeholder="請輸入您的PIN碼" autocomplete="off">
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 text-left note-wrap">
                                <p class="mb-0 bold">初次使用硬體金融憑證驗證嗎？</p>
                                <p class="mb-2">
                                Windows作業系統：請備妥晶片讀卡機並安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.exe}" target="_blank" title="Windows版TWCA金融憑證元件.exe">Windows版TWCA金融憑證元件</a>。<br>
                                Mac作業系統：請備妥晶片讀卡機並安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.pkg}" target="_blank" title="Mac版TWCA金融憑證元件.pkg">Mac版TWCA金融憑證元件</a>。
								<div class="learning-wrap inline">
									<div class="absolute-center shadow-sm" style="width: 264px;top: -165px;z-index:99;">
										<p class="mb-0 text-center" style="font-size:1.125rem !important;padding: 4px;">支援銀行列表</p>
										<div>玉山銀行、日商三菱日聯銀行、日盛國際商業銀行、王道商業銀行、台中商業銀行、永豐商業銀行、兆豐國際商業銀行、合作金庫商業銀行、京城商業銀行、板信商業銀行、國泰世華銀行、華泰商業銀行、陽信商業銀行、滙豐(台灣)商業銀行、臺灣土地銀行、臺灣新光商業銀行、臺灣銀行、聯邦商業銀行。</div>
										<div class="twingle-down"></div>
									</div>
									<a href="javascript:showLearning(this);" style="color: #0c7eb1;text-decoration: underline;">可以用哪些銀行的硬體金融憑證</a>
								</div>
                                </p>
                            </div>
                        </div>
                    </div>
					<div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="business">
						<div	 class="row">
							<div class="col-md-6">
								<div class="text-left">
									<label class="w-100 mb-0">
											<span>請插入您的工商憑證，並輸入PIN碼
												<small class="alert">(必填)</small>
											</span>
										<input type="password" id="business-pin" class="form-control" placeholder="請輸入您的PIN碼">
									</label>
								</div>
							</div>
							<div class="col-md-6 text-left note-wrap">
								<p class="mb-0 bold">初次使用工商憑證驗證嗎？</p>
								<p class="mb-2">
									備妥晶片讀卡機及<a class="link" href="http://moica.nat.gov.tw/download_1.html" target="_blank" title="安裝元件(另開新頁)">安裝元件</a>，插卡輸入 PIN 碼就可以完成驗證，完整說明請參考<a class="link" href="http://moica.nat.gov.tw/download/File/HiCOS.pdf" target="_blank" title="內政部憑證管理中心說明(另開新頁)">內政部憑證管理中心說明</a>。
								</p>
							</div>
						</div>
					</div>
					<div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="t-fido">
						<div class="row">
							<div class="col-md-6 twqrshow">
								<div class="text-left hidden-mobile">
									<p class="w-100 mb-0">請掃描／點擊您的 TW FidO 驗證 QRcode</p>
									<div class="text-center qr-code-wrap m-3">
										<div id="tfido-QRcodemobile" style="text-align: -webkit-center;"></div>
									</div>
									<!-- <small>＊QRcode的有效時間為1分鐘，逾時請重新產生。(<small th:id="'tfido-second'+${pr.prId}">0</small>)</small> -->
									<a href="javascript:refreshTFidoQRcode('mobile');" class="link"><small class="link">點此重新產生QRcode</small></a>
									<input type="hidden" id="qridmobile"/>
								</div>
								<div class="text-left note-wrap hidden-desktop">
									<p class="mb-0 bold alert">MyData 已發送驗證通知至您的 TW FidO</p>
	               					<p class="mb-0">(1) 請確認您有開啟 TW FidO APP 的通知功能。</p>
	               					<p class="mb-0">(2) 請點擊 TW FidO APP，並完成身分驗證。</p>
	               					<a href="javascript:refreshTFidoQRcode('mobile');" class="link mt-3 block">點此重新推播</a>
									<input type="hidden" id="qridemail"/>
	               					<hr>
	          					</div>
		          			</div>
							<div class="col-md-6">
								<div class="text-left note-wrap">
									<p class="mb-0 bold">初次使用TW FidO驗證嗎？</p>
									<p class="mb-0 no-t-fido">＊我的手機支援 TW FidO 嗎？點擊連結查看<a href="https://fido.moi.gov.tw/devices" target="_blank" class="link" title="支援手機版本(另開新頁)">支援手機版本</a>。</p>
									<p class="mb-0 no-t-fido">
										＊還沒有下載/註冊 TW FidO 嗎？請點擊連結<a href="https://play.google.com/store/apps/details?id=tw.gov.moi.tfido" target="_blank" title="下載 Android 版本(另開新頁)" class="link">下載 Android 版本</a>、<a href="https://apps.apple.com/tw/app/id1462866416" target="_blank" title="下載 iOS 版本(另開新頁)" class="link">下載 iOS 版本</a>。
									</p>
									<p class="mb-0">
										＊不知道怎麼操作嗎？請點擊<a href="https://fido.moi.gov.tw/qa" target="_blank" title="常見問題(另開新頁)" class="link">常見問題</a>。
									</p>
									<!-- <p class="mb-0 alert has-t-fido">＊於 TW FidO APP 完成身分驗證後，請點擊下方的「確認」按鈕。</p> -->
								</div>
							</div>
						</div>
					</div>
					<div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="health">
						<div class="row">
							<div class="col-md-6">
								<div class="text-left">
									<label class="w-100 mb-0">
											<span>請插入您的健保卡，並輸入註冊密碼
												<small class="alert">(必填)</small>
											</span>
										<input type="password" id="health-pwd-mobile" class="form-control" placeholder="請輸入您的註冊密碼">
										<div class="text-right verify-tag-wrap ">
											<a href="https://cloudicweb.nhi.gov.tw/cloudic/system/mUserForget.aspx" target="_blank" title="忘記註冊密碼(另開新頁)"><small class="link">忘記註冊密碼？</small></a>
										</div>
									</label>
								</div>
								<div class="text-left mt-2">
									<label for="captcha-mobile" class="w-100 mb-0"><span>
									    驗證碼<small class="alert">(必填)</small></span></label>
									<input type="text" id="captcha-mobile" name="captcha-email" class="w-100">
									<br>
									<img id="captchaImg-mobile" alt="captcha" th:src="@{/captcha.jpg}" class="mt-1">
									<button class="btn p-0 speaker" title="語音播放驗證碼" onclick="javascript:captchaGoogleSounfPlay();">
										<img th:src="@{/resources/dist/image/speaker-icon.svg}" alt="語音播放">
									</button>
									<a href="javascript:void(0);" class="link" onclick="javascript:refreshCaptchaImage('mobile');">
									    <small class=" link m-0 mt-3 ml-1">刷新驗證碼</small>
									</a>
								</div>
							</div>
							<div class="col-md-6 text-left note-wrap">
								<p class="mb-0 bold">初次使用健保卡驗證嗎？</p>
								<p class="mb-2">請備妥健保卡、晶片讀卡機，並請依照您的作業系統版本(OS)選擇元件安裝檔下載<a class="link" href="https://cloudicweb.nhi.gov.tw/cloudic/system/SMC/mEventesting.htm" target="_blank" title="安裝元件(另開新頁)">安裝元件</a>，插卡輸入註冊密碼就可以完成驗證，請詳<a class="link" target="_blank" title="健保卡網路服務註冊(另開新頁)" href="https://cloudicweb.nhi.gov.tw/cloudic/system/mlogin.aspx">健保卡網路服務註冊</a>。
									<br>
									<a class="link" target="_blank" title="健保卡檢測(另開新頁)" href="https://cloudicweb.nhi.gov.tw/cloudic/system/SMC/webtesting/SampleY.aspx">健保卡檢測</a>
								</p>
							</div>
						</div>
					</div>
                    <div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="fcs">
                        <div class="row">
<!--                             <div class="col-md-6"> -->
<!--                                 <div class="text-left"> -->
<!--                                     <label class="w-100 mb-0"> -->
<!--                                         <span>請選擇您的軟體金融憑證<small class="alert">(必填)</small></span> -->
<!--                                     </label> -->
<!--                                 </div> -->
<!--                             </div> -->
                            <div class="col-md-12 text-left note-wrap">
                                <p class="mb-0 bold">初次使用軟體金融憑證驗證嗎？</p>
                                <p class="mb-2">
                                Windows作業系統：請安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.exe}" target="_blank" title="Windows版TWCA金融憑證元件.exe">Windows版TWCA金融憑證元件</a>。<br>
                                Mac作業系統：請安裝<a class="link" th:href="@{/resources/dist/twca/AgentSetup.pkg}" target="_blank" title="Mac版TWCA金融憑證元件.pkg">Mac版TWCA金融憑證元件</a>。
								<div class="learning-wrap inline">
									<div class="absolute-center shadow-sm" style="width: 264px;top:-235px;z-index:99;">
										<p class="mb-0 text-center" style="font-size:1.125rem !important;padding: 4px;">支援金融機構列表</p>
										<div>大展證券、大慶證券、元大證券金融、元富證券、日盛證券、台中銀證券、台新綜合證券、台灣土地銀行證券部、永全證券、永興證券、永豐金證券、玉山綜合證券、兆豐證券、光和證券、合作金庫證券、宏遠證券、亞東證券、致和證券、國泰綜合證券、國票綜合證券、康和綜合證券、第一金證、統一綜合證券、凱基證券、富邦綜合證券、犇亞證券網路公司、華南永昌綜合證券、陽信證券、新百王證券、群益金鼎證券、福邦證券、福勝證券、臺銀綜合證券、臺灣中小企業銀行證券部、遠智證券、德信綜合證券、聯邦商業銀行證券部。</div>
										<div class="twingle-down"></div>
									</div>
									<a href="javascript:showLearning(this);" style="color: #0c7eb1;text-decoration: underline;">可以用哪些銀行的軟體金融憑證</a>
								</div>
                                </p>
                            </div>
                        </div>
                    </div>
					<div class="bg-gray m-0 mt-2 mb-4 p-3 hidden verify" data-type="email">
						<div class="row">
							<div class="col-md-12">
								<div class="text-left">
									<label class="w-100 mb-0"><span>請輸入動態密碼<small class="alert">(必填)</small></span>
										<input type="text" pattern="[0-9]*" inputmode="numeric" id="otp-mobile" class="form-control" placeholder="請輸入您的動態密碼">
									</label>
								</div>
							</div>
							<div class="col-md-12 text-left">
								<p class="mb-2">
								<a id="resendOTPLink-mobile" href="javascript:resendMemberOTP('mobile');" class="text-left w-100 underline">
									<small id="resendOTPText-mobile" class="link">點此重新發送動態密碼</small>
								</a>
								</p>
							</div>
						</div>
					</div>
		          </div>
		          </div>
		          <div class="text-center mt-2"><button class="theme-btn mt-1" onclick="javascript:verificationData('mobile');">確認</button>
		          </div>
	          </div>
			  <div class="text-center pop-error-message" style="display:none;">
				<p class="alert mb-0"></p>
			  </div>
	        </div>
	      </div>
	    </div>
	</div>
	<!-- 代辦人設定 -->
	<div id="change-agent-pop-message" class="modal fade bd-example-modal-lg show" data-backdrop="static" data-keyboard="false">
	    <div class="modal-dialog modal-dialog-centered modal-lg">
	      <div class="modal-content">
	        <div class="modal-header">
	          <h5 class="modal-title">代辦人設定</h5>
	          <button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal" aria-label="Close">
	            <span aria-hidden="true">×</span>
	          </button>
	        </div>
	        <div class="modal-body txt_left">
	          <div id="agent-step1">
		          <p>請輸入代辦人資訊</p>
		          <div class="row">
		            <div class="col-md-6">
		              <label class="flex-center w-100 nowrap mb-0 word-4">身分證字號：
						  <input class="w-100" id="agent_uid" type="text" placeholder="請輸入代辦人的身分證字號"
								onfocus="inputFocusinEvent_1(this)" 
								oninput="inputTypingEvent(this, MaskType.uid)" 
								onblur="inputFocusoutEvent_1(this, MaskType.uid)" 
                                autocomplete="off">
						  <i onclick="maskorUnMask_v2(this);" th:id="'agent_uid'" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i>
		              </label>
		            </div>
		            <div class="col-md-6">
		              <label class="flex-center w-100 nowrap mb-0 word-3">生日：
		                <input class="w-100" id="agent_birthdate" type="text" placeholder="請輸入代辦人生日(例：0770101)"
								onfocus="inputFocusinEvent_1(this)" 
								oninput="inputTypingEvent(this, MaskType.birthdate)" 
								onblur="inputFocusoutEvent_1(this, MaskType.birthdate)" 
                                autocomplete="off">
		                <i onclick="maskorUnMask_v2(this);" th:id="'agent_birthdate'" class="fas fa-eye eye-switch pen-edit" alt="點擊輸入框即可開始編輯"></i>
		              </label>
		            </div>
		            <div class="col-md-12">
		            <p class="alert-box mt-2"><img th:src="@{/resources/dist/image/ps-icon.svg}" alt="注意事項：" style="width: 15px; margin-right: 3px">
		            		點擊確認後，系統將檢核此代辦人是否為MyData會員，如非會員請代辦人成為會員後方可使。
		            </p>
		            	<div class="text-center mt-2">
		            		<button class="theme-btn false mr-3" data-dismiss="modal">取消</button>
		            		<button id="agent-step1-next-btn" class="theme-btn mt-1" onclick="javascript:boxAgentCheck(this);">確定</button>
		          		</div>
		            </div>
		          </div>
	          </div>
			  <div class="text-center pop-error-message" style="display:none;">
				<p class="alert mb-0"></p>
			  </div>
	        </div>
	      </div>
	    </div>
	</div>
	<!-- 代辦人設定同意 -->
	<div id="change-agent-pop-agree-message" class="modal fade bd-example-modal-lg show" data-backdrop="static" data-keyboard="false">
	    <div class="modal-dialog modal-dialog-centered modal-lg">
	      <div class="modal-content">
	        <div class="modal-header">
	          <h5 class="modal-title">代辦人設定</h5>
	          <button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal" aria-label="Close">
	            <span aria-hidden="true">×</span>
	          </button>
	        </div>
	        <div class="modal-body txt_left">
	          <div id="agent-step1">
		          <div class="row">
					<div class="col-md-12">
						<p class="alert-box mt-2">
							您將同意<span id="agreeAgentName">王○明</span>代辦【 <span id="providerName">嘉義縣</span> - <span id="serviceName">長照服務 2.0 線上申辦</span> 】，後續將由代辦人進行服務申辦。
						</p>
					</div>
		            <div class="col-md-12">
		            	<div class="text-center mt-2">
		            		<button class="theme-btn false mr-3" data-dismiss="modal">不同意</button>
		            		<button id="agent-step2-next-btn" class="theme-btn mt-1" onclick="javascript:boxAgentUpdate(this);">同意</button>
		          		</div>
		            </div>
		          </div>
	          </div>
			  <div class="text-center pop-error-message" style="display:none;">
				<p class="alert mb-0"></p>
			  </div>
	        </div>
	      </div>
	    </div>
	</div>
	<!-- 取消代辦 -->
	<div id="cancel-agent-pop-message" class="modal fade show" role="dialog" aria-labelledby="refuseModalLabel" style="display: none;" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="refuseModalLabel">MyData 提醒</h5>
					<button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>
				<div id="cancel-agent-pop-message-text" class="modal-body">是否取消此臨櫃條碼資料代辦。</div>
				<div class="modal-footer">
					<button class="theme-btn false mr-3" data-dismiss="modal">取消</button>
					<button id="cancel-agent-btn" class="theme-btn" data-id="" data-src="" onclick="javascript:cancelAgentConfirmYes(this);">確定</button>
				</div>
			</div>
		</div>
	</div>
	<!-- Message -->
	<div id="pop-message-refresh" class="modal fade show" role="dialog" data-backdrop="static" data-keyboard="false"
	     aria-labelledby="refuseModalLabel" style="display: none;">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="refuseModalLabel">MyData 提醒</h5>
	                <button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal"
	                        aria-label="Close">
	                    <span aria-hidden="true">×</span>
	                </button>
	            </div>
	            <div id="message-text-refresh" class="modal-body">
					如有問題請洽客服人員，
					<br>客服電話<a href="tel:0800-009-868" title="致電Mydata客服電話">0800-009-868</a>，
					<br>客服信箱<a href="mailto:mydata@ndc.gov.tw" class="footer_about" title="寫信至Mydata客服信箱">mydata@ndc.gov.tw</a>
	            </div>
	            <div class="modal-footer">
	                <button id="pop-message-close-btn" class="theme-btn"
	                        data-dismiss="modal" onclick="javascript:window.location.reload();">關閉
	                </button>
	            </div>
	        </div>
	    </div>
	</div>
	
	<!-- 下載提示-->
	<div id="download-pop-message" class="modal fade show" role="dialog" aria-labelledby="refuseModalLabel" data-backdrop="static" data-keyboard="false"
	     style="display: none;">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="refuseModalLabel">MyData 提醒</h5>
	                <button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">×</span>
	                </button>
	            </div>
	            <div id="download-message-text" class="modal-body">此檔案轉存後，僅供您個人參考，不得作為業務申辦佐證文件，且本平臺將立即刪除該檔案。是否仍要轉存？</div>
	            <!-- <div id="download-message-text" class="modal-body">檔案轉存後，本平臺將立即刪除該檔案。是否確定要轉存嗎？</div> -->
	            <div class="modal-footer">
	                <button class="theme-btn false mr-3" data-dismiss="modal">取消</button>
	                <button id="download-btn" class="theme-btn" data-id="" onclick="javascript:downloadToCompany(this);">
	                    確定
	                </button>
	            </div>
	        </div>
	    </div>
	</div>
	<!--線上預覽檔案提示-->
	<div id="preview-pop-message" class="modal fade show" role="dialog" aria-labelledby="refuseModalLabel" style="display: none;" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="refuseModalLabel">MyData 提醒</h5>
					<button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>
				<div id="preview-message-text" class="modal-body">此畫面僅供您個人檢視參考，不得列印作為業務申辦佐證文件。</div>
				<div class="modal-footer">
					<button class="theme-btn false mr-3" data-dismiss="modal">取消</button>
					<button id="preview-btn" class="theme-btn" data-id="" data-src="" onclick="javascript:previewToCompanyConfirmYes(this);">確定</button>
				</div>
			</div>
		</div>
	</div>
	<!--======= footer =======-->
	<footer th:replace="fragment/footer::footer"></footer>
	<a id="back-to-top" href="#" class="btn btn-primary btn-lg back-to-top"
		role="button" title="網頁置頂" data-toggle="tooltip" data-placement="left"
		style="display: inline;"> <img class="arrow-position"
		src="images/top-arrow.png"
		th:src="@{/resources/dist/image/top-arrow.png}" alt="向上置頂">
	</a>
	<!--======= end footer =======-->

	<!--======= health-card =======-->
	<span th:replace="fragment/login-health::login-health"></span>
	<!--======= end health-card =======-->

<script type="text/javascript" th:inline="javascript" >
	var tfidos = [];
	var uuidcheck ='';
	var informMethod = '';
	var member = /*[[${member}]]*/'';
	var waitOTPsecInterval;
	var waitEmailorMobileOTPsecInterval;
	var level;
	var tmpType;
	var roleType = /*[[${session.SignedInUser.roleType}]]*/'';
	var qrcodeIntervalObj;
	var publicKeyBase64;
	var privatKeyBase64;
	$(function() {
		piiPrompt();
		
		if(member.name == null || member.informMethod == null) {
			$('#message-text').text('請輸入姓名、主要聯絡方式方可成為會員，使用本平臺服務');
			$('#pop-message').modal('show');
		}
		if(typeof crypto.subtle!='undefined'){
			createNewUserKey().then(function(key){
				publicKeyBase64 = toPublicPem(key[0]);
				privatKeyBase64 = toPrivatePem(key[1]);
			});
		}
	});

	$(document).mouseup(function (e) {
		var container =$(".learning-wrap"); // 這邊放你想要排除的區塊
		if (!container.is(e.target) && container.has(e.target).length === 0) {
			container.removeClass('active');
		}
	});
	$(window).scroll(function() {
		$(".learning-wrap").removeClass('active');
	});
	
	function nameMaskorUnMask() {
		var isfocus = $('#name').is(":focus");
		if(isfocus == true) {
			$('#name').blur();
		} else {
			$('#name').focus();
		}
	}
	
	/**
	 * 組成驗證登入參數
	 */
	function loginParam() {
		return {
			"uid" : getUnmaskValue('#uid'),
			"birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
			"scope" : "basic",
			"verificationPath" : "member"
		};
	}	
	
	function contactEmailOrMobile() {
		// mobile or email
		var emailradioVal = $('input[name=emailradio]:checked').val();
		var phoneNumber = $('#mobile').val();
		var emailAddr = $('#email').val();
		
		var p = {
			id : member.id,
			name : getUnmaskValue($('#name')),
			email : getUnmaskValue($('#email')),
			mobile : getUnmaskValue($('#mobile')),
			inform_method: emailradioVal
		};
		if(p.mobile !== member.mobile && p.inform_method==='mobile'){
			p.inform_method = '';
		}
		if(p.email !== member.email && p.inform_method==='email'){
			p.inform_method = '';
		}
		
		var checkFlag = true ;
		if(typeof p.name == 'undefined' || p.name == ''){
			$('#update-message-text').text('請輸入姓名');
			$('#update-pop-message').modal('show');
			checkFlag = false;
			focusBefore = $('#name');
		}
		if(checkFlag && emailradioVal === 'mobile' && typeof p.mobile == 'undefined' ){
			if($('#mobile').val().length < 1){
				$('#update-message-text').text('請輸入手機號碼');
				$('#update-pop-message').modal('show');
				$('#update-pop-message-login-btn').attr('data-id','mobile');
				checkFlag = false;
				focusBefore = $('#mobile');
			}
		}else if(checkFlag && emailradioVal === 'email' && typeof p.email  == 'undefined'){
			if($('#email').val().length < 1){
				$('#update-message-text').text('請輸入電子信箱');
				$('#update-pop-message').modal('show');
				$('#update-pop-message-login-btn').attr('data-id','email');
				checkFlag = false;
				focusBefore = $('#email');
			}
		}
		if(checkFlag && p.mobile !== undefined && !verifyMobileExpression(p.mobile)){
			$('#update-message-text').text('手機號碼格式錯誤');
			$('#update-pop-message').modal('show');
			$('#update-pop-message-login-btn').attr('data-id','mobile');
			checkFlag = false;
			focusBefore = $('#mobile');
		}
		if(checkFlag && p.email !== undefined &&!verfiyEmailExpression(p.email)){
			$('#update-message-text').text('電子信箱格式錯誤');
			$('#update-pop-message').modal('show');
			$('#update-pop-message-login-btn').attr('data-id','email');
			checkFlag = false;
			focusBefore = $('#email');
		}
		if(checkFlag && emailradioVal === 'mobile' && !member.mobileVerified ){
			$('#update-message-text').text('請先驗證手機號碼');
			$('#update-pop-message').modal('show');
			$('#update-pop-message-login-btn').attr('data-id','mobile');
			checkFlag = false;
		}
		if(checkFlag && emailradioVal === 'email' && !member.emailVerified ){
			$('#update-message-text').text('請先驗證電子信箱');
			$('#update-pop-message').modal('show');
			$('#update-pop-message-login-btn').attr('data-id','email');
			checkFlag = false;
		}
		
		return checkFlag;
	}
	
	/**
	 * 更新使用者資料
	 */
	function updateUserInfo() {
		// mobile or email
		var emailradioVal = $('input[name=emailradio]:checked').val();
		var phoneNumber = $('#mobile').val();
		var emailAddr = $('#email').val();
		var p = {
			id : member.id,
			name : getUnmaskValue($('#name')),
			email : getUnmaskValue($('#email')),
			mobile : getUnmaskValue($('#mobile')),
			inform_method: emailradioVal
		};
		if(p.mobile !== member.mobile && p.inform_method==='mobile'){
			p.inform_method = '';
		}
		if(p.email !== member.email && p.inform_method==='email'){
			p.inform_method = '';
		}
		
		var checkFlag = contactEmailOrMobile();

		// console.log('user info param...' + JSON.stringify(p));
		if(checkFlag){
			RiAPI.run({
				type: 'POST',
				url: '/rest/user/updateUserInfo',
				data: p,
				loadSpin: true,
				success: function (resp) {
					if (resp.code < 0) {
						if(resp.code == -5) {
							closeEmailAndMobileDialog();
							showTimeoutMessage(resp);
							return;
						} else {
							$('#update-message-text').text(resp.text);
							$('#update-pop-message').modal('show');
						}
					} else {
						//成功
						member = resp.data;
						if(phoneNumber.indexOf('*') < 0){
							$('#mobile').data('value',maskPhoneNumber(phoneNumber));
						}
						
						if(emailAddr.indexOf('*') < 0){
							$('#email').data('value',maskEmailAddress(emailAddr));
						}

						// 手機號碼更新的狀況判斷
						if(p.mobile != member.mobile){
							// 文字和css
							$('#mobileverify').text('未驗證');
							$('#mobileverify').parent().removeClass('pass');
							// checkbox value
							$('#mobileradio').attr('checked',false);

							// 改變member變數verified boolean 值
							member.mobileVerified = false;

							if($('#mobilelabel').hasClass('active')){
								// 若原本手機驗證打勾則取消打勾
								$('#mobilelabel').removeClass('active');
								// 若email為已驗證則打勾
								if(member.emailVerified){
									$('#emaillabel').addClass('active');
								}
							}
						}else {
							if(member.mobileVerified){
								// 文字和css
								$('#mobileverify').text('已驗證');
								$('#mobileverify').parent().addClass('pass');
								$('#mobileradio').attr('checked','');
							}
						}

						if(p.email != member.email){
							$('#emailverify').text('未驗證');
							$('#emailverify').parent().removeClass('pass');
							$('#emailradio').attr('checked',false);
							member.emailVerified = false;
							if($('#emaillabel').hasClass('active')){
								$('#emaillabel').removeClass('active');
								if(member.mobileVerified){
									$('#mobilelabel').addClass('active');
								}
							}
						}else {
							if(member.emailVerified){
								// 文字和css
								$('#emailverify').text('已驗證');
								$('#emailverify').parent().addClass('pass');
								// checkbox value
								$('#emailradio').attr('checked','');
							}
						}

						if(phoneNumber === undefined || phoneNumber.length < 1){
							//$('#mobilelink').addClass('disabled');
							//$('#mobilelink').attr('href', 'javascript:void();');
						}else if(phoneNumber!== undefined && phoneNumber.length > 0) {
							$('#mobileSendlink').removeClass('disabled');
							$('#mobileSendlink').attr('href', 'javascript:verifyMobileOrEmail(\'mobile\');');
						}

						if(emailAddr === undefined || emailAddr.length < 1){
							//$('#emaillink').addClass('disabled');
							//$('#emaillink').attr('href', 'javascript:void();');
						}else if(emailAddr!== undefined || emailAddr.length > 0){
							$('#emailSendlink').removeClass('disabled');
							$('#emailSendlink').attr('href', 'javascript:verifyMobileOrEmail(\'email\');');
						}

						$('#update-pop-message-login-btn').attr('data-id','');
						$('#update-message-text').text('儲存成功');
						$('#update-pop-message').modal('show');


					}
				}
			});
		}
	}
	
	function confirmUpdatePopMessage(obj){
		var dataId = $(obj).attr('data-id');
		if(typeof dataId !='undefined' && dataId != ''){
			$('#update-pop-message').modal('hide');
			if(dataId=='email'){
				checkOpenVerifyEmailWithData();
			}else if(dataId=='mobile'){
				checkOpenVerifyMobileWithData()
			}
		}else{
			$('#update-pop-message').modal('hide');
		}
	}
	
	
	/**
	 * 驗證功能
	 * @param memberId -> 會員鍵值
	 * @param type "email", "mobile"
	 */
	function verifyMobileOrEmail(type) {

		var memberId = member.id;
		if(type === 'mobile' && member.mobile === undefined ){
			$('#message-text').text('請先輸入手機號碼，並點選儲存');
			$('#pop-message').modal('show');
			focusBefore = $('#mobile');
			return;
		}
		if(type === 'email' && member.email === undefined ){
			$('#message-text').text('請先輸入電子信箱，並點選儲存');
			$('#pop-message').modal('show');
			focusBefore = $('#email');
			return;
		}

		RiAPI.run({
			type : 'POST',
			url : '/rest/user/verifyMobileOrEmail',
			loadSpin : true,
			data : {inform_method : type ,memberId : memberId},
			success : function(resp) {
				// console.log('verify resp -> ' + JSON.stringify(resp));
				var $otpModal = '#otp-pop-message';
				var $msgTarget = '#otp-target';
				var $otpInform = '#otp-inform';
				if(resp.code === 0){

					var member = resp.data.member;
					if(type === 'mobile' && member.mobile.length === 0 ){
						$('#update-message-text').text('您尚未儲存手機號碼或無效的手機號碼');
						$('#update-pop-message').modal('show');
						return;
					}
					// 驗證碼發送目標,驗證碼發送方式
					var target, otpInformStr;
					if(type === 'mobile'){
						target = maskPhoneNumber(member.mobile);
						otpInformStr = '手機號碼';
					}else {
						target = maskEmailAddress(member.email);
						otpInformStr = '電子信箱';
					}
					// 等待過程中a tag not clickable, 字體改為黑色
					$('#resendOTPText').empty().append('已發送動態密碼至2分鐘後才能再次重新發送。');
					$('#resendOTPText').css('cssText','cursor: default;text-decoration:none !important;color:#414141 !important;');
					$('#resendOTPBtn').attr('href','javascript:void(0);');
					$('#resendOTPBtnWait').attr('data-time', 120);
					waitOTPsecInterval = setInterval(function () {
						checkOTPWaitTime();
					}, 1000);

					uuidcheck = resp.data.uuidcheck;
					informMethod = type;
					// 目標、方式
					$($msgTarget).text(target);
					$($otpInform).text(otpInformStr);
					$($otpModal).modal('show');

				}
			}
		});

	}

	/**
	 * 核對使用者輸入的動態證碼
	 */
	function loginByemailOrMobileLoginStepCheck() {
		var checkFlag = true;
		$('#verifyFailAlert').hide();
		var p = {
			"uuidcheck": uuidcheck,
			"checkCode": $('#otpcode').val(),
			"informMethod" : informMethod
		};
		p.verificationPath = "member";
		if (checkFlag && (typeof $('#otpcode').val() == 'undefined' || $('#otpcode').val() == '')) {
			$('#message-text').text('請輸入動態密碼');
			$('#pop-message').modal('show');
			checkFlag = false;
		}
		if (checkFlag) {
			RiAPI.run({
				type: 'POST',
				url: '/rest/user/emailOrMobileLoginStep/check',
				loadSpin: true,
				data: p,
				success: function (resp) {
					if (resp.code < 0) {
						$('#otpcode').val('');
						if(resp.code == -5) {
							closeEmailAndMobileDialog();
							showTimeoutMessage(resp);
							return;
						} else {
							$('#verifyFailAlert').empty().append('動態密碼輸入錯誤或動態密碼已失效');
							$('#verifyFailAlert').show();
						}
					} else {
						$('#otp-pop-message').modal('hide');

						// console.log('dom session member -> ' + JSON.stringify(member));
						member = resp.data;
						// console.log('after check  member -> ' + JSON.stringify(member));
						if(informMethod === 'mobile'){
							$('#mobileverify').text('已驗證');
							$('#mobileverify').parent().addClass('pass');
							//$('#mobilelink').addClass('disabled');
							$('#mobilelabel').addClass('active');
							$('#mobileradio').attr('checked',true);
							member.mobileVerified = true;
						}else {
							$('#emailverify').text('已驗證');
							$('#emailverify').parent().addClass('pass');
							//$('#emaillink').addClass('disabled');
							$('#emaillabel').addClass('active');
							$('#emailradio').attr('checked',true);
							member.emailVerified = true;
						}
					}
				}
			});
		}
	}

	function changeemailradio() {
		var emailradioVal = $('input[name=emailradio]:checked').val();
		if (emailradioVal == 'email') {
			$('#mobilelabel').removeClass('active');
			$('#emaillabel').addClass('active');

		}
		if (emailradioVal == 'mobile') {
			$('#emaillabel').removeClass('active');
			$('#mobilelabel').addClass('active');
		}
		contactEmailOrMobile();
	}
	
	//重新產生T-Fido QRcode
	function refreshTFidoQRcode(dataId){
		$('#tfido-overtime-message').modal('hide');
		$('.twqrshow').show();
		var uid = getUnmaskValue('#uid');
		var data = {
			uid: uid
		};
		RiAPI.run({
			type : 'POST',
			url : '/rest/user/notifyTFido',
			data: data,
			loadSpin : true,
			success : function(resp) {
				if (resp.code < 0) {
					$('.twqrshow').hide();
					if(resp.code == -5) {
						closeEmailAndMobileDialog();
						showTimeoutMessage(resp);
						return;
					} else {
						$('div.pop-error-message p').empty().append(resp.text);
						$('div.pop-error-message').show();
					}
				}else{
					var qc = tfidos.find(e => e.dataId == dataId);
					//清除舊的計時器
					clearInterval(qc.countId);
					//產生新的QRcode
					qc.qrcode.makeCode(resp.data.TFidoResp);
					$('#qrid'+dataId).val(resp.data.qrid);
					//產生新的計時器
					qc.countId = countQRcodeSecond($('#tfido-second'+dataId));
					$('#tfido-QRcode'+dataId).attr('title','請掃描 QRcode');
					autoCheckQRcode(dataId);
					$('#otp-pop-message-login-btn').attr('disabled','disabled');
					$('#tfido-overtime-btn').attr('onclick','javascript:refreshTFidoQRcode(\''+ dataId +'\');');
				}
			},
			error : function() {
				$('.twqrshow').hide();
				$('div.pop-error-message p').empty().append('TW FidO認證失敗。');
				$('div.pop-error-message').show();
			}
		});
	}	
	
	//製作T-Fido QRcode
	function createTFidoQRcode(obj){
		//div中包含input會造成二次觸發事件
		if(event) event.preventDefault();
		var dataId = $(obj).attr('data-id');
		
		$('.twqrshow').show();
		//若已有生成QRcode，則直接顯示
		if($('#tfido-QRcode'+dataId).find('img').length > 0){
			addClassChecked(obj);
			return;
		}
		var uid = getUnmaskValue('#uid');
		var birthdate = transferBirthDateToAD(getUnmaskValue('#birthdate'));
		var checkData = true;
		if(uid == null || uid == ''){
			$('div.pop-error-message p').empty().append('請輸入身分證字號');
			checkData = false;
		}else if(!verifyExpression(uid)){
			$('div.pop-error-message p').empty().append('身分證字號格式不正確');
			checkData = false;
		}else if(birthdate == null || birthdate == ''){
			$('div.pop-error-message p').empty().append('請輸入生日');
			checkData = false;
		}else if(!verifyBirthDateExpression(birthdate)){
			$('div.pop-error-message p').empty().append('生日格式不正確!');
			checkData = false;
		}
		if(checkData == false){
			$('div.pop-error-message').show();
			return;
		}
		var data = {
			uid: uid
		};
		RiAPI.run({
			type : 'POST',
			url : '/rest/user/notifyTFido',
			data: data,
			loadSpin : true,
			success : function(resp) {
				if (resp.code < 0) {
					addClassChecked(obj);
					$('.twqrshow').hide();
					$('.no-t-fido').show();
					$('.has-t-fido').hide();
					if(resp.code == -5) {
						closeEmailAndMobileDialog();
						showTimeoutMessage(resp);
						return;
					} else {
						$('div.pop-error-message p').empty().append(resp.text);
						$('div.pop-error-message').show();
					}
				}else{
					//產生QRcode
					var qc = new QRCode(document.getElementById('tfido-QRcode'+dataId), {
						text: resp.data.TFidoResp,
						width : 190,
						height : 190
					});
					$('#qrid'+dataId).val(resp.data.qrid);
					//計時一分鐘
					var countId = countQRcodeSecond($('#tfido-second'+dataId));
					// 將QRcode及計時器存入陣列，以便重新產生
					tfidos.push({
						dataId: dataId,
						qrcode: qc,
						countId: countId
					});
					addClassChecked(obj);
					$('.no-t-fido').hide();
					$('.has-t-fido').show();
					$('#uid, #birthdate').attr('disabled','disabled');
					$('#tfido-QRcode'+dataId).attr('title','請掃描 QRcode');
					autoCheckQRcode(dataId);
					$('#otp-pop-message-login-btn').attr('disabled','disabled');
					$('#tfido-overtime-btn').attr('onclick','javascript:refreshTFidoQRcode(\''+ dataId +'\');');
				}
			}
		});
	}	
	
	//120秒失敗，每5秒檢查
	function autoCheckQRcode(type){
		var countConfirmTFido = 0; // 120 sec / 5sec = 24 times
		var prIdEncode = $('#apply').attr('prid-list');
		qrcodeIntervalObj = window.setInterval(function(){
			//TW FidO
			var checkFlag = true;
			var qrid =  $('#qrid'+type).val();
			var p = {
				"uid" : getUnmaskValue('#uid'),
				"birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
				"scope" : "basic",
				"qrid" : qrid
			};
			p.verificationPath = "member";
			RiAPI.run({
				type : 'POST',
				url : '/rest/user/confirmTFido',
				data: p,
				loadSpin : false,
				success : function(resp) {
					if (resp.code < 0) {
						countConfirmTFido = countConfirmTFido + 1;
						//console.log('countConfirmTFido = '+ countConfirmTFido);
						if(countConfirmTFido>=24){
							clearInterval(qrcodeIntervalObj);
							//$('#tfido-overtime-message-text').text('TW FidO認證已逾兩分鐘，請重新操作。');
							//$('#tfido-overtime-message').modal('show');
							$('div.pop-error-message p').empty().append('TW FidO認證已逾兩分鐘，請重產生QRcode。');
							$('div.pop-error-message').show();
						}
					}else{
						clearInterval(qrcodeIntervalObj);
						emailOrMobileMessageUpdate('tfido')
					}
				}
			});
		},5000);
	}	
	
	//倒數60秒
	function countQRcodeSecond(obj){
		var second = 59;
		var countId;
		return countId = window.setInterval(function(){
			obj.html(second);
			if (second == 0){
				clearInterval(countId);
			}
			second--;
		},1000);
	}
	
	function addClassChecked(obj){
		//div中包含input會造成二次觸發事件
		if(event) event.preventDefault();

		var dataId = $(obj).attr('data-id');
		clearInterval(qrcodeIntervalObj);
		$('#otp-pop-message-login-btn').removeAttr('disabled');
		$('div.form-group').removeClass('checked');
		$(obj).addClass('checked');
		$(obj).find('input[name=verification-level]').prop('checked','checked');
		$('div.verify').hide();
		var type = $(obj).data('type');
		if(type != null && type != ''){
			$(obj).parent().find('div.verify[data-type='+type+']').show();
		}
        /* if(type=='digital'||type=='business'){
	    		checkHiCOSCardPlugin();
	    } */
	    if(type=='health'){
			//checkNHICardPlugin();
			refreshCaptchaImage(dataId);
		}
	}	
	
	function checkOpenVerifyEmail(){
		$('#new_email').val('');
		$('#new_email').attr('data-value','');
		$('#new_mobile').val('');
		$('#new_mobile').attr('data-value','');
		$('#new_email_checkCode').val('');
		$('#new_mobile_checkCode').val('');
		$('#change-email-pop-message').modal('show');
		$('#exampleModalEmailTitle').text(member.email==null?'新增／驗證聯絡方式':'變更／驗證聯絡方式');
		$('#sendEmailOTPText').addClass('link');
		$('#resendEmailOTPText').removeClass('link');
		$('#emailReSendLink').hide();
		$('div.pop-error-message').hide();
		$('div.verify').hide();
		changeEmailOrMobile('email');
		initVerifyValueWithEmail();
	}
	
	function checkOpenVerifyEmailWithData(){
		$('#new_email').val($('#email').attr('data-value'));
		$('#new_mobile').val('');
		$('#new_email_checkCode').val('');
		$('#new_mobile_checkCode').val('');
		$('#change-email-pop-message').modal('show');
		$('#exampleModalEmailTitle').text(member.email==null?'新增／驗證聯絡方式':'變更／驗證聯絡方式');
		$('#sendEmailOTPText').addClass('link');
		$('div.pop-error-message').hide();
		$('div.verify').hide();
		changeEmailOrMobile('email');
		initVerifyValueWithEmail();
	}	
	
	function changeAgentPopWin(obj){
		var boxId = $(obj).attr('data-id');
		$('#agent-step1-next-btn').attr('data-id',boxId);
		$('#agent_uid').val('');
		$('#agent_uid').attr('data-value','');
		$('#agent_birthdate').val('');
		$('#agent_birthdate').attr('data-value','');
		$('#change-agent-pop-message').modal('show');
	}	
	
	function cancelAgentPopWin(obj){
		var boxId = $(obj).attr('data-id');
		$('#cancel-agent-btn').attr('data-id',boxId);
		$('#cancel-agent-pop-message').modal('show');
	}
	
	function cancelAgentConfirmYes(obj){
		var boxId = $(obj).attr('data-id');
		console.log(boxId);
		$('#cancel-agent-pop-message').modal('hide');
		RiAPI.run({
			type : 'POST',
			url : '/rest/user/cancelBoxAgentData',
			loadSpin : true,
			data : {boxId: boxId},
			success : function(resp) {
				if (resp.code < 0) {
					//resp.text
					$('div.pop-error-message p').empty().append(resp.text);
					$('div.pop-error-message').show();
				}else{
					$('#not-agent'+boxId).show();
					$('#barcode-box'+boxId).show();
					$('#barcode-description'+boxId+' .not-agent').show();
					$('#barcode-description'+boxId+' .in-agent').hide();
					$('#in-agent-text'+boxId).empty().hide();
				}
			}
		});
	}
	
	//初始化驗證欄位
	function initVerifyValueWithEmail() {
		$('#change-email-pop-message #digital-pin').val('');
		$('#change-email-pop-message #fic-pin').val('');
		$('#change-email-pop-message #fch-pin').val('');
		$('#change-email-pop-message #business-pin').val('');
		$('#change-email-pop-message #health-pwd-email').val('');
		$('#change-email-pop-message #otp-email').val('');
		$('#change-email-pop-message #tfido-QRcodeemail').empty();
		$('#resendEmailOTPMsg').hide();
		$('#email-step1').show();
		$('#email-step2').hide();
	}
	
	function checkOpenVerifyMobile(){
		$('#new_email').val('');
		$('#new_email').attr('data-value','');
		$('#new_mobile').val('');
		$('#new_mobile').attr('data-value','');
		$('#new_email_checkCode').val('');
		$('#new_mobile_checkCode').val('');
		$('#change-mobile-pop-message').modal('show');
		$('#exampleModalMobileTitle').text(member.mobile==null?'新增／驗證聯絡方式':'變更／驗證聯絡方式');
		$('#sendMobileOTPText').addClass('link');
		$('#resendMobileOTPText').removeClass('link');
		$('#mobileReSendLink').hide();
		$('div.pop-error-message').hide();
		$('div.verify').hide();
		changeEmailOrMobile('mobile');
		initVerifyValueWithMobile();
	}
	
	function checkOpenVerifyMobileWithData(){
		$('#new_email').val('');
		$('#new_mobile').val($('#mobile').attr('data-value'));
		$('#new_email_checkCode').val('');
		$('#new_mobile_checkCode').val('');
		$('#change-mobile-pop-message').modal('show');
		$('#exampleModalMobileTitle').text(member.mobile==null?'新增／驗證聯絡方式':'變更／驗證聯絡方式');
		$('#sendMobileOTPText').addClass('link');
		$('div.pop-error-message').hide();
		$('div.verify').hide();
		changeEmailOrMobile('mobile');
		initVerifyValueWithMobile();
	}	
	
	//初始化驗證欄位
	function initVerifyValueWithMobile() {
		$('#change-mobile-pop-message #digital-pin').val('');
		$('#change-mobile-pop-message #fic-pin').val('');
		$('#change-mobile-pop-message #fch-pin').val('');
		$('#change-mobile-pop-message #business-pin').val('');
		$('#change-mobile-pop-message #health-pwd-mobile').val('');
		$('#change-mobile-pop-message #otp-mobile').val('');
		$('#change-mobile-pop-message #tfido-QRcodemobile').empty();
		$('#resendMobileOTPMsg').hide();
		$('#mobile-step1').show();
		$('#mobile-step2').hide();
	}
	
	function emailOrMobileMessageSend(method){
		$('div.pop-error-message').hide();
		if(method=='email'){
			var email = getUnmaskValue('#new_email');
			if(typeof email =='undefined' || email==''){
				$('div.pop-error-message p').empty().append('請輸入電子信箱。');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_email');
				return;
			}
			if(!verfiyEmailExpression(email)){
				$('div.pop-error-message p').empty().append('電子信箱格式不正確。');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_email');
				return;
			}

			var oldEmail = getUnmaskValue($('#email'));
			console.log(member.emailVerified)
			if(email == oldEmail && member.emailVerified) {
				$('div.pop-error-message p').empty().append('您輸入的電子信箱與會員專區的電子信箱相同，請輸入新的電子信箱');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_email');
				return;
			}


			//id="new_email"
			$('#sendEmailOTPText').removeClass('link');
			$('#emailReSendLink').hide();
			
			var data = {
				email: email
			};
			if($('#new_email').val()!=''){
				RiAPI.run({
					type : 'POST',
					url : '/rest/user/emailOrMobileMessage/send',
					data: data,
					loadSpin : true,
					success : function(resp) {
						if (resp.code < 0) {
							if(resp.code == -5) {
								closeEmailAndMobileDialog();
								showTimeoutMessage(resp);
								return;
							} else {
								$('div.pop-error-message p').empty().append(resp.text);
								$('div.pop-error-message').show();
							}
						}else{
							$('#uuidcheckforCheckCode').val(resp.data.uuidcheckforCheckCode);
							//$('#emailSendLink').attr('href','javascript:void(0);');
							$('#resendEmailOTPMsg').attr('data-time',120);
							$('#resendEmailOTPMsg').show();
							waitEmailorMobileOTPsecInterval = setInterval(function (type) {
								checkEmailOrMobileOTPWaitTime(type);
							}, 1000,'email');
						}
					}
				});
			}else{
				$('div.pop-error-message p').empty().append('請輸入電子信箱');
				$('div.pop-error-message').show();
				$('#sendEmailOTPText').addClass('link')
				focusNewEmailOrMobile('#new_email');
			}			
		}else if(method=='mobile'){
			var mobile = getUnmaskValue('#new_mobile');
			if(typeof mobile =='undefined' || mobile==''){
				$('div.pop-error-message p').empty().append('請輸入手機號碼。');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_mobile');
				return;
			}
			
			if(!verifyMobileExpression(mobile)){
				$('div.pop-error-message p').empty().append('手機號碼格式不正確。');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_mobile');
				return;
			}

			var oldMobile = getUnmaskValue($('#mobile'));
			console.log(member.mobileVerified)
			if(mobile == oldMobile && member.mobileVerified) {
				$('div.pop-error-message p').empty().append('您輸入的手機號碼與會員專區的手機號碼相同，請輸入新的手機號碼');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_email');
				return;
			}
			
			//id="new_mobile"
			$('#sendMobileOTPText').removeClass('link');
			$('#mobileReSendLink').hide();
			
			var data = {
				mobile: mobile
			};
			if($('#new_mobile').val()!=''){
				RiAPI.run({
					type : 'POST',
					url : '/rest/user/emailOrMobileMessage/send',
					data: data,
					loadSpin : true,
					success : function(resp) {
						if (resp.code < 0) {
							if(resp.code == -5) {
								closeEmailAndMobileDialog();
								showTimeoutMessage(resp);
								return;
							} else {
								$('div.pop-error-message p').empty().append(resp.text);
								$('div.pop-error-message').show();
							}
						}else{
							$('#uuidcheckforCheckCode').val(resp.data.uuidcheckforCheckCode);
							//$('#mobileSendLink').attr('href','javascript:void(0);');
							$('#resendMobileOTPMsg').attr('data-time',120);
							$('#resendMobileOTPMsg').show();
							waitEmailorMobileOTPsecInterval = setInterval(function (type) {
								checkEmailOrMobileOTPWaitTime(type);
							},1000, 'mobile');
						}
					}
				});				
			}else{
				$('div.pop-error-message p').empty().append('請輸入手機號');
				$('div.pop-error-message').show();
				$('#addMobileOTPText').removeClass('link');
				focusNewEmailOrMobile('#new_mobile');
			}
		}
	}
	
	function emailOrMobileMessageCheck(checkCode, type){
		if(checkCode!=null&&checkCode!=''){
			var data = {
				uuidcheckforCheckCode: $('#uuidcheckforCheckCode').val(),
				checkforCheckCode:checkCode
			};
			var showVerifyView = false;
			RiAPI.run({
				type : 'POST',
				url : '/rest/user/emailOrMobileMessage/check',
				data: data,
				loadSpin : true,
				showVerifyView : showVerifyView,
				complete : function(xhr, status) {
					if(showVerifyView == true) {
						if(type == 'email') {
							$('#email-step1').hide();
							$('#email-step2').show();
							if(roleType != '0.5') {
								if($('#change-email-pop-message .digital-id-card').is(':visible') == true) {				
									$('#change-email-pop-message .digital-id-card.radio').trigger('click');
								} else {
									// 在完成上一個 ajax 間隔 450 呼叫 避免 loaddSpin 無效果
									setTimeout(function(){
										$('#change-email-pop-message .t-fido.radio').delay(400).trigger('click');
									},400);
								}
							} else {
								$('#change-email-pop-message .business-id-card.radio').trigger('click');
							}
						} else if(type == 'mobile') {
							$('#mobile-step1').hide();
							$('#mobile-step2').show();
							if(roleType != '0.5') {
								if($('#change-mobile-pop-message .digital-id-card').is(':visible') == true) {				
									$('#change-mobile-pop-message .digital-id-card.radio').trigger('click');
								} else {
									setTimeout(function(){
										$('#change-mobile-pop-message .t-fido.radio').trigger('click');
									},400);
								}
							} else {
								$('#change-mobile-pop-message .business-id-card.radio').trigger('click');
							}
						}
						
					} 
				},
				success : function(resp) {
					if (resp.code < 0) {
						$('#new_email_checkCode').val('');
						$('#new_mobile_checkCode').val('');
						if(resp.code == -1209){
							$('div.pop-error-message p').empty().append('驗證碼輸入錯誤或失效');
							$('div.pop-error-message').show();
						} else if(resp.code == -5) {
							closeEmailAndMobileDialog();
							showTimeoutMessage(resp);
							return;
						} else{
							$('div.pop-error-message p').empty().append('系統錯誤，請重新操作！');
							$('div.pop-error-message').show();
						}
					}else{
						showVerifyView = true;
					}
				}
			});
		}
	}
	
	function emailOrMobileMessageUpdate(verificationType){
		RiAPI.run({
			type : 'POST',
			url : '/rest/user/emailOrMobileMessage/update',
			data: {
				verificationType: verificationType,
			},
			loadSpin : true,
			success : function(resp) {
				if (resp.code < 0) {
					if(resp.code == -5) {
						closeEmailAndMobileDialog();
						showTimeoutMessage(resp);
						return;
					} else {
						$('#message-text').text('個人資料更新失敗，請重新操作');
						$('#pop-message').modal('show');
					}
				}else{
					$('#change-email-pop-message').modal('hide');
					$('#change-mobile-pop-message').modal('hide');
					if(resp.data.session_checkLevel!='undefined'){
						if(resp.data.session_checkLevel=='email'){
							$('#emailverify').parent().addClass('pass');
							$('#emailverify').empty().append('已驗證');
							$('#email').val(resp.data.userInfo.maskMember.email);
							$('#email').attr('data-value',resp.data.member.email);
							$('#emaillink').text('變更電子信箱');
							member.emailVerified = true;
							member.email = resp.data.member.email;
						}else if(resp.data.session_checkLevel=='mobile'){
							$('#mobileverify').parent().addClass('pass');
							$('#mobileverify').empty().append('已驗證');
							$('#mobile').val(resp.data.userInfo.maskMember.mobile);
							$('#mobile').attr('data-value',resp.data.member.mobile);	
							$('#mobilelink').text('變更手機號碼');
							member.mobileVerified = true;
							member.email = resp.data.member.mobile;
						}
					}	
				}
			}
		});
	}
	
	function verificationData(type) {
		var verificationlevel;
		
		if(type == 'email') {
			verificationlevel = $('#change-email-pop-message').find('input[name=verification-level]:checked').val();
			if(verificationlevel==0){
				//自然人憑證
				var checkFlag = true;
				var pin =  $('#change-email-pop-message #digital-pin').val();
				if(pin == null || pin == ''){
					$('div.pop-error-message p').empty().append('請輸入PIN碼。');
					$('div.pop-error-message').show();
					$('#change-email-pop-message #digital-pin').focus();
					return;
				}
				//在client端做自然人憑證pkcs7, makeSignature function in certLogin.js
				makeSignature(pin, function(ret){
					if(ret.ret_code!=0){
						$('div.pop-error-message p').empty().append(ret.errorMsg);
						$('div.pop-error-message').show();
						return;
					}
					var pkcs7 = ret.signature;
					var p = {
						"uid" : getUnmaskValue('#uid'),
						"birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
						"scope" : "basic",
						"pkcs7" : pkcs7
					};
					p.verificationPath = "member";
					if(checkFlag){
						RiAPI.run({
							type : 'POST',
							url : '/rest/user/verifyCert',
							loadSpin : true,
							data : p,
							success : function(resp) {
								if (resp.code < 0) {
									if(resp.code == -5) {
										closeEmailAndMobileDialog();
										showTimeoutMessage(resp);
										return;
									} else {
										$('div.pop-error-message p').empty().append('自然人憑證驗證失敗，請重新操作。');
										$('div.pop-error-message').show();
									}
								} else {
									emailOrMobileMessageUpdate('cer')
								}
							},
							error : function() {
								$('div.pop-error-message p').empty().append('自然人憑證驗證失敗，請重新操作。');
								$('div.pop-error-message').show();
							}
						});
					}
				});
			}else if(verificationlevel==0.1){
				//晶片金融卡
				var checkFlag = true;
				var pin =  $('#change-email-pop-message #fic-pin').val();
				if(pin == null || pin == ''){
					$('div.pop-error-message p').empty().append('請輸入密碼。');
					$('div.pop-error-message').show();
					$('#change-email-pop-message #fic-pin').focus();
					return;
				}
				
                RiAPI.run({
                    type : 'POST',
                    url : '/rest/user/ficAtmLogin',
                    loadSpin : true,
                    data : {"uid" : getUnmaskValue('#uid')},
                    success : function(resp) {
                        if (resp.code < 0) {
                            //登入失敗
                            //showPopMessage('晶片金融卡驗證失敗，請重新操作。');
							$('div.pop-error-message p').empty().append('晶片金融卡驗證失敗，請重新操作。');
							$('div.pop-error-message').show();
                        } else {
                        		mydataTWCALib.ATMVerifyInvoke(
                        				pin,
                        				resp.data.BusinessNo,
                        				resp.data.ApiVersion,
                        				resp.data.HashKeyNo,
                        				resp.data.VerifyNo,
                        				resp.data.Token,
                        				resp.data.IdentifyNo,
                        				resp.data.proxyURL,
                        				ATMVerifyInvokeCallback);
                        }
                    },
                    error : function() {
                        //showPopMessage('晶片金融卡功能暫時無法使用，請改用其他驗證方式。');
						$('div.pop-error-message p').empty().append('晶片金融卡功能暫時無法使用，請改用其他驗證方式。');
						$('div.pop-error-message').show();
                    }
                });
				
			}else if(verificationlevel==0.2){
				//硬體金融憑證
				var checkFlag = true;
				var pin =  $('#change-email-pop-message #fch-pin').val();
				if(pin == null || pin == ''){
					$('div.pop-error-message p').empty().append('請輸入PIN碼。');
					$('div.pop-error-message').show();
					$('#change-email-pop-message #fch-pin').focus();
					return;
				}
                RiAPI.run({
                    type : 'POST',
                    url : '/rest/user/fchInitParam',
                    loadSpin : true,
                    data : {"uid" : getUnmaskValue('#uid')},
                    success : function(resp) {
                        if (resp.code < 0) {
                            //登入失敗
                            //showPopMessage('硬體金融憑證驗證失敗，請重新操作。');
    						$('div.pop-error-message p').empty().append('硬體金融憑證驗證失敗，請重新操作。');
    						$('div.pop-error-message').show();
                        } else {
                            mydataTWCALib.HWSignPKCS7(
                                resp.data.VerifyNo,
                                pin,
                                resp.data.proxyURL,
                                HWSignPKCS7Callback);
                        }
                    },
                    error : function() {
                        //showPopMessage('硬體金融憑證功能暫時無法使用，請改用其他驗證方式。');
						$('div.pop-error-message p').empty().append('硬體金融憑證功能暫時無法使用，請改用其他驗證方式。');
						$('div.pop-error-message').show();
                    }
                });
			}else if(verificationlevel==0.5){
				//工商憑證
				var checkFlag = true;
				var pin =  $('#change-email-pop-message #business-pin').val();
				if(pin == null || pin == ''){
					$('div.pop-error-message p').empty().append('請輸入PIN碼。');
					$('div.pop-error-message').show();
					$('#change-email-pop-message #business-pin').focus();
					return;
				}
				//在client端做工商憑證pkcs7, makeSignature function in certLogin.js
				makeSignature(pin, function(ret){
					if(ret.ret_code!=0){
						$('div.pop-error-message p').empty().append(ret.errorMsg);
						$('div.pop-error-message').show();
						return;
					}
					var pkcs7 = ret.signature;
					var p = {
						"scope" : "basic",
						"pkcs7" : pkcs7
					};
					p.verificationPath = "member";
					if(checkFlag){
						RiAPI.run({
							type : 'POST',
							url : '/rest/user/verifyMOECA',
							loadSpin : true,
							data : p,
							success : function(resp) {
								if (resp.code < 0) {
									if(resp.code == -5) {
										closeEmailAndMobileDialog();
										showTimeoutMessage(resp);
										return;
									} else {
										$('div.pop-error-message p').empty().append('工商憑證驗證失敗，請重新操作。');
										$('div.pop-error-message').show();
									}
								} else {
									emailOrMobileMessageUpdate('moeaca')
								}
							},
							error : function() {
								$('div.pop-error-message p').empty().append('工商憑證驗證失敗，請重新操作。');
								$('div.pop-error-message').show();
							}
						});
					}
				});
			}else if(verificationlevel==1){
				//TW FidO
				var checkFlag = true;
				var qrid =  $('#qrid'+type).val();
				var p = {
					"uid" : getUnmaskValue('#uid'),
					"birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
					"scope" : "basic",
					"qrid" : qrid
				};
				p.verificationPath = "member";
				RiAPI.run({
					type : 'POST',
					url : '/rest/user/confirmTFido',
					data: p,
					loadSpin : true,
					success : function(resp) {
						if (resp.code < 0) {
							if(resp.code == -5) {
								closeEmailAndMobileDialog();
								showTimeoutMessage(resp);
								return;
							} else {
								$('div.pop-error-message p').empty().append('TW FidO認證失敗，請重新操作。');
								$('div.pop-error-message').show();
							}
						}else{
							emailOrMobileMessageUpdate('tfido')
						}
					}
				});
			}else if(verificationlevel==2){
				//健保卡
				var checkFlag = true;
				var pwd =  $('#health-pwd-email').val();
				if(pwd == null || pwd == ''){
					$('div.pop-error-message p').empty().append('請輸入註冊密碼');
					$('div.pop-error-message').show();
					$('#health-pwd-email').focus();
					checkFlag = false;
					return;
				}
				
				var captcha = $('#captcha-email').val();
				if(captcha == null || captcha.length == 0) {
					$('div.pop-error-message p').empty().append("請輸入驗證碼");
					$('div.pop-error-message').show();
					$('#captcha-email').focus();
					checkFlag = false;
					return;
				}
				if(healthCardCanVerify){
					// 檢驗健保卡，verifyHealth function in fragment/login-health
					verifyHealth(pwd, function(ret){
						var p = {
							"uid" : getUnmaskValue('#uid'),
							"birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
							"scope" : "basic",
							"captcha" : captcha.toUpperCase(),
							//"captchaKeyVal" : "email"
	 					};
						p.health = ret;
						p.verificationPath = "member";
						if(checkFlag){
							RiAPI.run({
								type : 'POST',
								url : '/rest/user/verifyNHICard',
								loadSpin : true,
								data : p,
								success : function(resp) {
									if (resp.code < 0) {
										refreshCaptchaImage('email');
										if(resp.code == -5) {
											closeEmailAndMobileDialog();
											showTimeoutMessage(resp);
											return;
										} else {
											$('div.pop-error-message p').empty().append(resp.text);
											$('div.pop-error-message').show();
										}
									} else {
										emailOrMobileMessageUpdate('nhi')
									}
								},
								error : function() {
									$('div.pop-error-message p').empty().append('健保卡驗證失敗，請重新操作。');
									$('div.pop-error-message').show();
								}
							});
						}
					});
				}else{
					$('div.pop-error-message p').empty().append("未安裝健保卡檢測元件，請重新確認或安裝");
					$('div.pop-error-message').show();
					return;	
				}
			}else if(verificationlevel==2.1){
				//軟體金融憑證
                RiAPI.run({
                    type : 'POST',
                    url : '/rest/user/fcsInitParam',
                    loadSpin : true,
                    data : {"uid" : getUnmaskValue('#uid')},
                    success : function(resp) {
                        if (resp.code < 0) {
                            //登入失敗
                            //showPopMessage('軟體金融憑證驗證失敗，請重新操作。');
							$('div.pop-error-message p').empty().append('軟體金融憑證驗證失敗，請重新操作。');
							$('div.pop-error-message').show();
                        } else {
                            mydataTWCALib.SWSignPKCS7(
                                resp.data.VerifyNo,
                                pin,
                                resp.data.MemberNo,
                                SWSignPKCS7Callback);
                        }
                    },
                    error : function() {
                        //showPopMessage('軟體金融憑證功能暫時無法使用，請改用其他驗證方式。');
						$('div.pop-error-message p').empty().append('軟體金融憑證功能暫時無法使用，請改用其他驗證方式。');
						$('div.pop-error-message').show();
                    }
                });
			}else if(verificationlevel==4){
				//動態密碼
				loginByemailOrMobileLoginStepCheck(type);
			}
		} else if (type == 'mobile') {
			verificationlevel = $('#change-mobile-pop-message').find('input[name=verification-level]:checked').val();
			if(verificationlevel==0){
				//自然人憑證
				var checkFlag = true;
				var pin =  $('#change-mobile-pop-message #digital-pin').val();
				if(pin == null || pin == ''){
					$('div.pop-error-message p').empty().append('請輸入PIN碼');
					$('div.pop-error-message').show();
					$('#change-mobile-pop-message #digital-pin').focus();
					return;
				}
				//在client端做自然人憑證pkcs7, makeSignature function in certLogin.js
				makeSignature(pin, function(ret){
					if(ret.ret_code!=0){
						$('div.pop-error-message p').empty().append(ret.errorMsg);
						$('div.pop-error-message').show();
						return;
					}
					var pkcs7 = ret.signature;
					var p = {
						"uid" : getUnmaskValue('#uid'),
						"birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
						"scope" : "basic",
						"pkcs7" : pkcs7
					};
					p.verificationPath = "member";
					if(checkFlag){
						RiAPI.run({
							type : 'POST',
							url : '/rest/user/verifyCert',
							loadSpin : true,
							data : p,
							success : function(resp) {
								if (resp.code < 0) {
									if(resp.code == -5) {
										closeEmailAndMobileDialog();
										showTimeoutMessage(resp);
										return;
									} else {
										$('div.pop-error-message p').empty().append('自然人憑證驗證失敗，請重新操作。');
										$('div.pop-error-message').show();
									}
								} else {
									emailOrMobileMessageUpdate('cer');
								}
							},
							error : function() {
								$('div.pop-error-message p').empty().append('自然人憑證驗證失敗，請重新操作。');
								$('div.pop-error-message').show();
							}
						});
					}
				});
			}else if(verificationlevel==0.5){
				//工商憑證
				var checkFlag = true;
				var pin =  $('#change-mobile-pop-message #business-pin').val();
				if(pin == null || pin == ''){
					$('div.pop-error-message p').empty().append('請輸入PIN碼');
					$('div.pop-error-message').show();
					$('#change-mobile-pop-message #business-pin').focus();
					return;
				}
				//在client端做工商憑證pkcs7, makeSignature function in certLogin.js
				makeSignature(pin, function(ret){
					if(ret.ret_code!=0){
						$('#change-mobile-pop-message').modal('hide');
						$('#message-text').text(ret.errorMsg);
						$('#pop-message').modal('show');
						return;
					}
					var pkcs7 = ret.signature;
					var p = {
						"scope" : "basic",
						"pkcs7" : pkcs7
					};
					p.verificationPath = "member";
					if(checkFlag){
						RiAPI.run({
							type : 'POST',
							url : '/rest/user/verifyMOECA',
							loadSpin : true,
							data : p,
							success : function(resp) {
								if (resp.code < 0) {
									if(resp.code == -5) {
										closeEmailAndMobileDialog();
										showTimeoutMessage(resp);
										return;
									} else {
										$('div.pop-error-message p').empty().append('工商憑證驗證失敗，請重新操作。');
										$('div.pop-error-message').show();
									}
								} else {
									emailOrMobileMessageUpdate('moeaca');
								}
							},
							error : function() {
								$('div.pop-error-message p').empty().append('工商憑證驗證失敗，請重新操作。');
								$('div.pop-error-message').show();
							}
						});
					}
				});
			}else if(verificationlevel==1){
				//TW FidO
				var checkFlag = true;
				var qrid =  $('#qrid'+type).val();
				var p = {
					"uid" : getUnmaskValue('#uid'),
					"birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
					"scope" : "basic",
					"qrid" : qrid
				};
				p.verificationPath = "member";
				RiAPI.run({
					type : 'POST',
					url : '/rest/user/confirmTFido',
					data: p,
					loadSpin : true,
					success : function(resp) {
						if (resp.code < 0) {
							if(resp.code == -5) {
								closeEmailAndMobileDialog();
								showTimeoutMessage(resp);
								return;
							} else {
								$('div.pop-error-message p').empty().append('TW FidO認證失敗，請重新操作。');
								$('div.pop-error-message').show();
							}
						}else{
							emailOrMobileMessageUpdate('tfido');
						}
					}
				});
			}else if(verificationlevel==2){
				//健保卡
				var checkFlag = true;
				var pwd =  $('#health-pwd-mobile').val();
				if(pwd == null || pwd == ''){
					$('div.pop-error-message p').empty().append('請輸入註冊密碼');
					$('div.pop-error-message').show();
					$('#health-pwd-mobile').focus();
					checkFlag = false;
					return;
				}
				
				var captcha = $('#captcha-mobile').val();
				if(captcha == null || captcha.length == 0) {
					$('div.pop-error-message p').empty().append("請輸入驗證碼");
					$('div.pop-error-message').show();
					checkFlag = false;
					$('#captcha-mobile').focus();
					return;
				}
				if(healthCardCanVerify){
					// 檢驗健保卡，verifyHealth function in fragment/login-health
					verifyHealth(pwd, function(ret){
						var p = {
							"uid" : getUnmaskValue('#uid'),
							"birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
							"scope" : "basic",
							"captcha" : captcha.toUpperCase(),
							//"captchaKeyVal" : 'mobile'
						};
						p.health = ret;
						p.verificationPath = "member";
						if(checkFlag){
							RiAPI.run({
								type : 'POST',
								url : '/rest/user/verifyNHICard',
								loadSpin : true,
								data : p,
								success : function(resp) {
									if (resp.code < 0) {
										refreshCaptchaImage('mobile');
										if(resp.code == -5) {
											closeEmailAndMobileDialog();
											showTimeoutMessage(resp);
											return;
										} else {
											$('div.pop-error-message p').empty().append(resp.text);
											$('div.pop-error-message').show();
										}
									} else {
										emailOrMobileMessageUpdate('nhi');
									}
								},
								error : function() {
									$('div.pop-error-message p').empty().append('健保卡驗證失敗，請重新操作。');
									$('div.pop-error-message').show();
								}
							});
						}
					});
				}else{
					$('div.pop-error-message p').empty().append("未安裝健保卡檢測元件，請重新確認或安裝");
					$('div.pop-error-message').show();
					return;	
				}
			}else if(verificationlevel==4){
				//動態密碼
				loginByemailOrMobileLoginStepCheck(type);
			}
		}
	}
	
	function ATMVerifyInvokeCallback(code, msg, reserved, data){
		if(code==0){
			var dataObj = JSON.parse(data);
			var strContent = mydataTWCALib.verifyNo + dataObj.atm_sn;
			mydataTWCALib.ATMSignPKCS7(strContent,ATMSignPKCS7Callback);
		}else{
			var check = true;
			if(code=='2038001'){
				showPopMessage('未偵測到讀卡機或晶片卡。');
				check = false;
			}
			if(code=='2038002'){
				showPopMessage('晶片卡密碼錯誤。');
				check = false;
			}
			if(code=='2038005'){
				showPopMessage('晶片卡已鎖住。');
				check = false;
			}
			if(check){
				//showPopMessage('晶片金融卡：'+ msg);
				showPopMessage('驗證失敗，請洽原發卡銀行客服詢問。');
			}
		}
	}
	
	function ATMSignPKCS7Callback(code, msg, reserved, data){
		if(code==0){
			//上傳server登入驗證
            var p = {
				"uid" : getUnmaskValue('#uid'),
				"birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
				"scope" : "basic",
                "signCer" : data,
                "verifyNo" : mydataTWCALib.verifyNo,
                "token" : mydataTWCALib.token,
                "isDoubleVerify": false
            };

            RiAPI.run({
                type : 'POST',
                url : '/rest/user/verifyFic',
                loadSpin : true,
                data : p,
                success : function(resp) {
                    if (resp.code < 0) {
                        //登入失敗
                        //showPopMessage('晶片金融卡驗證失敗，請重新操作。');
            			$('div.pop-error-message p').empty().append('晶片金融卡驗證失敗，請重新操作。');
            			$('div.pop-error-message').show();
                    } else {
                    	emailOrMobileMessageUpdate('fic');
                    }
                },
                error : function() {
                    //showPopMessage('晶片金融卡驗證功能暫時無法使用，請改用其他驗證方式。');
        			$('div.pop-error-message p').empty().append('晶片金融卡驗證功能暫時無法使用，請改用其他驗證方式。');
        			$('div.pop-error-message').show();
                }
            });
		}else{
			//showPopMessage('晶片金融卡：'+ msg);
			$('div.pop-error-message p').empty().append('晶片金融卡：'+ msg);
			$('div.pop-error-message').show();
		}
	}
	
    function HWSignPKCS7Callback(code, msg, reserved, data){
        if(code==0){
            //上傳server登入驗證
            var p = {
                "uid" : getUnmaskValue('#uid'),
                "birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
                "scope" : "basic",
                "signCer" : data,
                "isDoubleVerify": false
            };

            RiAPI.run({
                type : 'POST',
                url : '/rest/user/verifyFch',
                loadSpin : true,
                data : p,
                success : function(resp) {
                    if (resp.code < 0) {
                        //登入失敗
                        //showPopMessage('硬體金融憑證驗證失敗，請重新操作。');
						$('div.pop-error-message p').empty().append('硬體金融憑證驗證失敗，請重新操作。');
						$('div.pop-error-message').show();
                    } else {
                    	emailOrMobileMessageUpdate('fch');
                    }
                },
                error : function() {
                    //showPopMessage('硬體金融憑證功能暫時無法使用，請改用其他驗證方式。');
					$('div.pop-error-message p').empty().append('硬體金融憑證功能暫時無法使用，請改用其他驗證方式。');
					$('div.pop-error-message').show();
                }
            });
        }else{
            //showPopMessage('硬體金融憑證：'+msg);
			$('div.pop-error-message p').empty().append('硬體金融憑證：'+msg);
			$('div.pop-error-message').show();
        }
    }	
	
    function SWSignPKCS7Callback(code, msg, reserved, data){
        if(code==0){
            //上傳server登入驗證
            var p = {
                "uid" : getUnmaskValue('#uid'),
                "birthdate" : transferBirthDateToAD(getUnmaskValue('#birthdate')),
                "scope" : "basic",
                "signCer" : data,
                "isDoubleVerify": false
            };

            RiAPI.run({
                type : 'POST',
                url : '/rest/user/verifyFcs',
                loadSpin : true,
                data : p,
                success : function(resp) {
                    if (resp.code < 0) {
                        //登入失敗
                        //showPopMessage('軟體金融憑證驗證失敗，請重新操作。');
						$('div.pop-error-message p').empty().append('軟體金融憑證驗證失敗，請重新操作。');
						$('div.pop-error-message').show();
                    } else {
                    	emailOrMobileMessageUpdate('fcs');
                    }
                },
                error : function() {
                    //showPopMessage('軟體金融憑證功能暫時無法使用，請改用其他驗證方式。');
					$('div.pop-error-message p').empty().append('軟體金融憑證功能暫時無法使用，請改用其他驗證方式。');
					$('div.pop-error-message').show();
                }
            });
        }else{
            //showPopMessage('軟體金融憑證：'+msg);
            if(code!='1002'){
    			$('div.pop-error-message p').empty().append('軟體金融憑證功能暫時無法使用，請改用其他驗證方式。');
    			$('div.pop-error-message').show();
            }
        }
    }    
    
	function iWantUpdate(type){
		$('div.pop-error-message').hide();	
		if(type=='email'){
			if($('#new_email').val()==null||$('#new_email').val()==''){
				$('div.pop-error-message p').empty().append('請輸入電子信箱。');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_email');
				return;
			}
			if(!verfiyEmailExpression(getUnmaskValue('#new_email'))){
				$('div.pop-error-message p').empty().append('電子信箱格式不正確。');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_email');
				return;
			}
			if($('#sendEmailOTPText').html().length > 0) {
				$('div.pop-error-message p').empty().append('請先點選發送驗證碼');
				$('div.pop-error-message').show();
				$('#emailSendLink').focus();
				return;
			}
			
			if($('#new_email_checkCode').val()==null||$('#new_email_checkCode').val()==''){
				$('div.pop-error-message p').empty().append('請輸入驗證碼');
				$('div.pop-error-message').show();
				$('#new_email_checkCode').focus();
				return;
			}
			
			// 先驗證驗證碼是否正確
			emailOrMobileMessageCheck($('#new_email_checkCode').val(), type);
			
			
		}else if(type=='mobile'){
			if($('#new_mobile').val()==null||$('#new_mobile').val()==''){
				$('div.pop-error-message p').empty().append('請輸入手機號碼。');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_mobile');
				return;
			}
			if(!verifyMobileExpression(getUnmaskValue('#new_mobile'))){
				$('div.pop-error-message p').empty().append('手機號碼格式不正確。');
				$('div.pop-error-message').show();
				focusNewEmailOrMobile('#new_mobile');
				return;
			}
			if($('#sendMobileOTPText').html().length > 0) {
				$('div.pop-error-message p').empty().append('請發送驗證碼');
				$('div.pop-error-message').show();
				$('#mobileSendLink').focus();
				return;
			}
			if($('#new_mobile_checkCode').val()==null||$('#new_mobile_checkCode').val()==''){
				$('div.pop-error-message p').empty().append('請發送驗證簡訊');
				$('div.pop-error-message').show();
				$('#new_mobile_checkCode').focus();
				return;
			}
			
			// 先驗證驗證碼是否正確
			emailOrMobileMessageCheck($('#new_mobile_checkCode').val(), type);
		}
	}
	//TODO WEDER
	function resendMemberOTP(informMethod){
		//var thisobj = $('#EmailOrMobileStep1-'+informMethod);
		var dataId = informMethod;
		RiAPI.run({
			type : 'POST',
			url : '/rest/user/emailOrMobileLoginStep1',
			loadSpin : true,
			data : loginParam(),
			success : function(resp) {
				if (resp.code < 0) {
					if(resp.code == -5) {
						closeEmailAndMobileDialog();
						showTimeoutMessage(resp);
						return;
					} else {
						$('#message-text').text('您非 MyData 會員，請使用其他身分驗證方式登入');
						$('#pop-message').modal('show');
					}
				} else {
					if (typeof resp.data.uuidcheck != 'undefined') {
						uuidcheck = resp.data.uuidcheck;
						clearInterval(waitOTPsecInterval);
						//初次發送，一樣等一分鐘後，才可重送
						var hint = '';
						if (resp.data.inform_method === 'mobile') {
							hint = '動態密碼已發送至您的手機號碼：' + maskPhoneNumber(resp.data.member.mobile) + '，請於 2 分鐘內輸入動態密碼<br> 2 分鐘後才能再次重新發送新動態密碼';
							$('#resendOTPText').empty().append(hint);
						} else {
							hint = '動態密碼已發送至您的電子信箱：' + maskEmailAddress(resp.data.member.email) + '，請於 2 分鐘內輸入動態密碼<br> 2 分鐘後才能再次重新發送新動態密碼';
							$('#resendOTPText').empty().append(hint);
						}
						tmpType = resp.data.inform_method;
						$('#resendOTPText-'+dataId).attr('data-time', 120);
						waitOTPsecInterval = setInterval(function(dataId) {checkOTPWaitTime(dataId);}, 1000, dataId);
					}
				}
			}
		});
	}
	function checkOTPWaitTime(dataId){
		var waitsec = parseInt($('#resendOTPText-'+dataId).attr('data-time'));
		waitsec =  parseInt(waitsec);
		var target, targetTxt;
		if(member.informMethod === 'mobile'){
			target = maskPhoneNumber(member.mobile);
			targetTxt = '動態密碼已發送至您的手機號碼：' + target;
		}else {
			target = maskEmailAddress(member.email);
			targetTxt = '動態密碼已發送至您的電子信箱：' + target;
		}
		
		if(waitsec==0){
			$('#resendOTPText-'+dataId).empty();
			$('#resendOTPLink-'+dataId).attr('href', 'javascript:resendMemberOTP(\''+dataId+'\');');
			$('#resendOTPText-'+dataId).empty().append('點此重新發送簡訊動態密碼');
			$('#resendOTPText-'+dataId).addClass('link');
			$('#resendOTPLink-'+dataId).css('cssText','');
			clearInterval(waitOTPsecInterval);
		}else{
			$('#resendOTPText-'+dataId).empty().append(targetTxt + '，請於 2 分鐘內輸入動態密碼<br> 2 分鐘後才能再次重新發送新動態密碼('+waitsec+'秒)');
			$('#resendOTPLink-'+dataId).attr('href', 'javascript:void();');
			$('#resendOTPText-'+dataId).removeClass('link');
			$('#resendOTPLink-'+dataId).css('cssText','cursor: default;text-decoration:none !important;color:#414141 !important;');
			waitsec = waitsec - 1;
			$('#resendOTPText-'+dataId).attr('data-time',waitsec)
		}
	}
	
	function checkEmailOrMobileOTPWaitTime(type){
		if(type=='email'){
			var waitsec = parseInt($('#resendEmailOTPMsg').attr('data-time'));
			waitsec =  parseInt(waitsec);
			if(waitsec==0){
				$('#emailReSendLink').show();
				$('#resendEmailOTPText').addClass('link');
				$('#resendEmailOTPMsg').hide();
				clearInterval(waitEmailorMobileOTPsecInterval);
			}else{
				$('#resendEmailOTPMsg').empty().append('已發送驗證碼，請於 2 分鐘內輸入驗證碼<br> 2 分鐘後才能再次重新發送新驗證碼('+waitsec+'秒)');
				$('#resendEmailOTPText').removeClass('link');
				$('#emailReSendLink').hide();
				waitsec = waitsec - 1;
				$('#resendEmailOTPMsg').attr('data-time',waitsec)
			}
			$('#sendEmailOTPText').empty();
		}else if(type=='mobile'){
			var waitsec = parseInt($('#resendMobileOTPMsg').attr('data-time'));
			waitsec =  parseInt(waitsec);
			//console.log('mobile sec...'+waitsec);
			if(waitsec==0){
				$('#mobileReSendLink').show();
				$('#resendMobileOTPText').addClass('link');
				$('#resendMobileOTPMsg').hide();
				clearInterval(waitEmailorMobileOTPsecInterval);
			}else{
				$('#resendMobileOTPMsg').empty().append('已發送驗證碼，請於 2 分鐘內輸入驗證碼<br> 2 分鐘後才能再次重新發送新驗證碼('+waitsec+'秒)');
				$('#resendMobileOTPText').removeClass('link');
				$('#mobileReSendLink').hide();
				waitsec = waitsec - 1;
				$('#resendMobileOTPMsg').attr('data-time',waitsec)
			}
			$('#sendMobileOTPText').empty();
		}
	}
	
	
	function loginByEmailOrMobileStep1(thisobj) {
		//div中包含input會造成二次觸發事件
		if(event) event.preventDefault();
		
		var checkFlag = true;
		var dataId = $(thisobj).attr('data-id');
		RiAPI.run({
			type : 'POST',
			url : '/rest/user/emailOrMobileLoginStep1',
			loadSpin : true,
			data : loginParam(),
			success : function(resp) {
				if (resp.code < 0) {
					if(resp.code == -5) {
						closeEmailAndMobileDialog();
						showTimeoutMessage(resp);
						return;
					} else {
						$('#message-text').text('您非 MyData 會員，請使用其他身分驗證方式登入');
						$('#pop-message').modal('show');
					}
				} else {
					if (typeof resp.data.uuidcheck != 'undefined') {
						uuidcheck = resp.data.uuidcheck;
						clearInterval(waitOTPsecInterval);
						//初次發送，一樣等一分鐘後，才可重送
						var hint = '';
						if (resp.data.inform_method === 'mobile') {
							hint = '動態密碼已發送至您的手機號碼：' + maskPhoneNumber(resp.data.member.mobile) + '，請於 2 分鐘內輸入動態密碼<br> 2 分鐘後才能再次重新發送新動態密碼';
							$('#resendOTPText').empty().append(hint);
						} else {
							hint = '動態密碼已發送至您的電子信箱：' + maskEmailAddress(resp.data.member.email) + '，請於 2 分鐘內輸入動態密碼<br> 2 分鐘後才能再次重新發送新動態密碼';
							$('#resendOTPText').empty().append(hint);
						}
						addClassChecked(thisobj);
						tmpType = resp.data.inform_method;
						$('#resendOTPText-'+dataId).attr('data-time', 120);
						waitOTPsecInterval = setInterval(function(dataId) {checkOTPWaitTime(dataId);}, 1000, dataId);
					}
				}
			}
		});
	}
	
	///emailOrMobileLoginStep/check
	function loginByemailOrMobileLoginStepCheck(type) {
		var checkFlag = true;
		var checkCode = '';
		if(type=='email'){
			checkCode = $('#otp-email').val();
		}else if(type=='mobile'){
			checkCode = $('#otp-mobile').val();
		}
		p = {
			"uuidcheck" : uuidcheck,
			"checkCode" : checkCode
		};
		p.verificationPath = "member";
		if (checkFlag && (typeof checkCode == 'undefined' || checkCode == '')) {
			$('div.pop-error-message p').empty().append('請輸入動態密碼');
			$('div.pop-error-message').show();
			if(type=='email'){
				$('#otp-email').focus();
			}else if(type=='mobile'){
				$('#otp-mobile').focus();
			}
			checkFlag = false;
		}
		if (checkFlag) {
			RiAPI.run({
				type : 'POST',
				url : '/rest/user/emailOrMobileLoginStep/check',
				loadSpin : true,
				data : p,
				success : function(resp) {
					if (resp.code < 0) {
						$('#otp-mobile').val('');
						$('#otp-email').val('');
						if(resp.code == -5) {
							closeEmailAndMobileDialog();
							showTimeoutMessage(resp);
							return;
						} else {
							$('div.pop-error-message p').empty().append('驗證碼輸入錯誤或失效');
							$('div.pop-error-message').show();
						}
					} else {
						emailOrMobileMessageUpdate('emailOrMobile');
					}
				}
			});
		}
	}
	
	function changeEmailOrMobile(type){
		if(type=='email'){
			clearInterval(waitEmailorMobileOTPsecInterval);
			$('#sendEmailOTPText').addClass('link');
			$('#sendMobileOTPText').empty();
			$('#resendEmailOTPMsg').hide();
			$('#sendEmailOTPText').empty().append('點此發送驗證碼');
			$('#emailSendLink').attr('href', 'javascript:emailOrMobileMessageSend(\'email\');');
		}else if(type=='mobile'){
			clearInterval(waitEmailorMobileOTPsecInterval);
			$('#sendMobileOTPText').addClass('link');
			$('#sendEmailOTPText').empty();
			$('#resendMobileOTPText').hide();
			$('#sendMobileOTPText').empty().append('點此發送驗證碼');
			$('#mobileSendlink').attr('href', 'javascript:emailOrMobileMessageSend(\'mobile\');');
		}
	}
	
	function refreshCaptchaImage(type) {
		var url = /*[[@{/captcha.jpg}]]*/"";
		url += "?" + "ctime=" + new Date().getTime();
		$('#captchaImg-' + type).attr('src', url);
		$('#captcha-' + type).val('');
	}

	function closeEmailAndMobileDialog() {
		$('#change-email-pop-message').modal('hide');
		$('#change-mobile-pop-message').modal('hide');
	}
	
    $(function () {
        var settings = {
            barWidth: 2, //bar粗細
            barHeight: 100, //bar高度
            fontSize: 20, //文字大小px
        };
        $('div.barcodeverify').each(function () {
            var value = $(this).attr('download-verify');
            var btype = 'code128'; //code128
            $(this).html('').show().barcode(value, btype, settings);
        });

        $('span.waitTime').each(function () {
            var waitsec = $(this).attr('data-time');
            var dataType = $(this).attr('data-type');
            calculatorWaitTime($(this));
            
            var timer = setInterval(function (obj) {
                //checkWaitTime(obj);
            		prepareCheck(obj);
            }, 1000, $(this));
            $(this).attr('data-timer', timer);
        });
        var boxid = /*[[${boxid}]]*/'';
        if (boxid != null && boxid != '') {
            //$('#box'+boxid).click();
            $('#box' + boxid).addClass('show');
            //card-header
            $('#box' + boxid).find('.card-header').removeClass('collapsed');
            $('#list' + boxid).addClass('show');
            $('#list' + boxid).attr('aria-expanded', 'true');
        }
    });
    
    function calculatorWaitTime(obj) {
        var waitsec = parseInt($(obj).attr('data-time'));
        var startsec = parseInt($(obj).attr('start-time'));
        var boxId = $(obj).attr('data-id');
        var dataType = $(obj).attr('data-type');
        var mm = Math.floor((waitsec / 60)).toString();
		var ss = ((waitsec) % (60)).toString();
		var waitmin = paddingLeft(mm, 2) + '分' + paddingLeft(ss, 2) + '秒'
        if (waitsec == 0) {
            $(obj).empty().append('20分00秒');
            $(obj).parent().parent().parent().parent().parent().addClass('expired');
        } else {
            $(obj).empty().append(waitmin);
            waitsec = waitsec - 1;
            $(obj).attr('data-time', waitsec);
        }
    }

	function prepareCheck(obj) {
		calculatorWaitTime(obj);
		var boxId = $(obj).attr('data-id');
		var prId = $(obj).attr('prId');
		var dataType = $(obj).attr('data-type');
		var code = $(obj).parent().parent().parent().find('button.btna').attr('httpcode');
		if(dataType=='dp'){
			if(code == '429') {
				RiAPI.run({
					type: 'GET',
					url: '/rest/personal/countpercent/'+prId,
					loadSpin : false,
					success: function(resp) {
						if (resp.code < 0) {
							if(resp.code == -5) {
								showTimeoutMessage(resp);
								return;
							}
						} else {
							var percent = resp.data.percent;
							var httpcode = resp.data.httpcode;
							if(typeof percent!='undefined'){
								console.log('percent -> ' + percent);
								if(percent >= 0){
									let id = '#uid' + prId;
									let tmpUid = $(id).val();
								}

								var percentStr = percent + '%';
								$('#flex-between' + boxId).find('div.progress-bar').css('width', percentStr);

								$(obj).parent().parent().parent().find('button.btna').attr('httpcode', httpcode);
								if(percent==100){
									$('#box-data' + boxId).hide();
									if(httpcode == 204) {
										$('#barcode-description' + boxId).hide();
										$('#barcode-box' + boxId).hide();
										$('#card-footer' + boxId).hide();
										$('#show204_' + boxId).show();
									} else {
										createRandomVerify('#barcode-btn' + boxId);
										$('#barcode-description' + boxId).show();
										$('#barcode-box' + boxId).show();
										$('#card-footer' + boxId).show();
										$('#show204_' + boxId).hide();
									}
								}else if(percent>=0){
									$('#box-data' + boxId).show()
									$('#percent' + boxId).empty().append(percentStr);
									$('#barcode-description' + boxId).hide();
									$('#barcode-box' + boxId).hide();
									$('#card-footer' + boxId).hide();
								}else{
									$('#box-data' + boxId).hide();
								}
							}
						}
					}
				});
			} else if(code == 204) {
				$('#barcode-description' + boxId).hide();
				$('#barcode-box' + boxId).hide();
				$('#card-footer' + boxId).hide();
				$('#show204_' + boxId).show();
			} else {
				//createRandomVerify('#barcode-btn' + boxId);
				$('#barcode-description' + boxId).show();
				$('#barcode-box' + boxId).show();
				$('#card-footer' + boxId).show();
				$('#show204_' + boxId).hide();
			}
		}else if(dataType=='sp'){
	        var dataCode = $(obj).attr('data-code');
	        if(dataCode=='429'){
				RiAPI.run({
					type: 'GET',
					url: '/rest/personal/service/counter/countpercent/'+boxId,
					loadSpin : false,
					success: function(resp) {
						if (resp.code < 0) {
							if(resp.code == -5) {
								showTimeoutMessage(resp);
								return;
							}
						} else {
							var percent = resp.data.percent;
							if(typeof percent!='undefined'){
								console.log('percent -> ' + percent);
								if(percent==100){
									$('#box-data' + boxId).hide();
									$('#barcode-description' + boxId).show();
									//TODO WEDER
									if($('#barcode-box' + boxId).attr('data-agent')!='true'){
										$('#barcode-box' + boxId).show();
									}
									$('#card-footer' + boxId).find('button.btna').removeClass('disabled');
									$('#card-footer' + boxId).find('button.btna').attr('disabled',false);
									$('#show204_' + boxId).hide();
									$(obj).attr('data-code','200');
								}else if(percent>=0){
									$('#box-data' + boxId).show()
									$('#barcode-description' + boxId).hide();
									$('#barcode-box' + boxId).hide();
									$('#card-footer' + boxId).find('button.btna').addClass('disabled');
									$('#card-footer' + boxId).find('button.btna').attr('disabled',true);
								}else{
									$('#box-data' + boxId).hide();
								}
							}
						}
					}
				});
	        }else{
	        		//UNDO
	        }
		}
	}

    function checkWaitTime(obj) {
	    	calculatorWaitTime(obj);
	    	var boxId = $(obj).attr('data-id');
	    	var fullwaitsec = parseInt($(obj).attr('full-wait-time'));
        var startsec = parseInt($(obj).attr('start-time'));
		var timer = $(obj).attr('data-timer');
        
        if (startsec == -1) {
			//clearInterval(timer);
			var code = $(obj).attr('data-code');
            if(code == '204') {
				$('#barcode-description' + boxId).hide();
				$('#barcode-box' + boxId).hide();
				$('#card-footer' + boxId).hide();
				$('#show204_' + boxId).show();
			}
        } else if (startsec == 0) {
            //close percent
            $('#box-data' + boxId).hide();
            var percent = 100;
            var percentStr = percent + '%';
            $('#flex-between' + boxId).find('div.progress-bar').css('width', percentStr);
            $('#percent' + boxId).empty().append(percentStr);
            //show card-body
            startsec = -1;
            $(obj).attr('start-time', startsec)
            RiAPI.run({
                type: 'GET',
                url: '/rest/personal/box/status/' + boxId,
                loadSpin: false,
                success: function (resp) {
                    if (resp.code < 0) {
                        if(resp.code == -5) {
                            showTimeoutMessage(resp);
                            return;
                        } else {
                            $('#message-text').text(resp.text);
                            $('#pop-message').modal('show');
                        }
                    } else {
                        //成功
                        var httpcode = resp.data.code;
                        $(obj).parent().parent().parent().find('button.btna').attr('httpcode', httpcode);
                        if(httpcode == 204) {
							$('#barcode-description' + boxId).hide();
							$('#barcode-box' + boxId).hide();
							$('#card-footer' + boxId).hide();
							$('#show204_' + boxId).show();
						} else if(httpcode == 429) {
							$(obj).attr('start-time', 60);
						} else {
							$('#barcode-description' + boxId).show();
							$('#barcode-box' + boxId).show();
							$('#card-footer' + boxId).show();
							$('#show204_' + boxId).hide();
						}
                    }
                }
            });
        } else {
            //close card-body
            $('#box-data' + boxId).show();
            var percent = parseInt((fullwaitsec - startsec) * 100 / fullwaitsec);
            var percentStr = percent + '%';
            //var boxMin = parseInt(startsec/60);
            $('#flex-between' + boxId).find('div.progress-bar').css('width', percentStr);
            $('#percent' + boxId).empty().append(percentStr);
            //show percent
            $('#barcode-description' + boxId).hide();
            $('#barcode-box' + boxId).hide();
            $('#card-footer' + boxId).hide();
            startsec = startsec - 1;
            $(obj).attr('start-time', startsec)
        }
    }

    function createRandomVerify(obj) {
        var stat = $(obj).attr('stat');
        var p = {
            "downloadVerify": $(obj).attr('download-verify')
        };
        RiAPI.run({
            type: 'POST',
            url: '/rest/personal/verification',
            data: p,
            loadSpin: true,
            success: function (resp) {
                if (resp.code < 0) {
                    if(resp.code == -5) {
                        showTimeoutMessage(resp);
                        return;
                    } else {
                        $('#message-text').text(resp.text);
                        $('#pop-message').modal('show');
                    }
                } else {
                    //alert('傳送成功！');
                    //window.location.reload();
                    //$(obj).attr('endtimenote',resp.data.endTimeNote);
                    $(obj).attr('download-verify', resp.data.downloadVerify);
                    $(obj).attr('stat', resp.data.stat);

                    //var endTimeNote = $(obj).attr('endtimenote');
                    var settings = {
                        barWidth: 2, //bar粗細
                        barHeight: 100, //bar高度
                        fontSize: 20, //文字大小px
                    };
                    var value = $(obj).attr('download-verify');
                    var btype = 'code128'; //code128
                    $(obj).parent().parent().parent().parent().parent().find('button.barcode').attr('download-verify', resp.data.downloadVerify);
                    $(obj).parent().parent().parent().find('div.barcodeverify').html('').show().barcode(value, btype, settings);
                    //$(obj).parent().parent().parent().parent().find('p.alert').empty().append(resp.data.endTimeNote);
                    $(obj).parent().parent().parent().parent().parent().find('span.waitTime').attr('data-time', '1200');
                    $(obj).parent().parent().parent().parent().parent().find('span.waitTime').each(function () {
                        //setInterval(checkWaitTime($(this)), 1000);
                        
                        var timer = $(this).attr('data-timer');
    					clearInterval(timer);
    					
    					calculatorWaitTime($(this));
    					timer = setInterval(function (obj) {
                            //checkWaitTime(obj);
							prepareCheck(obj);
                        }, 1000, $(this));
                        $(this).attr('data-timer', timer);
                    });
                    $(obj).parent().parent().parent().parent().parent().removeClass('expired');
                }
            }
        });
    }

    function createRandomVerifyExpired(obj) {
        var stat = $(obj).attr('stat');
        var p = {
            "downloadVerify": $(obj).attr('download-verify')
        };
        RiAPI.run({
            type: 'POST',
            url: '/rest/personal/verification',
            data: p,
            loadSpin: true,
            success: function (resp) {
                if (resp.code < 0) {
                    if(resp.code == -5) {
                        showTimeoutMessage(resp);
                        return;
                    } else {
                        $('#message-text').text(resp.text);
                        $('#pop-message').modal('show');
                    }
                } else {
                    //alert('傳送成功！');
                    //window.location.reload();
                    //$(obj).attr('endtimenote',resp.data.endTimeNote);
                    $(obj).attr('download-verify', resp.data.downloadVerify);
                    $(obj).attr('stat', resp.data.stat);

                    //var endTimeNote = $(obj).attr('endtimenote');
                    var settings = {
                        barWidth: 2, //bar粗細
                        barHeight: 100, //bar高度
                        fontSize: 20, //文字大小px
                    };
                    var value = $(obj).attr('download-verify');
                    var btype = 'code128'; //code128
                    $(obj).parent().parent().parent().parent().parent().find('button.barcode').attr('download-verify', resp.data.downloadVerify);
                    $(obj).parent().parent().parent().find('div.barcodeverify').html('').show().barcode(value, btype, settings);
                    //$(obj).parent().parent().parent().parent().find('p.alert').empty().append(resp.data.endTimeNote);
                    $(obj).parent().parent().parent().parent().parent().find('span.waitTime').attr('data-time', '1200');
                    $(obj).parent().parent().parent().parent().parent().find('span.waitTime').each(function () {
                        //setInterval(checkWaitTime($(this)), 1000);
                        
                        var timer = $(this).attr('data-timer');
    					clearInterval(timer);
    	
    					calculatorWaitTime($(this));
                        timer = setInterval(function (obj) {
                            //checkWaitTime(obj);
							prepareCheck(obj);
                        }, 1000, $(this));
                        $(this).attr('data-timer', timer);
                    });
                    $(obj).parent().parent().parent().parent().parent().parent().removeClass('expired');
                }
            }
        });
    }

    function toggleParentClass(obj) {
        setTimeout(function () {
            if ($(obj).parent().find('div.card-header').hasClass('collapsed')) {
                $(obj).parent().removeClass('show');
                $(obj).parent().find('.paCard-header .fa-chevron-up').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
            	//TODO WEDER
            	var p = {"prId":$(obj).attr('data-id')}
          		RiAPI.run({
					type : 'POST',
					url : '/rest/user/log',
					loadSpin : true,
					data : p,
					success : function(resp) {
						if (resp.code < 0) {
				            $('#message-text').text('資料存取失敗，請重新操作。');
				            $('#pop-message').modal('show');
						} else {
							var data = resp.data;
							$(obj).parent().find('tbody.collapsed').empty();
							if(typeof data!='undefined'&&data.length>0){
								paseUlog(data,$(obj));
							}
						}
					},
					error : function() {
			            $('#message-text').text('資料存取失敗，請重新操作。');
			            $('#pop-message').modal('show');
					}
				});
                $(obj).parent().addClass('show');
                $(obj).parent().find('.paCard-header .fa-chevron-down').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        }, 100);
    }
    
    function paseUlog(data,obj){
    	var str = '';
		if(typeof data!='undefined'&&data.length>0){
			for(var i=0;i<data.length;i++){
				var ulog = data[i];
				//tr1
				var str = '<tr data-toggle="collapse" data-target="#table-accordion-'+($(obj).attr('data-id')+'-'+i)+'" class="pointer card-header collapsed" onclick="javascript:toggleParent1Class(this);" aria-expanded="false">';
				str = str + '<td scope="row"><span class="show-md-only">次序：</span><span>'+(i+1)+'</span>.</td>';
				str = str + '<td><span class="show-md-only">時間：</span><span>'+ulog.ctimeStr+'-'+ulog.ctimeStr1+'</span></td>';
				str = str + '<td><span class="show-md-only">類別：</span><span>'+ulog.actionStr+'</span></td>';
				str = str + '<td><span class="show-md-only">說明：</span>';
				if(ulog.auditEvent==11){
					str = str + '<span>您已同意申請此項服務，並完成身分驗證作業</span>';
				}
				if(ulog.auditEvent==12){
					str = str + '<span>您同意服務條款</span>';
				}
				if(ulog.auditEvent==13){
					str = str + '<span>您完成身分驗證</span>';
				}
				if(ulog.auditEvent==14){
					str = str + '<span>您同意 MyData 傳送資料給服務提供者</span>';
				}
				if(ulog.auditEvent==15){
					str = str + '<span>您已轉存資料至電腦或手機</span>';
				}
				if(ulog.auditEvent==16){
					str = str + '<span>您完成提供資料給臨櫃核驗機關</span>';
				}
				if(ulog.auditEvent==17){
					str = str + '<span>您完成提供資料給<span>「'+ ulog.providerName + ' - ' + ulog.serviceName + '</span>」</span>';
				}
				if(ulog.auditEvent==18){
					str = str + '<span>您已完成此項資料下載</span>';
				}
				if(ulog.auditEvent==19||ulog.auditEvent==20){
					str = str + '<span>您申請此服務失敗</span>';
				}
				if(ulog.auditEvent==28||ulog.auditEvent==29){
					str = str + '<span>您點選「不同意傳送」或服務申請未完成</span>';
				}
				if(ulog.auditEvent==31){
					str = str + '<span>您已預覽此項資料</span>';
				}
				if(ulog.auditEvent==32){
					str = str + '<span>「臨櫃人員」使用「預覽」</span>';
				}
				
				if(ulog.auditEvent==41){
					str = str + '<span>您選擇此項臨櫃服務委託代辦</span>';
				}
				if(ulog.auditEvent==42){
					str = str + '<span>您同意委託代辦項目</span>';
				}
				if(ulog.auditEvent==43){
					str = str + '<span>已提供驗證碼給代辦人</span>';
				}
				if(ulog.auditEvent==44){
					str = str + '<span>您輸入的訊息，非 MyData 會員</span>';
				}
				if(ulog.auditEvent==45){
					str = str + '<span>您終止此項委託代辦項目</span>';
				}
				if(ulog.auditEvent==46){
					str = str + '<span>已超過資料可取用時間</span>';
				}
				if(ulog.auditEvent==47){
					str = str + '<span>代辦人已至臨櫃提供資料給「<span>'+ulog.providerName+' - '+ulog.serviceName+'</span>」申辦完畢</span>';
				}
				if(ulog.auditEvent==48){
					str = str + '<span>代辦人終止此項委託代辦項目</span>';
				}
				if(ulog.auditEvent==51){
					str = str + '<span>您同意此項臨櫃服務代辦</span>';
				}
				if(ulog.auditEvent==52){
					str = str + '<span>委託人已取消此代辦申請</span>';
				}
				if(ulog.auditEvent==53){
					str = str + '<span>已超過資料可取用時間</span>';
				}
				if(ulog.auditEvent==54){
					str = str + '<span>您完成提供資料給臨櫃核驗機關</span>';
				}
				if(ulog.auditEvent==55){
					str = str + '<span>您完成提供資料給「<spa>'+ ulog.providerName +' - '+ulog.serviceName+'</span>」</span>';
				}
				if(ulog.auditEvent==56){
					str = str + '<span>您終止此項委託代辦項目</span>';
				}
				str = str + '<i class="fa fa-chevron-down pull-right"></i>';
				str = str + '</td>';
				str = str + '</tr>';
				//tr2
				str = str + '<tr>';
				str = str + '<td class="table-loca p-3" colspan="4">';
				str = str + '<div id="table-accordion-'+($(obj).attr('data-id')+'-'+i)+'" class="table-collaspe-wrap collapse" style="">';
				
				str = str + '<table>';
				str = str + '<tbody>';
				
				if(typeof ulog.ulogApiExtList!='undefined'&&ulog.ulogApiExtList.length>0){
					for(var j=0;j<ulog.ulogApiExtList.length;j++){
						var ulog1 = ulog.ulogApiExtList[j];
						str = str + '<tr>';
						str = str + '<th></th>';
						str = str + '<td><span class="show-md-only">時間：</span><span>'+ulog1.ctimeStr+'-'+ulog1.ctimeStr1+'</span></td>';
						str = str + '<td><span class="show-md-only">類別：</span><span>'+ulog1.actionStr+'</span></td>';
						str = str + '<td>';
						str = str + '<span class="show-md-only">說明：</span>';
						
						if(ulog1.auditEvent==11){
							str = str + '<span>您已同意申請此項服務，並完成身分驗證作業</span>';
						}
						if(ulog1.auditEvent==12){
							str = str + '<span>您同意服務條款</span>';
						}
						if(ulog1.auditEvent==13){
							str = str + '<span>您完成身分驗證</span>';
						}
						if(ulog1.auditEvent==14){
							str = str + '<span>您同意 MyData 傳送資料給服務提供者</span>';
						}
						if(ulog1.auditEvent==15){
							str = str + '<span>您已轉存資料至電腦或手機</span>';
						}
						if(ulog1.auditEvent==16){
							str = str + '<span>您完成提供資料給臨櫃核驗機關</span>';
						}
						if(ulog1.auditEvent==17){
							str = str + '<span>您完成提供資料給<span>「'+ ulog1.providerName + ' - ' + ulog1.serviceName + '</span>」</span>';
						}
						if(ulog1.auditEvent==18){
							str = str + '<span>您已完成此項資料下載</span>';
						}
						if(ulog1.auditEvent==19||ulog1.auditEvent==20){
							str = str + '<span>您申請此服務失敗</span>';
						}
						if(ulog1.auditEvent==28||ulog1.auditEvent==29){
							str = str + '<span>您點選「不同意傳送」或服務申請未完成</span>';
						}
						if(ulog1.auditEvent==31){
							str = str + '<span>您已預覽此項資料</span>';
						}
						if(ulog1.auditEvent==32){
							str = str + '<span>「臨櫃人員」使用「預覽」</span>';
						}
						
						if(ulog1.auditEvent==41){
							str = str + '<span>您選擇此項臨櫃服務委託代辦</span>';
						}
						if(ulog1.auditEvent==42){
							str = str + '<span>您同意委託代辦項目</span>';
						}
						if(ulog1.auditEvent==43){
							str = str + '<span>已提供驗證碼給代辦人</span>';
						}
						if(ulog1.auditEvent==44){
							str = str + '<span>您輸入的訊息，非 MyData 會員</span>';
						}
						if(ulog1.auditEvent==45){
							str = str + '<span>您終止此項委託代辦項目</span>';
						}
						if(ulog1.auditEvent==46){
							str = str + '<span>已超過資料可取用時間</span>';
						}
						if(ulog1.auditEvent==47){
							str = str + '<span>代辦人已至臨櫃提供資料給「<span>'+ulog1.providerName+' - '+ulog1.serviceName+'</span>」申辦完畢</span>';
						}
						if(ulog1.auditEvent==48){
							str = str + '<span>代辦人終止此項委託代辦項目</span>';
						}
						if(ulog1.auditEvent==51){
							str = str + '<span>您同意此項臨櫃服務代辦</span>';
						}
						if(ulog1.auditEvent==52){
							str = str + '<span>委託人已取消此代辦申請</span>';
						}
						if(ulog1.auditEvent==53){
							str = str + '<span>已超過資料可取用時間</span>';
						}
						if(ulog1.auditEvent==54){
							str = str + '<span>您完成提供資料給臨櫃核驗機關</span>';
						}
						if(ulog1.auditEvent==55){
							str = str + '<span>您完成提供資料給「<spa>'+ ulog1.providerName +' - '+ulog1.serviceName+'</span>」</span>';
						}
						if(ulog1.auditEvent==56){
							str = str + '<span>您終止此項委託代辦項目</span>';
						}
						str = str + '</td>';
						str = str + '</tr>';
					}
				}				
				str = str + '</tbody>';
				str = str + '</table>';
				
				str = str + '</div>';
				
				str = str + '</td>';
				str = str + '</tr>';
				
				$(obj).parent().find('tbody.collapsed').append(str);
			}
		}
    	return str;
    }
    
    function toggleParent1Class(obj) {
        setTimeout(function () {
            if ($(obj).hasClass('collapsed')) {
                $(obj).find('.fa-chevron-up').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                $(obj).find('.fa-chevron-down').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        }, 100);
    }    
    
    function toggleClass(obj) {
        setTimeout(function () {
            if ($(obj).find('div.card-header').hasClass('collapsed')) {
                $(obj).removeClass('show');
                $(obj).find('.fa-chevron-up').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                $(obj).addClass('show');
                $(obj).find('.fa-chevron-down').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        }, 100);
    }

    //覆蓋登入
    function openLogin(obj) {
        clearInterval(loginWindowTimer);
        if (loginWindow) {
            loginWindow.close();
        }
        var popupWidth = 520;
        var popupHeight = 635;
        var xPosition = ($(window).width() - popupWidth) / 2;
        var yPosition = ($(window).height() - popupHeight) / 2;
        var loginUrl = /*[[@{/signin}]]*/'';
        if (typeof obj != 'undefined' && obj != '' && obj != null) {
            loginUrl = obj;
        }
        //alert(loginUrl);
        //另開視窗
        loginWindow = window.open(loginUrl, "LoginWindow",
            "location=no,scrollbars=yes,resizable=yes," + "width="
            + popupWidth + ",height=" + popupHeight + ","
            + "left=" + xPosition + ",top=" + yPosition);
        loginWindowTimer = setInterval(onTimerCallbackToCheckLoginWindowClosure, 500);
    }

    function onTimerCallbackToCheckLoginWindowClosure() {
        try {
            if (loginWindow && loginWindow.closed) {
                RiAPI.run({
                    type: 'POST',
                    url: '/rest/user/info',
                    loadSpin: true,
                    success: function (resp) {
                        if (resp.code < 0) {
                            if(resp.code == -5) {
                                showTimeoutMessage(resp);
                                return;
                            } else {
                                clearInterval(loginWindowTimer);
                            }
                        } else {
                            clearInterval(loginWindowTimer);
                            window.location.reload();
                        }
                    }
                });
            }
        } catch (ex) {
            clearInterval(loginWindowTimer);
        }
    }

    function previewToCompany(obj) {
        var httpcode = $(obj).attr('httpcode');
        var prId = $(obj).attr('data-id');
        var boxId = $(obj).attr('box-id');
        if (httpcode == '200') {
            var url = $(obj).attr('data-src');
            $('#preview-btn').attr('data-src',url);
            $('#preview-btn').attr('data-id',prId);
            $('#preview-btn').attr('httpcode',httpcode);
            $('#preview-btn').attr('box-id',boxId);
            $('#preview-message-text').text('此畫面僅供您個人檢視參考，不得列印作為業務申辦佐證文件。');
            $('#preview-pop-message').modal('show');
//             var url = $(obj).attr('data-src');
//             window.open(url);
        } else if (httpcode == '204') {
            $('#message-text').text('查無資料！');
            $('#pop-message').modal('show');
            //append change portal_resource_download stat=1 RiAPI
            RiAPI.run({
                type: 'GET',
                url: '/rest/personal/download/changestatone/' + prId,
                loadSpin: false,
                success: function (resp) {
                    if (resp.code < 0) {
                        if(resp.code == -5) {
                            showTimeoutMessage(resp);
                            return;
                        } else {
                            $('#message-text').text(resp.text);
                            $('#pop-message').modal('show');
                        }
                    } else {
                        //成功
                        $('#box' + boxId).remove();
                    }
                }
            });
        } else {
        		//console.log('httpcode '+httpcode+' 申請失敗！');
            //$('#message-text').text('httpcode ' + httpcode + ' 申請失敗！');
            $('#message-text').text('資料申請失敗，請重新操作。');
            $('#pop-message').modal('show');
            //append change portal_resource_download stat=1 RiAPI
            RiAPI.run({
                type: 'GET',
                url: '/rest/personal/download/changestatone/' + prId,
                loadSpin: false,
                success: function (resp) {
                    if (resp.code < 0) {
                        if(resp.code == -5) {
                            showTimeoutMessage(resp);
                            return;
                        } else {
                            $('#message-text').text(resp.text);
                            $('#pop-message').modal('show');
                        }
                    } else {
                        //成功
                        $('#box' + boxId).remove();
                    }
                }
            });
        }
    }
    
//     function previewToCompanyConfirmYes(obj){
// 		var url = $(obj).attr('data-src');
// 		window.open(url);
// 		$('#preview-pop-message').modal('hide');
// 	}
    
    function downloadToCompany(obj) {
        var url = $(obj).attr('data-src');
        window.open(url);
        $('#download-pop-message').modal('hide');
        var returnOrgUrl = /*[[@{/sp/member/1}]]*/'';
        setTimeout(function () {
            window.location.href = returnOrgUrl;
        }, 2000);
    }

    function changeLocation(obj) {
        var url = $(obj).attr('data-src');
        window.location.href = url;
    }

    function downloadToCompanyWarning(obj) {
        var httpcode = $(obj).attr('httpcode');
        var prId = $(obj).attr('data-id');
        var boxId = $(obj).attr('box-id');
        if (httpcode == '200') {
            var datasrc = $(obj).attr('data-src');
            $('#download-btn').attr('data-src', datasrc);
            $('#download-pop-message').modal('show');
        } else if (httpcode == '204') {
            $('#message-text').text('點擊確認後，本平臺將立即刪除此資料檔案。');
            $('#pop-message').modal('show');
            //append change portal_resource_download stat=1 RiAPI
            RiAPI.run({
                type: 'GET',
                url: '/rest/personal/download/changestatone/' + prId,
                loadSpin: false,
                success: function (resp) {
                    if (resp.code < 0) {
                        if(resp.code == -5) {
                            showTimeoutMessage(resp);
                            return;
                        } else {
                            $('#message-text').text(resp.text);
                            $('#pop-message').modal('show');
                        }
                    } else {
                        //成功
                        $('#box' + boxId).remove();
                    }
                }
            });
        } else {
    			//console.log('httpcode '+httpcode+' 申請失敗！');
            //$('#message-text').text('httpcode ' + httpcode + ' 申請失敗！');
            $('#message-text').text('資料申請失敗，請重新操作。');
            $('#pop-message').modal('show');
            //append change portal_resource_download stat=1 RiAPI
            RiAPI.run({
                type: 'GET',
                url: '/rest/personal/download/changestatone/' + prId,
                loadSpin: false,
                success: function (resp) {
                    if (resp.code < 0) {
                        if(resp.code == -5) {
                            showTimeoutMessage(resp);
                            return;
                        } else {
                            $('#message-text').text(resp.text);
                            $('#pop-message').modal('show');
                        }
                    } else {
                        //成功
                        $('#box' + boxId).remove();
                    }
                }
            });
        }
    }
    
    function paddingLeft(str,lenght){
		if(str.length >= lenght)
			return str;
		else
			return paddingLeft("0" +str,lenght);
	}

	function focusNewEmailOrMobile(obj) {
		var i = $(obj).parent().find('.eye-switch');
		// 小眼睛切換
		if($(i).hasClass('fa-eye')){
			$(i).removeClass('fa-eye').addClass('fa-eye-slash');
		}else {
			$(i).removeClass('fa-eye-slash').addClass('fa-eye');
		}

		if(typeof $(obj).attr('data-value') !='undefined' && $(obj).attr('data-value').length > 0){
			var val = $(obj).attr('data-value')
			$(obj).val(val);
		}
		$(obj).attr('data-value','');
		$(obj).focus();
	}
	
    function captchaGoogleSounfPlay(){
		var m = '連線失敗'; 
		///rest/user/captchainfo
		var p = {};
        RiAPI.run({
            type : 'POST',
            url : '/rest/user/captchainfo',
            data : p,
            loadSpin : false,
            success : function(resp) {
                if (resp.code < 0) {
                    //$('#message-text').text(resp.text);
                    //$('#pop-message').modal('show');
                		m = '連線失敗';
        				var msg = new SpeechSynthesisUtterance();
        				var synth = window.speechSynthesis;
        				setVoices();
        				msg.voiceURI = "native";
        				msg.volume = 1;
        				msg.rate = 1;
        				msg.pitch = 0.8;
        				msg.text = m;
        				msg.lang = 'zh-TW';
        				speechSynthesis.speak(msg);
                } else {
                    //成功
                    m=resp.data;
        				var msg = new SpeechSynthesisUtterance();
        				var synth = window.speechSynthesis;
        				setVoices();
        				msg.voiceURI = "native";
        				msg.volume = 1;
        				msg.rate = 1;
        				msg.pitch = 0.8;
        				msg.text = m;
        				msg.lang = 'zh-TW';
        				speechSynthesis.speak(msg);
                }
            },
            error:function(resp) {
            		m = '連線失敗';
    				var msg = new SpeechSynthesisUtterance();
    				var synth = window.speechSynthesis;
    				setVoices();
    				msg.voiceURI = "native";
    				msg.volume = 1;
    				msg.rate = 1;
    				msg.pitch = 0.8;
    				msg.text = m;
    				msg.lang = 'zh-TW';
    				speechSynthesis.speak(msg);
            }
        });
    }
    
	function setVoices() {
		var synth = window.speechSynthesis;
		return new Promise((resolve, reject) => {
			let timer;
			timer = setInterval(() => {
				if(synth.getVoices().length !== 0) {
					resolve(synth.getVoices());
					clearInterval(timer);
				}
			}, 10);
		})
	}
	
	function boxAgentCheck(obj){
		var boxId = $(obj).attr('data-id');
		var agent_uid = getUnmaskValue('#agent_uid');
		var agent_birthdate = getUnmaskValue('#agent_birthdate');
		if(typeof agent_uid=='undefined' || agent_uid==''){
			$('div.pop-error-message p').empty().append('請輸入代辦人身分證字號。');
			$('div.pop-error-message').show();
			focusNewEmailOrMobile('#agent_uid');
			return;
		}
		if(typeof agent_birthdate=='undefined' || agent_birthdate==''){
			$('div.pop-error-message p').empty().append('請輸入代辦人生日。');
			$('div.pop-error-message').show();
			focusNewEmailOrMobile('#agent_birthdate');
			return;
		}
		$('div.pop-error-message p').empty().append('');
		$('div.pop-error-message').hide();
		RiAPI.run({
			type : 'POST',
			url : '/rest/user/checkBoxAgentData',
			loadSpin : true,
			data : {boxId: boxId, agent_uid : agent_uid ,agent_birthdate : agent_birthdate},
			success : function(resp) {
				if (resp.code < 0) {
					$('#change-agent-pop-message').modal('hide');
	                $('#message-text').text(resp.text);
	                $('#pop-message').modal('show');
				}else{
					$('#change-agent-pop-message').modal('hide');
					//$('#agentSendBtn').addClass('disabled');
					//$('#agentSendBtn').attr('disabled', true);
					$('#agent-step2-next-btn').attr('data-id',resp.data.boxId);
					$('#agreeAgentName').empty().append(resp.data.agentName);
					$('#providerName').empty().append(resp.data.providerName);
					$('#serviceName').empty().append(resp.data.serviceName);
					$('#change-agent-pop-agree-message').modal('show');
				}
			}
		});
	}
	
	function boxAgentUpdate(obj){
		var boxId = $(obj).attr('data-id');
		var agent_uid = getUnmaskValue('#agent_uid');
		var agent_birthdate = getUnmaskValue('#agent_birthdate');
		if(typeof agent_uid=='undefined' || agent_uid==''){
			$('div.pop-error-message p').empty().append('請輸入代辦人身分證字號。');
			$('div.pop-error-message').show();
			focusNewEmailOrMobile('#agent_uid');
			return;
		}
		if(typeof agent_birthdate=='undefined' || agent_birthdate==''){
			$('div.pop-error-message p').empty().append('請輸入代辦人生日。');
			$('div.pop-error-message').show();
			focusNewEmailOrMobile('#agent_birthdate');
			return;
		}
		$('div.pop-error-message p').empty().append('');
		$('div.pop-error-message').hide();
		RiAPI.run({
			type : 'POST',
			url : '/rest/user/changeBoxAgentData',
			loadSpin : true,
			data : {boxId: boxId, agent_uid : agent_uid ,agent_birthdate : agent_birthdate},
			success : function(resp) {
				if (resp.code < 0) {
					//resp.text
					$('div.pop-error-message p').empty().append(resp.text);
					$('div.pop-error-message').show();
				}else{
					$('#change-agent-pop-agree-message').modal('hide');
					$('#not-agent'+boxId).hide();
					$('#barcode-box'+boxId).hide();
					$('#barcode-description'+boxId+' .not-agent').hide();
					$('#barcode-description'+boxId+' .in-agent').show();
					$('#in-agent-text'+boxId).empty().append('此臨櫃服務目前已委託給指定代辦人'+resp.data.agentName+'申辦中。');
					$('#in-agent-text'+boxId).show();
				}
			}
		});
	}
	
    function previewToCompanyConfirmYes(obj){
		var boxId = $(obj).attr('box-id');
		var p = {
			key:publicKeyBase64
		};
        RiAPI.run({
            type : 'POST',
            url : '/rest/personal/box/prview/'+boxId,
            data: p,
            loadSpin : true,
            success : function(resp) {
                if (resp.code < 0) {
                    if(resp.code == -5) {
                        showTimeoutMessage(resp);
                        return;
                    }
                    $('#message-text').text(resp.text);
                    $('#pop-message').modal('show');
                } else {
                	if(typeof resp.data.data!='undefined' &&resp.data.data.length>0){
                		preViewDataDecodeAndShow(resp.data);
                	}
                }
            },
            error : function() {
                $('#message-text').text('線上預覽檔案失敗。');
                $('#pop-message').modal('show');
            }
        
        });
		$('#preview-pop-message').modal('hide');
    }
    
	var algorithmKeyGen = {
		name: "RSA-OAEP",
		hash: {name: "sha-256"},
		modulusLength: 2048,
		publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
	};
	
	function createNewUserKey(){
		return crypto.subtle.generateKey(algorithmKeyGen, true, ['encrypt', 'decrypt']).then(function(key) {
			return Promise.all([crypto.subtle.exportKey("spki", key.publicKey),
			crypto.subtle.exportKey("pkcs8", key.privateKey)]);
		});  
	}
		        
       function arrayBufferToBase64(arrayBuffer) {
           var byteArray = new Uint8Array(arrayBuffer);
           var byteString = '';
           for(var i=0; i < byteArray.byteLength; i++) {
               byteString += String.fromCharCode(byteArray[i]);
           }
           var b64 = window.btoa(byteString);

           return b64;
       }

       function addNewLines(str) {
           var finalString = '';
           while(str.length > 0) {
               finalString += str.substring(0, 64) + '\n';
               str = str.substring(64);
           }

           return finalString;
       }
       
       function toPrivatePem(privateKey) {
           var b64 = addNewLines(arrayBufferToBase64(privateKey));
           var pem = "-----BEGIN PRIVATE KEY-----\n" + b64 + "-----END PRIVATE KEY-----";
           
           return pem;
       }
       
       function toPublicPem(publicKey) {
           //var b64 = addNewLines(arrayBufferToBase64(publicKey));
           var b64 = arrayBufferToBase64(publicKey);
           var pem = "-----BEGIN PUBLIC KEY-----\n" + b64 + "-----END PUBLIC KEY-----";
           
           return b64;
       }
       
       function convertPemToBinary(pem) {
           var lines = pem.split('\n')
           var encoded = ''
           for(var i = 0;i < lines.length;i++){
             if (lines[i].trim().length > 0 &&
                 lines[i].indexOf('-BEGIN RSA PRIVATE KEY-') < 0 &&
                 lines[i].indexOf('-BEGIN PRIVATE KEY-') < 0 &&
                 lines[i].indexOf('-BEGIN RSA PUBLIC KEY-') < 0 &&
                 lines[i].indexOf('-BEGIN PUBLIC KEY-') < 0 &&
                 lines[i].indexOf('-END RSA PRIVATE KEY-') < 0 &&
                 lines[i].indexOf('-END PRIVATE KEY-') < 0 &&
                 lines[i].indexOf('-END PUBLIC KEY-') < 0 &&
                 lines[i].indexOf('-END RSA PUBLIC KEY-') < 0) {
               encoded += lines[i].trim()
             }
           }
           return base64StringToArrayBuffer(encoded)
       }
       
       function base64StringToArrayBuffer(b64str) {
           var byteStr = atob(b64str)
           var bytes = new Uint8Array(byteStr.length)
           for (var i = 0; i < byteStr.length; i++) {
             bytes[i] = byteStr.charCodeAt(i)
           }
           return bytes.buffer
	}
	
       function importPrivateKey(pemKey) {
           return new Promise(function(resolve) {
             var importer = crypto.subtle.importKey("pkcs8", convertPemToBinary(pemKey), algorithmKeyGen, true, ['decrypt'])
             importer.then(function(key) {
               resolve(key)
             })
           })
       }
       
	function preViewDataDecodeAndShow(data){
		var encryptedKey = data.key;
		var encryptedData = data.data;
		var encryptedIv = data.iv;
		importPrivateKey(privatKeyBase64).then(function(key){
			//importkey 解密
			return crypto.subtle.decrypt({name: 'rsa-oaep'}, key, base64StringToArrayBuffer(encryptedKey));
		}).then(function(decryptedKey){
			var base64Str = cbcdecrypt(encryptedData,new TextDecoder("UTF-8").decode(new Uint8Array(decryptedKey)),encryptedIv);
			return new Promise(function(resolve) {
				resolve(base64Str);
			});
		}).then(function(base64Str){
			showbase64StrPdf(base64Str);
		});
	}
	

	function showbase64StrPdf(base64Str){
		var binary = atob(base64Str.replace(/\s/g, '')); 
		var len = binary.length; 
		var buffer = new ArrayBuffer(len); 
		var view = new Uint8Array(buffer); 
		for (var i = 0; i < len; i++) { 
		    view[i] = binary.charCodeAt(i); 
		} 
		var blob = new Blob([view], { type: "application/pdf" }); 
		var blobURL = URL.createObjectURL(blob); 
		window.open(blobURL);
	}
	
	//解密
	function cbcdecrypt(e, key, iv){
	   var r = CryptoJS.enc.Utf8.parse(iv);
	   var  n = CryptoJS.enc.Utf8.parse(key);
	   var o = CryptoJS.AES.decrypt(e, n, {
	        iv: r,
	        mode: CryptoJS.mode.CBC,
	        padding: CryptoJS.pad.Pkcs7
	   });
	   return CryptoJS.enc.Utf8.stringify(o).toString();
	}
</script>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant-TW">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:if="${_csrf}"
		  th:content="${_csrf.headerName}" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<title th:text="'MyData | '+${portalServiceCategory.cateName}">MyData | 服務明細</title>
	<link rel="icon" type="image/png" sizes="16x16"
		  href="image/smydatalogo.png"
		  th:href="@{/resources/dist/image/smydatalogo.png}">
	<!-- Bootstrap -->
	<link href="css/bootstrap.css" rel="stylesheet"
		  th:href="@{/resources/dist/css/bootstrap.css}">
	<link href="css/style.css" rel="stylesheet" type="text/css"
		  th:href="@{/resources/dist/css/style.css}">
	<link rel="stylesheet"
		  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
		  th:href="@{/resources/plugins/font-awesome/css/font-awesome.min.css}">
	<script th:src="@{/resources/dist/js/font-awesone.min.js}" ></script>
	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script src="js/jquery-3.5.1.min.js"
			th:src="@{/resources/dist/js/jquery-3.5.1.min.js}"></script>
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="js/popper.min.js"
			th:src="@{/resources/dist/js/popper.min.js}"></script>
	<script src="js/bootstrap.js"
			th:src="@{/resources/dist/js/bootstrap.js}"></script>
	<script src="js/scrollreveal.js"
			th:src="@{/resources/dist/js/scrollreveal.js}"></script>
	<script src="js/moment.min.js" th:src="@{/resources/dist/js/moment.min.js}"></script>
	<script src="js/certLogin.js" th:src="@{/resources/dist/js/certLogin.js}"></script>
	<script src="js/errorcode.js" th:src="@{/resources/dist/js/errorcode.js}"></script>
	<script src="js/qrcode.js" th:src="@{/resources/dist/js/qrcode.js}"></script>
	<!-- twca js-->
	<script th:src="@{/resources/dist/js/mydata.twca.ap.js}"></script>
	<script th:src="@{/resources/dist/js/tcw.api.js}"></script>
	<script th:src="@{/resources/dist/js/twcaCryptoLib.js}"></script>
	<!-- 	<script src="https://www.google.com/recaptcha/api.js" async defer></script> -->
	<style>
		.hidden {
			display:none;
		}
		.grecaptcha-badge{
			visibility: hidden;
		}
	</style>
</head>
<body th:classappend="${session.SignedInUser!=null&&session.SignedInUser.maskMember!=null&&session.SignedInUser.maskMember.name!=null}?'after-login':''">
<!--======= header =======-->
<header th:replace="fragment/header::header"></header>
<!--======= header =======-->
<!--  1 消費金融 -->
<th:block th:if="${portalServiceCategory.cateId==1}">
	<div class="page-title padding flex-center bg-img bg-gray finance-page">
		<img class="w-100" src="./images/finance-banner.png" th:src="@{/resources/dist/image/finance-banner.png}" alt="">
		<h2 class="flex-middle absolute-center" th:text="${portalServiceCategory.cateName}">消費金融</h2>
	</div>
</th:block>
<!--  2 教育學習 -->
<th:block th:if="${portalServiceCategory.cateId==2}">
	<div class="page-title padding flex-center bg-img bg-gray education-learning-page">
		<img class="w-100" src="./images/education-banner.png" th:src="@{/resources/dist/image/education-banner.png}" alt="">
		<h2 class="flex-middle absolute-center" th:text="${portalServiceCategory.cateName}">教育學習</h2>
	</div>
</th:block>
<!--  3 醫療照護 -->
<th:block th:if="${portalServiceCategory.cateId==3}">
	<div class="page-title padding flex-center bg-img bg-gray medical-care-page">
		<img class="w-100" src="./images/medical-banner.png" th:src="@{/resources/dist/image/medical-banner.png}" alt="">
		<h2 class="flex-middle absolute-center" th:text="${portalServiceCategory.cateName}">社會福利</h2>
	</div>
</th:block>
<!--  4 商工登記 -->
<th:block th:if="${portalServiceCategory.cateId==4}">
	<div class="page-title padding flex-center bg-img bg-gray commerce-page">
		<img class="w-100" src="./images/commerce-banner.png" th:src="@{/resources/dist/image/commerce-banner.png}" alt="">
		<h2 class="flex-middle absolute-center" th:text="${portalServiceCategory.cateName}">商工登記</h2>
	</div>
</th:block>
<!--  5 綜合服務 -->
<th:block th:if="${portalServiceCategory.cateId==5}">
	<div class="page-title padding flex-center bg-img bg-gray multi-service-page">
		<img class="w-100" src="./images/commerce-banner.png" th:src="@{/resources/dist/image/multi-service-banner.png}" alt="">
		<h2 class="flex-middle absolute-center" th:text="${portalServiceCategory.cateName}">綜合服務</h2>
	</div>
</th:block>
<nav aria-label="breadcrumb">
	<ol class="breadcrumb bg-gray pb-0">
		<a href="#main_area" id="main_area" title="主要內容區塊" class="show-lg-only aa-index">:::</a>
		<li class="breadcrumb-item">
			<a href="#" th:href="@{/}" title="回到MyData首頁">
				<img src="images/breadcrumb-home.png" th:src="@{/resources/dist/image/breadcrumb-home.png}" alt="">首頁
			</a>
		</li>
		<li class="breadcrumb-item active" aria-current="page">MyData 服務明細</li>
	</ol>
</nav>
<!-- 到申請的最後步驟時，在 Class 'content-wrap' 旁新增 'last-step'  -->
<div class="content-wrap">
	<h3>
		<th:block th:text="${portalService.name}"></th:block>
		<hr>
	</h3>
	<ul class="steps-wrap">
		<th:blcok th:replace="fragment/agree-policy::agree-policy(id = ${portalService.psId})"></th:blcok>
		<p class="bg-gray p-3 mb-4 alert-box showMsgMobile" style="display: none;">
			<img src="/resources/dist/image/ps-icon.svg" th:src="@{/resources/dist/image/ps-icon.svg}"
				 alt="注意事項：" style="width: 15px; margin-right: 3px"> 此服務暫時無法使用手機下載。
		</p>
		<p class="bg-gray p-3 mb-4 alert-box showMsgMobileOS" style="display: none;" th:data-id="${portalService.psId}" th:data-level="${level}" th:data-moecaCheck="${moecaCheck}==true?1:0">
			<img src="/resources/dist/image/ps-icon.svg" th:src="@{/resources/dist/image/ps-icon.svg}"
				 alt="注意事項：" style="width: 15px; margin-right: 3px"> 你使用的載具作業系統版本不支援使用本系統，點擊連結<a th:href="@{/sp/about}" class="link" target="_blank" title="另開新頁前往關於Mydata">查看支援版本</a>。
		</p>
		<li class="step step2">
			<div class="disabled-mask"></div>
			<hr>
			<h4>基本資訊</h4>
			<!-- tab 標籤容器 -->
			<th:blcok th:replace="fragment/identity-verify::identity-info(id = ${portalService.psId}, paramobj=${portalResourceExtList}, showName='true', isSingle='false', showParamTitle=${not #lists.isEmpty(paramList)?'true':'false'},  moecaCheck = ${moecaCheck}==true?1:0, uidType = 0, usePolicy = true)"></th:blcok>
		</li>
		<li th:id="'member-privacy'+${portalService.psId}" class="step" style="display:none;">
			<div th:id="'member-privacy-mask'+${portalService.psId}" ></div>
			<hr>
			<h4>個人化資料自主運用(MyData)平臺服務條款暨隱私權保護政策</h4>
			<th:blcok th:replace="fragment/member-privacy::member-privacy(id = ${portalService.psId})"></th:blcok>
		</li>
		<li th:id="'member-verify'+${portalService.psId}" class="step" style="display:none;">
			<div th:id="'member-verify-mask'+${portalService.psId}"></div>
			<hr>
			<h4>身分驗證</h4>
			<!-- 只有可使用工商憑證下載的資料集，會出現 tab 標籤 -->
			<th:blcok th:replace="fragment/identity-verify::identity-verify(id = ${portalService.psId}, moecaCheck = (${moecaCheck}==true?1:0), level = ${level}, uidType = 0, type= ${portalService.type}, showTwca='true', isLogin='false')"></th:blcok>
			<!-- <div id="param" th:id="'param'+${portalService.psId}" class="data-detail-cell-wrap" th:if="${not #lists.isEmpty(paramList)}">
				<p class="description secondary bold text-left mb-0">請輸入您想調閱的資料明細</p>
				<th:block th:each="prTmp,iterTmp : ${portalResourceExtList}" th:if="${not #lists.isEmpty(prTmp.paramList)}">
					<th:blcok th:replace="fragment/identity-verify::param-verify(id = 999, paramList = ${prTmp.paramList}, showName = 'true')"></th:blcok>
				</th:block>
			</div> -->
			<div class="text-center">
				<button id="apply0" th:id="'apply' + ${portalService.psId}" class="btn theme-btn g-recaptcha" style="display:none;"
						th:data-src="${psredirectUrl}" th:data-id="${portalService.psId}" onclick="javascript:iWantApply();"
						th:onclick="'javascript:iWantApply(\''+${portalService.psId}+'\');'">確認</button>
			</div>
			<p class="bg-gray p-3 mb-4 alert-box" th:id="showMsgMobileOS2" style="display: none;">
				<img src="/resources/dist/image/ps-icon.svg" th:src="@{/resources/dist/image/ps-icon.svg}"
					 alt="注意事項：" style="width: 15px; margin-right: 3px"> 你使用的載具作業系統版本不支援使用本系統的 TW FidO 驗證方式，點擊連結<a th:href="@{/sp/about}" class="link" target="_blank" title="另開新頁前往關於Mydata">查看支援版本</a>。
			</p>
		</li>
		<th:blcok th:replace="fragment/identity-verify::identity-append-double-verify(id = ${portalService.psId})"></th:blcok>
		<th:blcok th:replace="fragment/fill-member::fill-member(id = ${portalService.psId})"></th:blcok>
		<th:blcok th:replace="fragment/sp-same::sp-step4"></th:blcok>

	</ul>
</div>

<!--======= modal =======-->
<th:block th:replace="fragment/sp-pop-msg::refuse-modal"></th:block>
<th:block th:replace="fragment/sp-pop-msg::pid-pop-message"></th:block>
<th:block th:replace="fragment/sp-pop-msg::check-resource-ok"></th:block>
<th:block th:replace="fragment/sp-pop-msg::deactivate"></th:block>
<!--======= end modal =======-->

<!--======= footer =======-->
<footer th:replace="fragment/footer::footer"></footer>
<a id="back-to-top" href="#" class="btn btn-primary btn-lg back-to-top"
   role="button" title="網頁置頂"
   data-toggle="tooltip" data-placement="left" style="display: inline;">
	<img class="arrow-position" src="images/top-arrow.png"
		 th:src="@{/resources/dist/image/top-arrow.png}" alt="向上置頂">
</a>
<!--======= end footer =======-->

<!--======= health-card =======-->
<span th:replace="fragment/login-health::login-health"></span>
<div th:replace="fragment/pop_msg_refresh_modal::sp_pop_msg_refresh_modal"></div>
<!--======= end health-card =======-->

<!-- fragment-script -->
<th:block th:replace="fragment/agree-policy::agree-policy-script"></th:block>
<th:block th:replace="fragment/member-privacy::member-privacy-script"></th:block>
<th:block th:replace="fragment/member-privacy::member-privacy-for-download-script"></th:block>
<th:block th:replace="fragment/identity-verify::identity-info-script"></th:block>
<th:block th:replace="fragment/identity-verify::identity-info-for-download-script"></th:block>
<th:block th:replace="fragment/identity-verify::identity-verify-script"></th:block>
<th:block th:replace="fragment/identity-verify::param-verify-script"></th:block>
<th:block th:replace="fragment/fill-member::fill-member-script"></th:block>
<th:block th:replace="fragment/fill-member::fill-member-for-download-script"></th:block>
<th:block th:replace="fragment/fill-member::email-mobile-script"></th:block>
<th:block th:replace="fragment/sp-same::sp-same-script"></th:block>
<!-- end fragment-script -->

<!--線上預覽檔案提示-->
<div id="preview-pop-message" class="modal fade show" role="dialog" aria-labelledby="refuseModalLabel" style="display: none;" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="refuseModalLabel">MyData 提醒</h5>
				<button type="button" class="close" title="關閉彈跳視窗" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div id="preview-message-text" class="modal-body">此畫面僅供您個人檢視參考，不得列印作為業務申辦佐證文件。</div>
			<div class="modal-footer">
				<button class="theme-btn false mr-3" data-dismiss="modal">取消</button>
				<button id="preview-btn" class="theme-btn" data-id="" data-src="" onclick="javascript:previewToCompanyConfirmYes(this);">確定</button>
			</div>
		</div>
	</div>
</div>
	
<script type="text/javascript" th:inline="javascript">
	var tmpServiceName = /*[[${portalService.name}]]*/'';
	var signedInUser = /*[[${session.SignedInUser}]]*/'';
	var member = /*[[${member}]]*/'';
	var pid = /*[[${pid}]]*/'';
	var checkResourceOk = /*[[${checkResourceOk}]]*/'';
	var isDeactivate = /*[[${isDeactivate}]]*/'';
	var psdId;
	var returnUrl = /*[[${returnUrl}]]*/'';
	var publicKeyBase64;
	var privatKeyBase64;
	var typing = false;
	$(function(){
		piiPrompt();

		if($('.showMsgMobile').is(':visible')) {
			$('.selectDescription').hide();
		}

		if(signedInUser != null && member != null && member.uid != pid) {
			RiAPI.run({
				type : 'GET',
				url : '/logout',
				loadSpin : true,
				complete : function() {
					window.location.reload();
				}
			});
		}

		if(checkResourceOk == false) {
			$('#checkResourceOk').modal('show');
		}

		if(isDeactivate == true) {
			$('#isDeactivate').modal('show');
		}

		showMsgMobileOS();
		if(typeof crypto.subtle!='undefined'){
			createNewUserKey().then(function(key){
				publicKeyBase64 = toPublicPem(key[0]);
				privatKeyBase64 = toPrivatePem(key[1]);
			});
		};
		
// 		var typing = false;
		$('input').each((idx, element)=>{
			$(element).on('compositionstart',function(){
			    typing = true;
			});
			$(element).on('compositionend',function(){
			    typing = false;
			});
			var oninputAttr = $(element).attr('oninput');
			if(typeof oninputAttr!='undefined'){
				if(oninputAttr.indexOf('MaskType.phone')>-1){
					$(element).on('input',function(){
					    setTimeout(function() {
					        if(!typing) {
					        	inputTypingEvent($(element), MaskType.phone);
					        }
					    },0);
					})	
				}
				if(oninputAttr.indexOf('MaskType.uid')>-1){
					$(element).on('input',function(){
					    setTimeout(function() {
					        if(!typing) {
					        	inputTypingEvent($(element), MaskType.uid);
					        }
					    },0);
					})	
				}
				if(oninputAttr.indexOf('MaskType.email')>-1){
					$(element).on('input',function(){
					    setTimeout(function() {
					        if(!typing) {
					        	inputTypingEvent($(element), MaskType.email);
					        }
					    },0);
					})	
				}
				if(oninputAttr.indexOf('MaskType.birthdate')>-1){
					$(element).on('input',function(){
					    setTimeout(function() {
					        if(!typing) {
					        	inputTypingEvent($(element), MaskType.birthdate);
					        }
					    },0);
					})	
				}
				if(oninputAttr.indexOf('MaskType.NHI')>-1){
					$(element).on('input',function(){
					    setTimeout(function() {
					        if(!typing) {
					        	inputTypingEvent($(element), MaskType.NHI);
					        }
					    },0);
					})	
				}
				if(oninputAttr.indexOf('MaskType.domicile')>-1){
					$(element).on('input',function(){
					    setTimeout(function() {
					        if(!typing) {
					        	inputTypingEvent($(element), MaskType.domicile);
					        }
					    },0);
					})	
				}
			}			
    	});
	});

	function showMsgMobileOS() {
		var $this = $('.showMsgMobileOS');
		var id = $this.attr('data-id');
		var level = $this.attr('data-level');
		var moecaCheck = $this.attr('data-moecaCheck');
		if(isMobile() && checkMobileOs() == false) {
			if(level == 3) {
				$('#t-fido' + id).hide();
				$('#showMsgMobileOS2').show();
			} else if(level == 0 || (moecaCheck==1 && level < 1)) {
				$('.showMsgMobile').show();
				$('.step2').hide();
				$('.agree-policy').parent().hide();
			} else {
				$this.show();
				$('.step2').hide();
				$('.agree-policy').parent().hide();
			}
		} else if(isMobile() && checkMobileOs() == true){
			if(level == 0 || (moecaCheck==1 && level < 1)) {
				$('.showMsgMobile').show();
				$('.step2').hide();
				$('.agree-policy').parent().hide();
			}
		}
	}

	function getScope(id) {
		var prIdListStr = '';
		$('#step4').find('div.card').each(function() {
			var prId = $(this).attr('data-id');
			if(prIdListStr==''){
				prIdListStr = prId;
			}else{
				prIdListStr = prIdListStr+','+prId
			}
		});

		return prIdListStr;
	}

	function checkYesApply(id) {
		$('.userName').empty().append(maskName(tmpMember.name));
		$('.userUid').empty().append(maskUid(tmpMember.uid));
		if(typeof tmpMember.informMethod !='undefined'&& tmpMember.informMethod != null){
			if(tmpMember.informMethod=='email'){
				$('#step3InformWarming').empty().append('系統將自動發通知信至您的電子信箱 '+ maskEmailAddress(tmpMember.email) +'。如電子信箱有誤，或想變更電子信箱');
			}else if(tmpMember.informMethod=='mobile'){
				$('#step3InformWarming').empty().append('系統將自動發通知簡訊至您的手機號碼 '+ maskPhoneNumber(tmpMember.mobile) +'。如手機號碼有誤，或想變更手機號碼');
			}
		}

		setTimeout(function() {
			ckeckedApplyDirect('MyData');
		},500);
	}
	
	function previewToCompany(obj){
		var httpcode = $(obj).attr('httpcode');
		var downloadsn = $(obj).attr('downloadsn');
		var prId = $(obj).attr('data-id');
		var url = $(obj).attr('data-src');
		if(httpcode=='200'){
            $('#preview-btn').attr('data-src',url);
            $('#preview-btn').attr('data-id',prId);
            $('#preview-btn').attr('httpcode',httpcode);
            $('#preview-btn').attr('downloadsn',downloadsn);
            $('#preview-message-text').text('此畫面僅供您個人檢視參考，不得列印作為業務申辦佐證文件。');
            $('#preview-pop-message').modal('show');
// 			window.open(url);
		}else if(httpcode=='204'){
			$('#message-text').text('點擊確認後，本平臺將立即刪除此資料檔案。');
			$('#pop-message').modal('show');
			//append change portal_resource_download stat=1 RiAPI
			RiAPI.run({
				type : 'GET',
				url : '/rest/personal/download/changestatonebyspdetail/'+prId,
				loadSpin : false,
				success : function(resp) {
					if (resp.code < 0) {
						if(resp.code == -5) {
							showSPTimeoutMessage(resp);
							return;
						}
						$('#message-text').text(resp.text);
						$('#pop-message').modal('show');
					} else {
						//成功
						//console.log('------apply success------:'+prId);
						$('#accordion'+prId).attr('download-status','2');
					}
				}
			});
		}else{
			//console.log('httpcode '+httpcode+' 申請失敗！');
			//$('#message-text').text('httpcode '+httpcode+' 申請失敗！');
			$('#message-text').text('資料申請失敗，請重新操作。');
			$('#pop-message').modal('show');
			//append change portal_resource_download stat=1 RiAPI
			RiAPI.run({
				type : 'GET',
				url : '/rest/personal/download/changestatonebyspdetail/'+prId,
				loadSpin : false,
				success : function(resp) {
					if (resp.code < 0) {
						if(resp.code == -5) {
							showSPTimeoutMessage(resp);
							return;
						}

						$('#message-text').text(resp.text);
						$('#pop-message').modal('show');
					} else {
						//成功
						//console.log('------apply success------:'+prId);
						$('#accordion'+prId).attr('download-status','2');
					}
				}
			});
		}
	}

//     function previewToCompanyConfirmYes(obj){
// 		var httpcode = $(obj).attr('httpcode');
// 		var downloadsn = $(obj).attr('downloadsn');
// 		var prId = $(obj).attr('data-id');
// 		var url = $(obj).attr('data-src');
// 		if(typeof downloadsn!='undefined'&&downloadsn!=null&&downloadsn!=''){
// 			url = url + "/" + downloadsn;
// 		}
// 		window.open(url);
// 		$('#preview-pop-message').modal('hide');
// 	}
    
	function checkDp(id) {
		return false;
	}

	function showDownloadBlock() {
		$('#step4').addClass('step4');
	}

	function maskInfo(id) {
		$('div.content-wrap').addClass('last-step');
	}
	
	$('div.content-wrap, label').keydown(function(e) {
		if (e.keyCode == 13) {
			$(this).trigger('click');
		}
	});	
	
    function previewToCompanyConfirmYes(obj){
		var prId = $(obj).attr('data-id');
		var downloadSn = $(obj).attr('downloadSn');
		var p = {
			key:publicKeyBase64
		};
        RiAPI.run({
            type : 'POST',
            url : '/rest/personal/sppreview/'+prId+'/'+downloadSn,
            data: p,
            loadSpin : true,
            success : function(resp) {
                if (resp.code < 0) {
                    if(resp.code == -5) {
                        showTimeoutMessage(resp);
                        return;
                    }
                    $('#message-text').text(resp.text);
                    $('#pop-message').modal('show');
                } else {
                	if(typeof resp.data.data!='undefined' &&resp.data.data.length>0){
                		preViewDataDecodeAndShow(resp.data);
                	}
                }
            },
            error : function() {
                $('#message-text').text('線上預覽檔案失敗。');
                $('#pop-message').modal('show');
            }
        
        });
		$('#preview-pop-message').modal('hide');
    }
    
	var algorithmKeyGen = {
		name: "RSA-OAEP",
		hash: {name: "sha-256"},
		modulusLength: 2048,
		publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
	};
	
	function createNewUserKey(){
		return crypto.subtle.generateKey(algorithmKeyGen, true, ['encrypt', 'decrypt']).then(function(key) {
			return Promise.all([crypto.subtle.exportKey("spki", key.publicKey),
			crypto.subtle.exportKey("pkcs8", key.privateKey)]);
		});  
	}
		        
    function arrayBufferToBase64(arrayBuffer) {
        var byteArray = new Uint8Array(arrayBuffer);
        var byteString = '';
        for(var i=0; i < byteArray.byteLength; i++) {
            byteString += String.fromCharCode(byteArray[i]);
        }
        var b64 = window.btoa(byteString);

        return b64;
    }

    function addNewLines(str) {
        var finalString = '';
        while(str.length > 0) {
            finalString += str.substring(0, 64) + '\n';
            str = str.substring(64);
        }

        return finalString;
    }
    
    function toPrivatePem(privateKey) {
        var b64 = addNewLines(arrayBufferToBase64(privateKey));
        var pem = "-----BEGIN PRIVATE KEY-----\n" + b64 + "-----END PRIVATE KEY-----";
        
        return pem;
    }
    
    function toPublicPem(publicKey) {
        //var b64 = addNewLines(arrayBufferToBase64(publicKey));
        var b64 = arrayBufferToBase64(publicKey);
        var pem = "-----BEGIN PUBLIC KEY-----\n" + b64 + "-----END PUBLIC KEY-----";
        
        return b64;
    }
    
    function convertPemToBinary(pem) {
        var lines = pem.split('\n')
        var encoded = ''
        for(var i = 0;i < lines.length;i++){
          if (lines[i].trim().length > 0 &&
              lines[i].indexOf('-BEGIN RSA PRIVATE KEY-') < 0 &&
              lines[i].indexOf('-BEGIN PRIVATE KEY-') < 0 &&
              lines[i].indexOf('-BEGIN RSA PUBLIC KEY-') < 0 &&
              lines[i].indexOf('-BEGIN PUBLIC KEY-') < 0 &&
              lines[i].indexOf('-END RSA PRIVATE KEY-') < 0 &&
              lines[i].indexOf('-END PRIVATE KEY-') < 0 &&
              lines[i].indexOf('-END PUBLIC KEY-') < 0 &&
              lines[i].indexOf('-END RSA PUBLIC KEY-') < 0) {
            encoded += lines[i].trim()
          }
        }
        return base64StringToArrayBuffer(encoded)
    }
    
    function base64StringToArrayBuffer(b64str) {
        var byteStr = atob(b64str)
        var bytes = new Uint8Array(byteStr.length)
        for (var i = 0; i < byteStr.length; i++) {
          bytes[i] = byteStr.charCodeAt(i)
        }
        return bytes.buffer
	}
	
    function importPrivateKey(pemKey) {
        return new Promise(function(resolve) {
          var importer = crypto.subtle.importKey("pkcs8", convertPemToBinary(pemKey), algorithmKeyGen, true, ['decrypt'])
          importer.then(function(key) {
            resolve(key)
          })
        })
    }
       
	function preViewDataDecodeAndShow(data){
		var encryptedKey = data.key;
		var encryptedData = data.data;
		var encryptedIv = data.iv;
		importPrivateKey(privatKeyBase64).then(function(key){
			//importkey 解密
			return crypto.subtle.decrypt({name: 'rsa-oaep'}, key, base64StringToArrayBuffer(encryptedKey));
		}).then(function(decryptedKey){
			var base64Str = cbcdecrypt(encryptedData,new TextDecoder("UTF-8").decode(new Uint8Array(decryptedKey)),encryptedIv);
			return new Promise(function(resolve) {
				resolve(base64Str);
			});
		}).then(function(base64Str){
			showbase64StrPdf(base64Str);
		});
	}
	

	function showbase64StrPdf(base64Str){
		var binary = atob(base64Str.replace(/\s/g, '')); 
		var len = binary.length; 
		var buffer = new ArrayBuffer(len); 
		var view = new Uint8Array(buffer); 
		for (var i = 0; i < len; i++) { 
		    view[i] = binary.charCodeAt(i); 
		} 
		var blob = new Blob([view], { type: "application/pdf" }); 
		var blobURL = URL.createObjectURL(blob); 
		window.open(blobURL);
	}
	
	//解密
	function cbcdecrypt(e, key, iv){
	   var r = CryptoJS.enc.Utf8.parse(iv);
	   var  n = CryptoJS.enc.Utf8.parse(key);
	   var o = CryptoJS.AES.decrypt(e, n, {
	        iv: r,
	        mode: CryptoJS.mode.CBC,
	        padding: CryptoJS.pad.Pkcs7
	   });
	   return CryptoJS.enc.Utf8.stringify(o).toString();
	}
</script>
</body>
</html>
